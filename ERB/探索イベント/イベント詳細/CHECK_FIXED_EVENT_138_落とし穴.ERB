;固定イベント
;RETURN	0:失敗した　1:成功した　2:以後のイベントスキップ
@CHECK_FIXED_EVENT_138
;LOCAL
;0	LOOP
;1	目標値
;2	達成値
;3	戻り値
;4	被害者あり
;5	TEMP
;6	TEMP

LOCAL:3 = 0

;目標値（イベント難易度）決定
LOCAL:1 = 0


;達成値決定
CALL GET_SEARCH_RATE
LOCAL:2 = RESULT


IF LOCAL:2 >= LOCAL:1
	CALL ADD_ABL_EXP_PT(0, 300)
	PRINTFORML 迷宮内を探索していると、突然地面に穴が開いた！
	CALL WAIT_AUTOMODE(400, 0)
	PRINTFORML 
	LOCAL:4 = 0
	CALL REACTION_TRAP(1)
	IF 50 > RAND:(100 + ABL:1:5 * 50) && RESULT == 1
		CALL ADD_ABL_EXP(5, 1, 1000 + RAND:(ABL:1:5 * 500 + 1))
		CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:1, "", 1)
		LOCAL:5 = 5 + RAND:4 + RAND:4
		FOR LOCAL:0, 0, LOCAL:5
			LOCAL:6 = RAND:4
			IF LOCAL:6 == 3
				CALL LOST_VIRGIN(1, 1, 4)
			ENDIF
			CALL EXTASY(1, LOCAL:6, RAND:50, 150)
		NEXT
		IF CFLAG:1:22 == 0 && RAND:4 < 2 && TALENT:1:0 == 0
			CALL RANDOM_PARASITE(1, 0, 0)
			IF RESULT
				CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:1, "", 3)
			ENDIF
		ELSEIF CFLAG:1:22 == 0 && RAND:2 == 0 && TALENT:1:0 == 0
			CALL RANDOM_PARASITE(1, 1, 0)
		ENDIF
		LOCAL:4 = 1
		CALL WAIT_AUTOMODE(400, 0)
	ELSE
		CALL ADD_ABL_EXP(5, 1, 500 + RAND:(ABL:1:5 * 200 + 1))
		CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:1, "", 2)
	ENDIF
	IF FLAG:10
		CALL REACTION_TRAP(FLAG:10)
		IF 50 > RAND:(100 + ABL:(FLAG:10):5 * 50) && RESULT == 1
			CALL ADD_ABL_EXP(5, FLAG:10, 1000 + RAND:(ABL:(FLAG:10):5 * 500 + 1))
			CALL PRINT_MESSAGE(FLAG:10, 200, 138, CALLNAME:1, "", 1)
			LOCAL:5 = 5 + RAND:4 + RAND:4
			FOR LOCAL:0, 0, LOCAL:5
				LOCAL:6 = RAND:4
				IF LOCAL:6 == 3
					CALL LOST_VIRGIN(FLAG:10, 1, 4)
				ENDIF
				CALL EXTASY(FLAG:10, LOCAL:6, RAND:50, 150)
			NEXT
			IF CFLAG:(FLAG:10):22 == 0 && RAND:4 < 2 && TALENT:(FLAG:10):0 == 0
				CALL RANDOM_PARASITE(FLAG:10, 0, 0)
				IF RESULT
					CALL PRINT_MESSAGE(FLAG:10, 200, 138, CALLNAME:1, "", 3)
				ENDIF
			ELSEIF CFLAG:(FLAG:10):22 == 0 && RAND:2 == 0 && TALENT:(FLAG:10):0 == 0
				CALL RANDOM_PARASITE(FLAG:10, 1, 0)
			ENDIF
			LOCAL:4 += 2
			CALL WAIT_AUTOMODE(400, 0)
		ELSE
			CALL ADD_ABL_EXP(5, FLAG:10, 500 + RAND:(ABL:(FLAG:10):5 * 200 + 1))
			CALL PRINT_MESSAGE(FLAG:10, 200, 138, CALLNAME:1, "", 2)
		ENDIF
	ENDIF
	IF FLAG:11
		CALL REACTION_TRAP(FLAG:11)
		IF 50 > RAND:(100 + ABL:(FLAG:11):5 * 50) && RESULT == 1
			CALL ADD_ABL_EXP(5, FLAG:11, 1000 + RAND:(ABL:(FLAG:11):5 * 500 + 1))
			CALL PRINT_MESSAGE(FLAG:11, 200, 138, CALLNAME:1, "", 1)
			LOCAL:5 = 5 + RAND:4 + RAND:4
			FOR LOCAL:0, 0, LOCAL:5
				LOCAL:6 = RAND:4
				IF LOCAL:6 == 3
					CALL LOST_VIRGIN(FLAG:11, 1, 4)
				ENDIF
				CALL EXTASY(FLAG:11, LOCAL:6, RAND:50, 150)
			NEXT
			IF CFLAG:(FLAG:11):22 == 0 && RAND:4 < 2 && TALENT:(FLAG:11):0 == 0
				CALL RANDOM_PARASITE(FLAG:11, 0, 0)
				IF RESULT
					CALL PRINT_MESSAGE(FLAG:11, 200, 138, CALLNAME:1, "", 3)
				ENDIF
			ELSEIF CFLAG:(FLAG:11):22 == 0 && RAND:2 == 0 && TALENT:(FLAG:11):0 == 0
				CALL RANDOM_PARASITE(FLAG:11, 1, 0)
			ENDIF
			LOCAL:4 += 4
			CALL WAIT_AUTOMODE(400, 0)
		ELSE
			CALL ADD_ABL_EXP(5, FLAG:11, 500 + RAND:(ABL:(FLAG:11):5 * 200 + 1))
			CALL PRINT_MESSAGE(FLAG:11, 200, 138, CALLNAME:1, "", 2)
		ENDIF
	ENDIF
	
	IF LOCAL:4 && (CFLAG:1:29 || CFLAG:(FLAG:10):29 || CFLAG:(FLAG:11):29)
		CALL ABDUCTION_HALL(LOCAL:4)
	ELSEIF LOCAL:4
		PRINTFORML 
		PRINTFORML 触手の体液でベトベトに濡れながらも、何とか%CALLNAME:1%%TACHI()%は落とし穴から這い上がった…
	ELSE
		PRINTFORML 
		PRINTFORML 落とし穴の中には無数の触手が見える…
		PRINTFORML 幸運にもその脅威を回避することができた%CALLNAME:1%%TACHI()%は、急いでその場から離れた…
	ENDIF
	
	CALL WAIT_AUTOMODE(400, 0)
	
	;別の場所に再配置
	FLAG:138 = RAND:30 + 1
	LOCAL:3 = 1
ELSE
	;見つからなかった場合（通常は何もしない）
ENDIF

RETURN LOCAL:3

;仲間の誘拐判定
@ABDUCTION_HALL(ARG:0)
;LOCAL
;0	ループ
;1	誘拐判定


IF ARG:0 & 2 && CFLAG:(FLAG:10):29
	PRINTFORML 
	PRINTFORML 落とし穴の底でもがく%CALLNAME:(FLAG:10)%を呑み込むように落とし穴は閉じてしまった！
	CALL RANDOM_PARASITE((FLAG:10), 1, 0)
	CALL RANDOM_TELEPORT(FLAG:10)
ENDIF


IF ARG:0 & 4 && CFLAG:(FLAG:11):29
	PRINTFORML 
	PRINTFORML 落とし穴の奥でなすがままの%CALLNAME:(FLAG:11)%を捕らえたまま落とし穴は閉じてしまった！
	CALL RANDOM_PARASITE((FLAG:11), 1, 0)
	CALL RANDOM_TELEPORT(FLAG:11)
ENDIF

;自分が拉致られる
IF ARG:0 & 1 && CFLAG:1:29
	PRINTFORML 
	PRINTFORML 落とし穴から這い出すだけの力が残っていない%CALLNAME:1%を残したまま落とし穴は閉じてしまった！
	PRINTFORML ………
	PRINTFORML ……
	PRINTFORML …
	PRINTFORML %CALLNAME:1%が気がつくと粘液でベタベタな状態で先ほどと違う部屋へと打ち捨てられていた…
	CALL RANDOM_PARASITE(1, 1, 0)
	CALL RANDOM_TELEPORT(1)
	;テレポートトラップ処理を流用、移動後の位置を現在地に指定し移動先の部屋の侵入経験フラグを立てる
	FLAG:5 = CFLAG:1:4
	FLAG:(600 + FLAG:5) = 1
	;拉致られてPTがそのままなのも変なので、MEMBER_EXIT関数も
	;罠としてのテレポート処理では直前に仲間も飛ばされてるので不要だけど
	;RANDOM_TELEPORT自体には対象以外をPTから外す処理はないので、これがないと転移先まで付いてくる
	;（MEMBER_EXITのほうで対象が空の場合の処理も入ってるのでSIFは省略）
	CALL MEMBER_EXIT(1)
	CALL MEMBER_EXIT(0)
ENDIF


RETURN

