;物陰への連れ込み
;条件を満たしたキャラからランダム
@BUSHED_HENTAI
#DIM LCOUNT	;ループ用
#DIM LOCALQUETE,10000
#DIM LOCALIDNUM
#DIM LOCALIDNUM_COUNT
#DIM INVITE_CHARA_ID


VARSET LOCALQUETE
VARSET LOCALIDNUM
VARSET LOCALIDNUM_COUNT


;物陰に誘うキャラIDをLOCALQUETE:LOCALIDNUMに入れていく

;ペットが居る場合0番扱いで数える
IF PET:0
	LOCALQUETE:LOCALIDNUM = 0
	LOCALIDNUM += 1
ENDIF
LOCALIDNUM_COUNT += 1

;NPC
FOR LCOUNT, 2, CHARANUM
	;同じ部屋にいないキャラは除く
	IF CFLAG:LCOUNT:4 != FLAG:5
		CONTINUE
	ENDIF
	
	;発情か、ふたなりか、母乳体質か、レズ中毒か、娘か、エネミー
	IF CFLAG:LCOUNT:28 || GET_PENIS(LCOUNT) || TALENT:LCOUNT:130 || ABL:LCOUNT:13 || CFLAG:LCOUNT:104 || TALENT:LCOUNT:157
		
	ELSE
		CONTINUE
	ENDIF
	
	;自発的に動ける状態でないなら除く
	IF CHECK_FINE(LCOUNT) == 0 || CFLAG:(LCOUNT):504 == 1 || CFLAG:(LCOUNT):58 || CFLAG:(LCOUNT):59
		CONTINUE
	ENDIF
	
	LOCALQUETE:LOCALIDNUM = LCOUNT
	LOCALIDNUM += 1
NEXT

;候補がいないならここまで
IF LOCALIDNUM == 0
	RETURN
ENDIF

;候補から一人が誘ってくる
INVITE_CHARA_ID = LOCALQUETE:(RAND:LOCALIDNUM)


;プレイを決定する

;ペットならレイプ
IF INVITE_CHARA_ID == 0
	PRINTFORML %PETNAME%は%CALLNAME:1%を物陰で押し倒した……
	CALL PRINT_MESSAGE(1, 475, 0, CALLNAME:1,PETNAME)
	CALL PET_RAPE(1)
;NPCなら候補からランダム
ELSE
	CALL PRINT_MESSAGE(INVITE_CHARA_ID, 475, 0, CALLNAME:(INVITE_CHARA_ID),CALLNAME:1)
	CALL PRINT_MESSAGE(1, 475, 1, CALLNAME:1,CALLNAME:(INVITE_CHARA_ID))
	CALL RANDOM_SEX_DRIVE(INVITE_CHARA_ID)
ENDIF




;同じ部屋に誰かいると気づかれチェック

CALL PEEPING_TOM(INVITE_CHARA_ID)




;プレイの候補から一つ選ぶ
@RANDOM_SEX_DRIVE(CHARA_ID)

#DIM LCOUNT	;ループ用
#DIM LOCALQUETE,10000
#DIM LOCALIDNUM
#DIM LOCALIDNUM_COUNT
#DIM SEX_DRIVE_ID
#DIM CHARA_ID


VARSET LOCALQUETE
VARSET LOCALIDNUM
VARSET LOCALIDNUM_COUNT

;ふたなりだと射精系
IF GET_PENIS(CHARA_ID)
	LOCALQUETE:LOCALIDNUM = 0
	LOCALIDNUM += 1
ENDIF
;発情か、レズ中毒か、娘か、エネミーだと百合
IF CFLAG:CHARA_ID:28 || ABL:CHARA_ID:13 || CFLAG:CHARA_ID:104 || TALENT:CHARA_ID:157
	LOCALQUETE:LOCALIDNUM = 20
	LOCALIDNUM += 1
ENDIF
;母乳体質だと乳搾り
IF TALENT:CHARA_ID:130
	LOCALQUETE:LOCALIDNUM = 40
	LOCALIDNUM += 1
ENDIF

SEX_DRIVE_ID = LOCALQUETE:(RAND:LOCALIDNUM)



CALLFORM SEX_DRIVE_{SEX_DRIVE_ID}(CHARA_ID)



@SEX_DRIVE_0(CHARA_ID)
#DIM CHARA_ID


	CALL PRINT_MESSAGE(CHARA_ID, 475, 2, CALLNAME:(CHARA_ID),CALLNAME:1)
	CALL PRINT_MESSAGE(1, 475, 3, CALLNAME:1,CALLNAME:(CHARA_ID), CHARA_ID)

	IF TALENT:1:122
		TFLAG:63 = 0
	ELSE
		TFLAG:63 = 3
	ENDIF
	LOCAL:5 = CALC_SENSITIVITY(1, TFLAG:63, 2500 + RAND:2001)
	LOCAL:5 = LOCAL:5 * (4 + 2 * (TALENT:(CHARA_ID):170 + TALENT:(CHARA_ID):171) + TALENT:(CHARA_ID):185) / 4
	SIF LOCAL:5 > 20000
		LOCAL:5 = 20000 + RAND:((LOCAL:5 - 19970) / 30)
	CALL DAMAGE_COMMON(1, 2, LOCAL:5, 100)
	LOCAL:1 = ABL:1:14 + 2
	FOR  LOCAL:0,0,LOCAL:1
		TFLAG:63 = 2
		CALL DAMAGE_COMMON(CHARA_ID, 2, RAND:(LOCAL:1 * 1000), 100)
		CALL LOST_VIRGIN(1, 0, 3, CHARA_ID)
	NEXT
	
	CALL ADD_ABL_EXP(9, 1, RAND:(LOCAL:1 * 1000))
	CALL ADD_ABL_EXP(13, 1, LOCAL:1 * 2)
	CALL ADD_ABL_EXP(13, CHARA_ID, LOCAL:1 * 2)
	CALL ADD_ABL_EXP(14, 1, LOCAL:1 * (2 + TALENT:(CHARA_ID):185))
	CFLAG:(CHARA_ID):5 += 10

	IF CFLAG:1:22 == 0 && RAND:4 == 0 && (TALENT:1:122 == 0 || FLAG:オトコで妊娠しない == 0)
		;生まれるのはシェイプシフター
		CALL PARASITE_TYPE(1, 1, 17, 8 + LIMIT(RAND:4 + RAND:4 + RAND:4 + RAND:4, 1, 10), 2, 1)
	ENDIF


@SEX_DRIVE_20(CHARA_ID)
#DIM CHARA_ID

CALL NPC_KISS(CHARA_ID)


@SEX_DRIVE_40(CHARA_ID)
#DIM CHARA_ID

TFLAG:63 = 1
CALL PRINT_MESSAGE(CHARA_ID, 144, 7, CALLNAME:1, CALLNAME:(CHARA_ID))
CALL DRINK_MILK_RECOVERY(CHARA_ID, 1)
FOR LOCAL:0,0,(RAND:3 +2)
	CALL DAMAGE_COMMON(CHARA_ID, 2, 1000, 100)
NEXT
CALL PRINT_MESSAGE(CHARA_ID, 144, 12, CALLNAME:1, CALLNAME:(CHARA_ID))
;成功なら好感度は上がる。百合ですね　催眠でもこっち
CFLAG:(CHARA_ID):5 += RAND:30

;膨乳は収まる
SIF CFLAG:(CHARA_ID):506 > 10
	CFLAG:(CHARA_ID):506 -= RAND:10

CALL ADD_ABL_EXP_PT(2, 700)
CALL ADD_ABL_EXP_PT(13, 3 + RAND:5)



;行為が見つかるか判定
@PEEPING_TOM(INVITE_CHARA_ID)
#DIM LCOUNT	;ループ用
#DIM LOCALQUETE,10000
#DIM LOCALIDNUM
#DIM LOCALIDNUM_COUNT
#DIM INVITE_CHARA_ID
#DIM PEEPING_CHARA_ID


VARSET LOCALQUETE
VARSET LOCALIDNUM
VARSET LOCALIDNUM_COUNT


;同じ部屋にいるキャラIDをLOCALQUETE:LOCALIDNUMに入れていく

;NPC
FOR LCOUNT, 2, CHARANUM
	;同じ部屋にいないキャラは除く
	IF CFLAG:LCOUNT:4 != FLAG:5
		CONTINUE
	ENDIF
	
	;主人公とねちょっているキャラは除く
	IF INVITE_CHARA_ID == LCOUNT
		CONTINUE
	ENDIF
	
	;自発的に動ける状態でないなら除く
	IF CHECK_FINE(LCOUNT) == 0 || CFLAG:(LCOUNT):504 == 1 || CFLAG:(LCOUNT):58 || CFLAG:(LCOUNT):59
		CONTINUE
	ENDIF
	
	LOCALQUETE:LOCALIDNUM = LCOUNT
	LOCALIDNUM += 1
NEXT

;候補がいないならここまで
IF LOCALIDNUM == 0
	RETURN
ENDIF

;候補から一人が行為を見つける可能性あり
PEEPING_CHARA_ID = LOCALQUETE:(RAND:LOCALIDNUM)

;ねちょっている二人の危機回避の平均が覗き側の気配察知より高ければ隠蔽成功
IF (ABL:1:5 + ABL:INVITE_CHARA_ID:5) / 2 > ABL:PEEPING_CHARA_ID:1
	CALL PRINT_MESSAGE(1, 475, 10, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
ELSE
	;隠蔽失敗
	;娘か、エネミーなら混ざってくる
	IF CFLAG:PEEPING_CHARA_ID:104 || TALENT:PEEPING_CHARA_ID:157
		CALL PRINT_MESSAGE(PEEPING_CHARA_ID, 475, 20, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
		CALL PRINT_MESSAGE(1, 475, 21, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
		
		IF TALENT:1:122
			TFLAG:63 = 0
		ELSE
			TFLAG:63 = 3
		ENDIF
		LOCAL:5 = CALC_SENSITIVITY(1, TFLAG:63, 2500 + RAND:2001)
		LOCAL:5 = LOCAL:5 * (4 + 2 * (TALENT:(PEEPING_CHARA_ID):170 + TALENT:(PEEPING_CHARA_ID):171) + TALENT:(PEEPING_CHARA_ID):185) / 4
		SIF LOCAL:5 > 20000
			LOCAL:5 = 20000 + RAND:((LOCAL:5 - 19970) / 30)
		CALL DAMAGE_COMMON(1, 2, LOCAL:5, 100)
		LOCAL:1 = ABL:1:14 + 2
		FOR  LOCAL:0,0,LOCAL:1
			TFLAG:63 = 2
			CALL DAMAGE_COMMON(PEEPING_CHARA_ID, 2, RAND:(LOCAL:1 * 1000), 100)
			CALL LOST_VIRGIN(1, 0, 3, PEEPING_CHARA_ID)
		NEXT
		
		CALL ADD_ABL_EXP(9, 1, RAND:(LOCAL:1 * 1000))
		CALL ADD_ABL_EXP(13, 1, LOCAL:1 * 2)
		CALL ADD_ABL_EXP(13, PEEPING_CHARA_ID, LOCAL:1 * 2)
		CALL ADD_ABL_EXP(14, 1, LOCAL:1 * (2 + TALENT:(PEEPING_CHARA_ID):185))
		CFLAG:(PEEPING_CHARA_ID):5 += 10

		IF CFLAG:1:22 == 0 && RAND:4 == 0 && (TALENT:1:122 == 0 || FLAG:オトコで妊娠しない == 0)
			;生まれるのはシェイプシフター
			CALL PARASITE_TYPE(1, 1, 17, 8 + LIMIT(RAND:4 + RAND:4 + RAND:4 + RAND:4, 1, 10), 2, 1)
		ENDIF
		
	;好感度が高いか発情した生えてるのは混ざる
	ELSEIF GET_PENIS(PEEPING_CHARA_ID) && (CFLAG:PEEPING_CHARA_ID:28 || CFLAG:PEEPING_CHARA_ID:5 >= 120)
		CALL PRINT_MESSAGE(PEEPING_CHARA_ID, 475, 20, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
		CALL PRINT_MESSAGE(1, 475, 21, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
		
		IF TALENT:1:122
			TFLAG:63 = 0
		ELSE
			TFLAG:63 = 3
		ENDIF
		LOCAL:5 = CALC_SENSITIVITY(1, TFLAG:63, 2500 + RAND:2001)
		LOCAL:5 = LOCAL:5 * (4 + 2 * (TALENT:(PEEPING_CHARA_ID):170 + TALENT:(PEEPING_CHARA_ID):171) + TALENT:(PEEPING_CHARA_ID):185) / 4
		SIF LOCAL:5 > 20000
			LOCAL:5 = 20000 + RAND:((LOCAL:5 - 19970) / 30)
		CALL DAMAGE_COMMON(1, 2, LOCAL:5, 100)
		LOCAL:1 = ABL:1:14 + 2
		FOR  LOCAL:0,0,LOCAL:1
			TFLAG:63 = 2
			CALL DAMAGE_COMMON(PEEPING_CHARA_ID, 2, RAND:(LOCAL:1 * 1000), 100)
			CALL LOST_VIRGIN(1, 0, 3, PEEPING_CHARA_ID)
		NEXT
		
		CALL ADD_ABL_EXP(9, 1, RAND:(LOCAL:1 * 1000))
		CALL ADD_ABL_EXP(13, 1, LOCAL:1 * 2)
		CALL ADD_ABL_EXP(13, PEEPING_CHARA_ID, LOCAL:1 * 2)
		CALL ADD_ABL_EXP(14, 1, LOCAL:1 * (2 + TALENT:(PEEPING_CHARA_ID):185))
		CFLAG:(PEEPING_CHARA_ID):5 += 10

		IF CFLAG:1:22 == 0 && RAND:4 == 0 && (TALENT:1:122 == 0 || FLAG:オトコで妊娠しない == 0)
			;生まれるのはシェイプシフター
			CALL PARASITE_TYPE(1, 1, 17, 8 + LIMIT(RAND:4 + RAND:4 + RAND:4 + RAND:4, 1, 10), 2, 1)
		ENDIF
	;生えてるかレズ中毒が高いと見ながらオナる
	ELSEIF GET_PENIS(PEEPING_CHARA_ID) || ABL:PEEPING_CHARA_ID:13
		CALL PRINT_MESSAGE(PEEPING_CHARA_ID, 475, 30, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
		
		TFLAG:63 = RAND:4
		LOCAL:1 = ABL:PEEPING_CHARA_ID:10 + ABL:PEEPING_CHARA_ID:13 + 2
		CALL DAMAGE_COMMON(PEEPING_CHARA_ID, 2, RAND:(LOCAL:1 * 1000) + 2000, 100)
		
		CALL ADD_ABL_EXP(10, PEEPING_CHARA_ID, LOCAL:1 * 2)
		CFLAG:(PEEPING_CHARA_ID):5 += 10
	;それ以外だとこっそり覗くだけ
	ELSE
		CALL PRINT_MESSAGE(PEEPING_CHARA_ID, 475, 50, CALLNAME:1,CALLNAME:PEEPING_CHARA_ID)
	ENDIF
ENDIF






