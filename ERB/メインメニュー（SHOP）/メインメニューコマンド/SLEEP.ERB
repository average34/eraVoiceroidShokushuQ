;=================================================
;睡眠イベント
;RESULT 処理結果(-1:キャンセル 1:ターンを進める)
;=================================================
@SLEEP
;LOCAL
;0	LOOP
;1	別キャラフラグ
;2	PTメンバーが居るフラグ
;3	対象キャラがドッペルゲンガー
;4	使い魔装備中

LOCAL:1 = 0
LOCAL:2 = 0
LOCAL:3 = 0
LOCAL:4 = 0


;同じ部屋に敵が居る場合、眠れない
IF FLAG:5 != FLAG:98
	FOR LOCAL:0, 1, FLAG:1
		;現在位置が被っているかチェック
		IF FLAG:5 == DA:(LOCAL:0):4 && (DA:(LOCAL:0):0 != 18 || DA:(LOCAL:0):45 == 1 )
			;ウォッチャーは何もなし
			IF DA:(LOCAL:0):0 == 97
				
			ELSE
				PRINTFORMW 同じ部屋に敵が居る状態では眠れない！
				RETURN -1
			ENDIF
		ENDIF
	NEXT
ENDIF


;同じ部屋に他の味方が居るかチェック
FOR LOCAL:0, 1, FLAG:1
	;現在位置が被っているかチェック
	IF CFLAG:1:4 == DA:(LOCAL:0):4 && DA:(LOCAL:0):1 > 0 && DA:(LOCAL:0):0 == 18 && DA:(LOCAL:0):45 == 0
		;味方ドッペルが最優先
		LOCAL:3 = 1
		LOCAL:1 = GET_DOPPEL_BASE(LOCAL:0)
	ENDIF
NEXT
IF LOCAL:1 == 0
	FOR LOCAL:0, 1, CHARANUM
		;主人公およびPTメンバーはスキップ
		SIF LOCAL:0 == 1 || LOCAL:0 == FLAG:10 || LOCAL:0 == FLAG:11
			CONTINUE
		
		;現在位置が被っているかチェック
		IF FLAG:5 == CFLAG:(LOCAL:0):4 && CFLAG:(LOCAL:0):10 == 0 && CFLAG:(LOCAL:0):29 == 0 && CFLAG:(LOCAL:0):2 == 0 && CFLAG:(LOCAL:0):3 == 0
			LOCAL:1 = LOCAL:0
			BREAK
		ENDIF
	NEXT
ENDIF


;PT内に見張り要員が居るかチェック
SIF CFLAG:1:29 == 0
	LOCAL:2 += 1
SIF FLAG:10 && CFLAG:(FLAG:10):29 == 0
	LOCAL:2 += 1
SIF FLAG:11 && CFLAG:(FLAG:11):29 == 0
	LOCAL:2 += 1
;使い魔装備中かチェック
IF CFLAG:1:7 == 22 || CFLAG:1:8 == 22 || CFLAG:1:9 == 22
	LOCAL:4 = 1
ELSEIF FLAG:10 && (CFLAG:(FLAG:10):7 == 22 || CFLAG:(FLAG:10):8 == 22 || CFLAG:(FLAG:10):9 == 22)
	LOCAL:4 = FLAG:10
ELSEIF FLAG:11 && (CFLAG:(FLAG:11):7 == 22 || CFLAG:(FLAG:11):8 == 22 || CFLAG:(FLAG:11):9 == 22)
	LOCAL:4 = FLAG:11
ENDIF


PRINTFORML １フェイズ分眠ることにより、眠気の解消・HPなどの回復を行います
IF FLAG:5 == FLAG:98
	;結界部屋で寝る場合、とても安全
	PRINTFORML 結界を張っているため安全に眠ることが可能です。本当にこの部屋で眠りますか？
	CALL ASK_YN
	IF RESULT == 0
		;眠気を更に-1
		FLAG:7 -= 1
		CFLAG:1:11 = 4
		CFLAG:1:13 = FLAG:5
		CFLAG:1:14 = FLAG:5
		FLAG:8 = 1
		CALL PRINT_MESSAGE(-1, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(1, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:10, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:11, 114, 0, CALLNAME:1, "")
		RETURN 1
	ELSE
		RETURN -1
	ENDIF
ELSEIF LOCAL:2 <= 1 && LOCAL:1 == 0 && LOCAL:4 == 0
	;誰も見張りができない場合、はい/いいえの確認だけ
	PRINTFORML 本当にこの部屋で眠りますか？
	CALL ASK_YN
	IF RESULT == 0
		CFLAG:1:11 = 4
		CFLAG:1:13 = FLAG:5
		CFLAG:1:14 = FLAG:5
		FLAG:8 = 1
		CALL PRINT_MESSAGE(-1, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(1, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:10, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:11, 114, 0, CALLNAME:1, "")
		RETURN 1
	ELSE
		RETURN -1
	ENDIF
ELSE
	;誰かが見張りできる場合
	PRINTFORML 睡眠中の見張りはどうしますか？
	PRINTFORML [1] 見張り無しで眠る
	SIF LOCAL:2 > 1
		PRINTFORML [2] パーティーメンバーで交代しながら見張る
	SIF LOCAL:1
		PRINTFORML [3] %CALLNAME:(LOCAL:1)%に見張りを頼む
	SIF LOCAL:4
		PRINTFORML [4] 使い魔に見張りを頼む
	PRINTFORML [0] 眠るのをやめる
	$INPUT_LOOP
	INPUT
	IF RESULT == 0
		RETURN -1
	ELSEIF RESULT == 1
		CALL PRINT_MESSAGE(-1, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(1, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:10, 114, 0, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:11, 114, 0, CALLNAME:1, "")
		FLAG:8 = 1
	ELSEIF RESULT == 2 && LOCAL:2 > 1
		CALL PRINT_MESSAGE(-1, 114, 1, CALLNAME:1, "")
		CALL PRINT_MESSAGE(1, 114, 1, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:10, 114, 1, CALLNAME:1, "")
		CALL PRINT_MESSAGE(FLAG:11, 114, 1, CALLNAME:1, "")
		FLAG:8 = 1 + LOCAL:2 * 10
	ELSEIF RESULT == 3 && LOCAL:1
		CALL PRINT_MESSAGE(-1, 114, 2, CALLNAME:1, CALLNAME:(LOCAL:1), LOCAL:1)
		CALL PRINT_MESSAGE(1, 114, 2, CALLNAME:1, CALLNAME:(LOCAL:1), LOCAL:1)
		CALL PRINT_MESSAGE(FLAG:10, 114, 2, CALLNAME:1, CALLNAME:(LOCAL:1), LOCAL:1)
		CALL PRINT_MESSAGE(FLAG:11, 114, 2, CALLNAME:1, CALLNAME:(LOCAL:1), LOCAL:1)
		FLAG:8 = 1 + LOCAL:1 * 100
		;必ず引き受けてくれるが、好感度が下がる
		IF LOCAL:3 == 0
			CFLAG:(LOCAL:1):5 -= 20
		ELSE
			;ドッペルの場合、睡眠フラグをマイナスにしてやる
			FLAG:8 = -1 * FLAG:8
		ENDIF
	ELSEIF RESULT == 4 && LOCAL:4
		CALL PRINT_MESSAGE(1, 503, 1, CALLNAME:1, "")
		FLAG:8 = 1
	ELSE
		REUSELASTLINE 入力値が不正です。再入力してください
		GOTO INPUT_LOOP
	ENDIF
	
	CFLAG:1:11 = 4
	CFLAG:1:13 = FLAG:5
	CFLAG:1:14 = FLAG:5
	RETURN 1
ENDIF

;=================================================
;睡眠による回復
;ARG:0	対象キャラ
;ARG:1	状況（0：よく寝た　1：浅い眠り（寝てる間に襲われた））
;=================================================
@SLEEP_HEAL(ARG:0, ARG:1)
;LOCAL
;0		LOOP
;1-3	TEMP
;4		倍率
;5		素質補正

SIF ARG:0 == 0
	RETURN


;素質補正計算
LOCAL:5 = 100
;回復早い
SIF TALENT:(ARG:0):111
	TIMES LOCAL:5 , 1.25
;回復遅い
SIF TALENT:(ARG:0):112
	TIMES LOCAL:5 , 0.9
;吸血鬼
IF TALENT:(ARG:0):114
	IF TIME:0 == 0 || TIME:0 == 1
		TIMES LOCAL:5 , 0.75
	ELSE
		TIMES LOCAL:5 , 2.0
	ENDIF
ENDIF
;日光浴
IF TALENT:(ARG:0):115
	SIF TIME:0 == 0 || TIME:0 == 1
		TIMES LOCAL:5 , 1.5
ENDIF
;月光浴
IF TALENT:(ARG:0):116
	SIF TIME:0 == 2 || TIME:0 == 3
		TIMES LOCAL:5 , 1.5
ENDIF
;メンバーの誰かがもふ尻尾
IF (TALENT:1:215 % 10) == 2 || (FLAG:10 && TALENT:(FLAG:10):215 == 2) || (FLAG:11 && TALENT:(FLAG:11):215 == 2)
		TIMES LOCAL:5 , 1.05
ENDIF

IF FLAG:(CFLAG:(ARG:0):4 + 50) >= 100
	CALL SLEEP_TENTACLE(ARG:0)
	WAIT
ENDIF

IF ARG:1 == 0
	IF CFLAG:(ARG:0):7 == 22 || CFLAG:(ARG:0):8 == 22 || CFLAG:(ARG:0):9 == 22
		CALL SLEEP_TUKAIMA((ARG:0))
	ELSE
		CFLAG:(ARG:0):503 = 0
	ENDIF
	WAIT
ENDIF


IF CFLAG:(ARG:0):10 || CFLAG:(ARG:0):20 || CFLAG:(ARG:0):29
	;寝ていられる状態じゃない場合、睡眠による回復ブースト無し
	RETURN
ENDIF

IF ARG:1 == 0
	;汚染度補正
	IF FLAG:(CFLAG:(ARG:0):4 + 50) < 10
		LOCAL:4 = 150
	ELSEIF FLAG:(CFLAG:(ARG:0):4 + 50) < 40
		LOCAL:4 = 100
	ELSEIF FLAG:(CFLAG:(ARG:0):4 + 50) < 70
		LOCAL:4 = 95
	ELSEIF FLAG:(CFLAG:(ARG:0):4 + 50) < 100
		LOCAL:4 = 85
	ELSE
		LOCAL:4 = 70
	ENDIF
	
	BASE:(ARG:0):0 += MAXBASE:(ARG:0):0 * LOCAL:4 * LOCAL:5 / 10000 / 2
	IF BASE:(ARG:0):0 > MAXBASE:(ARG:0):0
		BASE:(ARG:0):0 = MAXBASE:(ARG:0):0
	ENDIF
	BASE:(ARG:0):1 += MAXBASE:(ARG:0):1 * LOCAL:4 * LOCAL:5 / 10000 / 4
	IF BASE:(ARG:0):1 > MAXBASE:(ARG:0):1
		BASE:(ARG:0):1 = MAXBASE:(ARG:0):1
	ENDIF
	BASE:(ARG:0):2 += MAXBASE:(ARG:0):2 * LOCAL:4 / 100 / 15
	IF BASE:(ARG:0):2 > MAXBASE:(ARG:0):2
		BASE:(ARG:0):2 = MAXBASE:(ARG:0):2
	ENDIF
	CALL GET_BASIC_TP(ARG:0)
	BASE:(ARG:0):4 = RESULT
ELSE
	;汚染度補正
	IF FLAG:(CFLAG:(ARG:0):4 + 50) < 10
		LOCAL:4 = 150
	ELSEIF FLAG:(CFLAG:(ARG:0):4 + 50) < 40
		LOCAL:4 = 100
	ELSEIF FLAG:(CFLAG:(ARG:0):4 + 50) < 70
		LOCAL:4 = 95
	ELSEIF FLAG:(CFLAG:(ARG:0):4 + 50) < 100
		LOCAL:4 = 85
	ELSE
		LOCAL:4 = 70
	ENDIF
	
	BASE:(ARG:0):0 += MAXBASE:(ARG:0):0 * LOCAL:4 * LOCAL:5 / 10000 / 4
	IF BASE:(ARG:0):0 > MAXBASE:(ARG:0):0
		BASE:(ARG:0):0 = MAXBASE:(ARG:0):0
	ENDIF
	BASE:(ARG:0):1 += MAXBASE:(ARG:0):1 * LOCAL:4 * LOCAL:5 / 10000 / 8
	IF BASE:(ARG:0):1 > MAXBASE:(ARG:0):1
		BASE:(ARG:0):1 = MAXBASE:(ARG:0):1
	ENDIF
	BASE:(ARG:0):2 += MAXBASE:(ARG:0):2 * LOCAL:4 / 100 / 30
	IF BASE:(ARG:0):2 > MAXBASE:(ARG:0):2
		BASE:(ARG:0):2 = MAXBASE:(ARG:0):2
	ENDIF
	CALL GET_BASIC_TP(ARG:0)
	BASE:(ARG:0):4 = RESULT
ENDIF


;睡眠時自慰チェック
IF (FLAG:8 % 10) > 1
	;気絶中は流石に自慰は発生しない
	RETURN
ENDIF

IF ABL:(ARG:0):10 <= 0
	LOCAL:1 = 20
ELSEIF ABL:(ARG:0):10 == 1
	LOCAL:1 = 40
ELSEIF ABL:(ARG:0):10 == 2
	LOCAL:1 = 60
ELSEIF ABL:(ARG:0):10 >= 3
	LOCAL:1 = 90
ENDIF
LOCAL:2 = BASE:(ARG:0):2 * 100 / MAXBASE:(ARG:0):2

SIF TALENT:(ARG:0):60
	LOCAL:1 += 10

IF LOCAL:1 > LOCAL:2 && CFLAG:(ARG:0):20 == 0
	;閾値未満のEPなら自慰発生の可能性あり
	LOCAL:3 = 20 + 10 * ABL:(ARG:0):10
	
	;◆発情補正
	SIF CFLAG:(ARG:0):28 >= 1
		LOCAL:3 += (CFLAG:(ARG:0):28) * 60
	;◆◆
	SIF TALENT:(ARG:0):20
		LOCAL:3 -= 20
	
	SIF LOCAL:2 <= 20
		LOCAL:3 += (30 - LOCAL:2) * 3
	
	IF RAND:100 < LOCAL:3
		CALL PRINT_MESSAGE(ARG:0, 117, 0, CALLNAME:(ARG:0), "")
		CALL MASTURBATION(ARG:0, 0, 100)
		
		;たまに見つかる
		IF FLAG:10
			IF RAND:4 == 0
				PRINTFORML 
				PRINTFORMW 見つかってしまった！
				PRINTFORMW %CALLNAME:(ARG:0)%は仲間の視線に貫かれ意味不明の叫び声を上げているが、手を止めることができない！
				PRINTFORML 仲間の目の前で、%CALLNAME:(ARG:0)%のオナニーショーは続く…
				CALL MASTURBATION(ARG:0, 1, 100)
				PRINTFORML 
			ENDIF
		ENDIF
		
		FOR LOCAL:0, 1, FLAG:1
		;ウォッチャーチェック
			IF FLAG:5 == DA:(LOCAL:0):4 && DA:(LOCAL:0):0 == 97
				PRINTFORMW 自慰にふける姿をウォッチャーに見られてしまった！
			ENDIF
			IF TALENT:(ARG:0):36
				;恥薄いならダメージなし
			ELSEIF TALENT:(ARG:0):35
				;恥じらいなら２倍
				LOCAL:1 = MAXBASE:(ARG:0):1 * (5 + RAND:11) / 1000
				BASE:(ARG:0):1 -= LOCAL:1
				BASE:(ARG:0):4 -= LOCAL:1
				IF BASE:(ARG:0):1 <= 0
					;0にはならない
					BASE:(ARG:0):1 = 1
				ENDIF
				IF BASE:(ARG:0):4 <= 0
					;0未満にはならない
					BASE:(ARG:0):4 = 0
				ENDIF
			ELSE
				LOCAL:1 = MAXBASE:(ARG:0):1 * (3 + RAND:5) / 1000
				BASE:(ARG:0):1 -= LOCAL:1
				BASE:(ARG:0):4 -= LOCAL:1
				IF BASE:(ARG:0):1 <= 0
					;0にはならない
					BASE:(ARG:0):1 = 1
				ENDIF
				IF BASE:(ARG:0):4 <= 0
					;0未満にはならない
					BASE:(ARG:0):4 = 0
				ENDIF
			ENDIF
		NEXT
		;EPが満タンになっている＝イけた場合、満足してMP回復
		IF BASE:(ARG:0):2 == MAXBASE:(ARG:0):2
			BASE:(ARG:0):1 += MAXBASE:(ARG:0):1 / 5
			SIF BASE:(ARG:0):1 > MAXBASE:(ARG:0):1
				BASE:(ARG:0):1 = MAXBASE:(ARG:0):1
		ENDIF
	ENDIF
ENDIF

CALL CHECK_OMORASHI(ARG:0, 100, 1) 
CALL CHECK_UNK_OMORASHI(ARG:0, 100, "部屋睡眠") ;★便意パッチ加筆点★



;触手部屋で寝る
;ARG:0	対象キャラ
@SLEEP_TENTACLE(ARG:0)
#DIM MP_DECREASE_RATE
CALL PRINT_MESSAGE(ARG:0, 115, 0, CALLNAME:(ARG:0), "")
LOCAL:1 = RAND:4
LOCAL:2 = 300 + RAND:401
CALL ADD_ABL_EXP(LOCAL:1 + 6, ARG:0, 100 + RAND:100)
CALL DOUKA_EFFECT_5(ARG:0)
IF RESULT > 0
	MP_DECREASE_RATE = RESULT:1
ELSE
	MP_DECREASE_RATE = 300
ENDIF
TFLAG:63 = LOCAL:1
CALL PRINT_MESSAGE(ARG:0, 116, LOCAL:1, CALLNAME:(ARG:0), "", LOCAL:2)
CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:2, MP_DECREASE_RATE, 1)
LOCAL:1 = RAND:4
LOCAL:2 = 300 + RAND:401
CALL ADD_ABL_EXP(LOCAL:1 + 6, ARG:0, 100 + RAND:100)
CALL DOUKA_EFFECT_5(ARG:0)
IF RESULT > 0
	MP_DECREASE_RATE = RESULT:1
ELSE
	MP_DECREASE_RATE = 300
ENDIF
TFLAG:63 = LOCAL:1
CALL PRINT_MESSAGE(ARG:0, 116, LOCAL:1, CALLNAME:(ARG:0), "", LOCAL:2)
CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:2, MP_DECREASE_RATE, 1)
CALL ADD_ABL_EXP(11, ARG:0, 2)

;きのこパッチここから
;50%の確率で侵食される
;[綺麗好き]があれば回避できる
IF RAND:2 == 0 && (TALENT:(ARG:0):152 == 0 || CFLAG:(ARG:0):10 || CFLAG:(ARG:0):20 || CFLAG:(ARG:0):29)
	CALL PRINT_MESSAGE(ARG:0, 445, 4, CALLNAME:(ARG:0), "")
	CFLAG:(ARG:0):80 += 1 + RAND:3
ENDIF
;ここまで


;使い魔を装備して寝る
;ARG:0	対象キャラ
@SLEEP_TUKAIMA(ARG:0)
CFLAG:(ARG:0):503 += 1
SIF CFLAG:(ARG:0):503 > 4
	CFLAG:(ARG:0):503 = 4
CALL PRINT_MESSAGE(ARG:0, 503, 0, CALLNAME:(ARG:0), "")
TFLAG:63 = 1
LOCAL:1 = 500 + RAND:401
CALL ADD_ABL_EXP(7, ARG:0, 100 + RAND:100)
CALL PRINT_MESSAGE(ARG:0, 503, 2, CALLNAME:(ARG:0), "", LOCAL:1)
FOR LOCAL:0,0,(RAND:5 + 1)
CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:1, 400)
NEXT
CALL ADD_ABL_EXP(11, ARG:0, 2)
IF CFLAG:(ARG:0):503 >= 3
	IF TALENT:(ARG:0):130 < 6
		CALL MILK_COME(ARG:0, 1, 1)
		LOCAL:2 = RESULT:0
		CALL PRINT_MESSAGE(ARG:0, 503, 4, CALLNAME:(ARG:0), "")
		CALL MILK_ADJUST(ARG:0, LOCAL:2)
	ELSEIF TALENT:(ARG:0):102 < 3
		TALENT:(ARG:0):102 += 1
		CALL PRINT_MESSAGE(ARG:0, 503, 5, CALLNAME:(ARG:0), "")
	ELSEIF TALENT:(ARG:0):76 == 0
		TALENT:(ARG:0):76 = 1
		CALL PRINT_MESSAGE(ARG:0, 503, 9, CALLNAME:(ARG:0), "")
		CALL ADD_HISTORY(DAY, ARG:0, 1, 10)
	ELSE
		TFLAG:63 = 1
		CALL PRINT_MESSAGE(ARG:0, 503, 3, CALLNAME:(ARG:0), "")
		FOR LOCAL:0, 0, (RAND:5 + 1)
			CALL DAMAGE_COMMON(ARG:0, 2, 3000 + RAND:3001, 400)
		NEXT
	ENDIF
ENDIF
;=================================================
