@TRAP_SET
#DIM LCOUNT
VARSET LOCAL
IF TRAP:5 == FLAG:5 || TRAP:6 == FLAG:5 || TRAP:7 == FLAG:5
	DRAWLINE
	PRINTFORML この部屋にはトラップを既に設置してあります
	PRINTFORML 撤去しますか？
	PRINTFORML [1] はい
	PRINTFORML [0] いいえ
	$INPUT_LOOP
	INPUT
	SIF RESULT != 1
		RETURN
	IF TRAP:5 == FLAG:5
		TRAP:0 = 0
		TRAP:5 = 0
	ENDIF
	IF TRAP:6 == FLAG:5
		TRAP:1 = 0
		TRAP:6 = 0
	ENDIF
	IF TRAP:7 == FLAG:5
		TRAP:2 = 0
		TRAP:7 = 0
	ENDIF
	PRINTFORML トラップを撤去しました！
	CALL WAIT_AUTOMODE(400, 0)

	RETURN 1
ENDIF

FOR LCOUNT, 0, 20
SELECTCASE LCOUNT
	CASE 1
		LOCAL:LCOUNT = 100
		LOCALS:LCOUNT = トラバサミ
	CASE 2
		LOCAL:LCOUNT = 150
		LOCALS:LCOUNT = テレポーター
	CASE 3
		LOCAL:LCOUNT = 300
		LOCALS:LCOUNT = パワードレイン
	CASE 10
		LOCAL:LCOUNT = 300
		LOCALS:LCOUNT = 触手落とし穴
	CASE 11
		LOCAL:LCOUNT = 300
		LOCALS:LCOUNT = 魔法の拘束具
ENDSELECT
NEXT

DRAWLINE
PRINTFORML どのトラップを設置しますか？
PRINTFORML 現在のトラップ
IF TRAP:0
	PRINTFORML 罠1:%LOCALS:(TRAP:0), 15, LEFT% 場所:{TRAP:5}
ELSE
	PRINTFORML 罠なし
ENDIF
SIF TRAP:1
	PRINTFORML 罠2:%LOCALS:(TRAP:1), 15, LEFT% 場所:{TRAP:6}
SIF TRAP:2
	PRINTFORML 罠3:%LOCALS:(TRAP:2), 15, LEFT% 場所:{TRAP:7}
DRAWLINE
FOR LCOUNT, 0, 20
	SIF !LOCAL:LCOUNT
		CONTINUE
	PRINTFORML [{LCOUNT}] %LOCALS:LCOUNT, 15, LEFT% 浄化力:{LOCAL:LCOUNT}
NEXT
PRINTFORML [0] 戻る

$INPUT_LOOP2
INPUT

SIF RESULT == 0
	RETURN 0

SELECTCASE RESULT
	CASE 1, 2, 3, 10, 11
	CASEELSE
		REUSELASTLINE 不正な入力です
		GOTO INPUT_LOOP2
ENDSELECT

IF FLAG:6 < LOCAL:RESULT
	REUSELASTLINE 浄化力が不足しています
	GOTO INPUT_LOOP2
ENDIF

PRINTFORML %CALLNAME:1%は%LOCALS:RESULT%を設置した！
CALL WAIT_AUTOMODE(400, 0)

FLAG:6 -= LOCAL:RESULT
IF !TRAP:0
	TRAP:0 = RESULT
	TRAP:5 = FLAG:5
	RETURN 1
ENDIF

IF !TRAP:1
	TRAP:1 = RESULT
	TRAP:6 = FLAG:5
	RETURN 1
ENDIF

IF !TRAP:2
	TRAP:2 = RESULT
	TRAP:7 = FLAG:5
	RETURN 1
ENDIF
RETURN 1

@ENDPHASE_TRAP
#DIM LCOUNT
FOR LCOUNT, 0, 3
	SELECTCASE TRAP:LCOUNT
		CASE 1 TO 3
			CALL TRAP_SERCH_ENEMY(LCOUNT)
		CASE 10 TO 11
			CALL TRAP_SERCH_FRIEND(LCOUNT)
	ENDSELECT
NEXT

@TRAP_SERCH_ENEMY(ARG)
#DIM LCOUNT
VARSET LOCAL
FOR LCOUNT, 1, 100
	IF DA:LCOUNT:4 == TRAP:(ARG + 5) && DA:LCOUNT:4
		TRYCALLFORM TRAP_HIT_{TRAP:ARG}(ARG, LCOUNT)
		LOCAL ++
	ENDIF
NEXT
IF LOCAL
	TRAP:ARG = 0
	TRAP:(ARG + 5) = 0
ENDIF

@TRAP_SERCH_FRIEND(ARG)
#DIM LCOUNT
VARSET LOCAL
FOR LCOUNT, 2, CHARANUM
	IF CFLAG:LCOUNT:4 == TRAP:(ARG + 5) && LCOUNT != FLAG:10 && LCOUNT != FLAG:11
		TRYCALLFORM TRAP_HIT_{TRAP:ARG}(ARG, LCOUNT)
		LOCAL ++
	ENDIF
NEXT
IF LOCAL
	TRAP:ARG = 0
	TRAP:(ARG + 5) = 0
ENDIF

@TRAP_HIT_1(ARG, ARG:1)
PRINTFORML %SAVESTR:(ARG:1)%が{TRAP:(ARG + 5)}の部屋のトラバサミに引っかかった！
CALL WAIT_AUTOMODE(400, 0)

DA:(ARG:1):1 = DA:(ARG:1):1 * 9 / 10 - (RAND:500 + 500)
SIF DA:(ARG:1):1 <= 0
	DA:(ARG:1):1 = 1

@TRAP_HIT_2(ARG, ARG:1)
PRINTFORML %SAVESTR:(ARG:1)%が{TRAP:(ARG + 5)}の部屋のテレポーターに引っかかった！
CALL WAIT_AUTOMODE(400, 0)

DA:(ARG:1):4 = RAND:30 + 1

@TRAP_HIT_3(ARG, ARG:1)
PRINTFORML %SAVESTR:(ARG:1)%が{TRAP:(ARG + 5)}の部屋のパワードレインに引っかかった！
CALL WAIT_AUTOMODE(400, 0)

DA:(ARG:1):5 = DA:(ARG:1):5 * 9 / 10
SIF DA:(ARG:1):5 <= 0
	DA:(ARG:1):5 = 1

@TRAP_HIT_10(ARG, ARG:1)
PRINTFORML %CALLNAME:(ARG:1)%が{TRAP:(ARG+ 5)}の部屋の触手落とし穴に引っかかった！
CALL WAIT_AUTOMODE(400, 0)

	LOCAL:4 = 0
	CALL ADD_ABL_EXP(5, (ARG:1), 1000 + RAND:(ABL:(ARG:1):5 * 500 + 1))
	CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:(ARG:1), "", 1)
	LOCAL:5 = 5 + RAND:4 + RAND:4
	FOR LOCAL:0, 0, LOCAL:5
		LOCAL:6 = RAND:4
		IF LOCAL:6 == 3
			CALL LOST_VIRGIN(1, 1, 4)
		ENDIF
		CALL EXTASY((ARG:1), LOCAL:6, RAND:50, 150)
	NEXT
	IF CFLAG:(ARG:1):22 == 0 && RAND:4 < 2 && TALENT:(ARG:1):0 == 0
		CALL RANDOM_PARASITE((ARG:1), 0, 0)
		IF RESULT
			CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:(ARG:1), "", 3)
		ENDIF
	ELSEIF CFLAG:(ARG:1):22 == 0 && RAND:2 == 0 && TALENT:(ARG:1):0 == 0
		CALL RANDOM_PARASITE((ARG:1), 1, 0)
	ENDIF
	LOCAL:4 = 1
	WAIT

@TRAP_HIT_11(ARG, ARG:1)
PRINTFORML %CALLNAME:(ARG:1)%が{TRAP:(ARG+ 5)}の部屋の魔法の拘束具に引っかかった！
CALL WAIT_AUTOMODE(400, 0)

CFLAG:(ARG:1):504 = 1