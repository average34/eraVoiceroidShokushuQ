;素質ペットを返上し主人として契約し直す
;失敗すると二度と反抗できないまで調教
@CONTRACT_PET
#DIM LCOUNT	;ループ用
#DIM CHARA_ID

PRINTFORML 素質【ペット】を返上し、%PETNAME%と主従関係を結び直すことができます。
PRINTFORML ただし、失敗した場合、二度と反抗できず【ペット】よりひどい状態になります。
PRINTFORML 誰が挑戦しますか？

IF TALENT:1:140 == 1
	PRINTFORML [1] %CALLNAME:1%
ENDIF
IF FLAG:10 && TALENT:(FLAG:10):140 == 1
	PRINTFORML [2] %CALLNAME:(FLAG:10)%
ENDIF
IF FLAG:11 && TALENT:(FLAG:11):140 == 1
	PRINTFORML [3] %CALLNAME:(FLAG:11)%
ENDIF
PRINTFORML [0] 戻る
INPUT
$INPUT_LOOP
IF RESULT < 0 || RESULT >= 4
	GOTO INPUT_LOOP
ELSEIF RESULT == 0
	RETURN
ELSEIF RESULT == 1
	CHARA_ID = 1
ELSEIF RESULT == 2 && FLAG:10
	CHARA_ID = FLAG:10
ELSEIF RESULT == 3 && FLAG:11
	CHARA_ID = FLAG:11
ENDIF


;拘束して、敵としての行動パターンを決定
DA:0:20 = CHARA_ID


FOR LCOUNT, 0, 10
	TRYCALLFORM SELECT_ENEMY_ACTION_{PET:0}(0, CHARA_ID)

	;攻撃コマンド代入
	TFLAG:50 = DA:0:50

	;攻撃データ取得
	TRYCCALLFORM FIX_ENEMY_ACTION_{TFLAG:50}(0)
	CATCH
		PRINTFORML 存在しない攻撃番号です
	ENDCATCH
	;エロ攻撃なら通す、ループ終了まで引かなければ諦める
	IF TFLAG:55 == 3
		BREAK
	ENDIF
NEXT


;攻撃処理
CALL FIX_BATTLE_ACTION

;絶頂フラグか催眠になれば失敗
IF CFLAG:CHARA_ID:99 || CFLAG:CHARA_ID:43
	;完全に屈服させ自由意志塗りつぶし中
	CALL PRINT_MESSAGE(CHARA_ID, 401, 0, CALLNAME:CHARA_ID, PETNAME)
	IF PET:0 >= 101 && PET:0 <= 105
		CALLFORM PRINT_MESSAGE(PET:9, 1401, 0, CALLNAME:1, PETNAME)
	ENDIF
	;絶頂と妊娠
	FOR LCOUNT, 0, 10
		CALL PET_RAPE(CHARA_ID)
	NEXT
	CALL PARASITE_TYPE(CHARA_ID, 1, PET:0, 8 + LIMIT(RAND:4 + RAND:4 + RAND:4 + RAND:4, 1, 10), 2)
	CALL ADD_ABL_EXP(14, CHARA_ID, 100)
	;屈服刻印も追加
	CALL GET_MARK(CHARA_ID, 20, 0)
	TALENT:CHARA_ID:140 = 3
	;それを見せられたPTメンバーの反応
	IF CHARA_ID != 1
		CALL PRINT_MESSAGE(1, 401, 1, CALLNAME:CHARA_ID, PETNAME)
	ENDIF
	IF CHARA_ID != FLAG:10
		CALL PRINT_MESSAGE(FLAG:10, 401, 1, CALLNAME:CHARA_ID, PETNAME)
	ENDIF
	IF CHARA_ID != FLAG:11
		CALL PRINT_MESSAGE(FLAG:11, 401, 1, CALLNAME:CHARA_ID, PETNAME)
	ENDIF
	
	;主人公以外がしもべになり、主人公が花嫁やしもべでないなら連鎖堕ちイベント発生
	IF CHARA_ID != 1 && TALENT:1:140 < 2
		CALL LINK_FALL(CHARA_ID)
	ENDIF
;絶頂しなければ素質ペット返上
ELSE
	CALL PRINT_MESSAGE(CHARA_ID, 401, 2, CALLNAME:CHARA_ID, PETNAME)
	TALENT:CHARA_ID:140 = 0
	CFLAG:CHARA_ID:400 = 70
ENDIF

;催眠以外の変数リセット
VARSET TFLAG, 0, 50, 100
DA:0:20 = 0
DA:0:50 = 0
CFLAG:CHARA_ID:99 = 0
