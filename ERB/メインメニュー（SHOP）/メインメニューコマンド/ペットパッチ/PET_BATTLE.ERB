;ペットの戦闘中の色々をアレアレする関数
;名前はDO_BATTLE_ACTIONだけどその後の処理も全部やってる
;各種データが存在しない場合、リビングバインのそれ(5番)が呼び出される
@PET_DO_BATTLE_ACTION
#DIM LCOUNT, 5
VARSET LOCAL
VARSET RESULT
;ペットデータ呼び出し
TRYCCALLFORM SET_PET_DATA_{PET:0}
CATCH
	CALL SET_PET_DATA_5
ENDCATCH
;-------------
;行動率算出
;-------------
;空腹値補正
LOCAL = PET:31 - (100 - PET:20) / 5
SELECTCASE PET_STARVE()
	CASE 3
		LOCAL += 20
	CASE 2
		LOCAL += 10
	CASE 0
		LOCAL -= 20
ENDSELECT

;好感度補正
SELECTCASE PET_LIKE()
	CASE 3
		LOCAL += 20
	CASE 2
		LOCAL += 10
	CASE 0
		LOCAL -= 20
ENDSELECT

;やる気補正
	LOCAL += PET:12 / 3

;屈服度補正
	LOCAL += PET_SUBMISSION_PT() / GET_MEMBER_SUM() / 10

;ランクによるリミット
SELECTCASE PET:1
	CASE 7
		LOCAL = LIMIT (LOCAL, 30, 100)
	CASE 6
		LOCAL = LIMIT (LOCAL, 20, 100)
	CASE 5
		LOCAL = LIMIT (LOCAL, 20, 90)
	CASE 4
		LOCAL = LIMIT (LOCAL, 15, 80)
	CASE 3
		LOCAL = LIMIT (LOCAL, 15, 70)
	CASE 2
		LOCAL = LIMIT (LOCAL, 10, 60)
	CASE 1
		LOCAL = LIMIT (LOCAL, 10, 50)
ENDSELECT
;-------------
;行動率算出ここまで
;-------------

;-------------
;裏切るか判定
;-------------
CALL PET_RAPE
SIF RESULT == 1
	RETURN 1

;-------------
;裏切るか判定ここまで
;-------------


;-------------
;行動対象・内容判定
;-------------
IF LOCAL > RAND:100
	TRYCCALLFORM SELECT_PET_ACTION_{PET:0}
	CATCH
		CALL SELECT_PET_ACTION_5
	ENDCATCH
	TRYCCALLFORM PET_TARGET_RATE_{PET:0}
	CATCH
		CALL PET_TARGET_RATE_5
	ENDCATCH
ELSE
	PET:50 = 0
ENDIF
;-------------
;行動対象・内容判定ここまで
;-------------

;-------------
;行動データ呼び出し
;-------------
TRYCCALLFORM FIX_PET_ACTION_{PET:50}
CATCH
	CALL FIX_PET_ACTION_0
ENDCATCH
;-------------
;行動データ呼び出しここまで
;-------------

;-------------
;メイン処理スルー
;-------------
SIF PET:99
	RETURN 1
;-------------
;メイン処理スルーここまで
;-------------


;-------------
;ダメージ算出
;-------------
LOCAL:1 = (25 + PET:10 / 2) * PET:90 + PET_SUBMISSION_PT() / 10
SELECTCASE PET_STARVE()
	CASE 3
		TIMES LOCAL:1, 1.25
	CASE 2
		TIMES LOCAL:1, 1.125
	CASE 0
		TIMES LOCAL:1, 0.8
ENDSELECT
;難易度補正
;EASY時のクイーンとか相手の補正はナシ
SELECTCASE FLAG:4
	CASE 0
		TIMES LOCAL:1, 1.7
	CASE 1
		TIMES LOCAL:1, 1.2
	CASE 3
		TIMES LOCAL:1, 0.8
ENDSELECT
;乱数
LOCAL:1 = LOCAL:1 * (90 + RAND:11 + RAND:11) / 1000

;-------------
;ダメージ算出ここまで
;-------------


;-------------
;命中率算出
;-------------
IF PET:92 == 0
	;技命中率による補正
	LOCAL:3 = PET:32 * PET:91 / 100 + PET_SUBMISSION_PT() / GET_MEMBER_SUM() / 10

	;難易度補正
	SELECTCASE FLAG:4
		CASE 0
			LOCAL:3 += 10
		CASE 2
			LOCAL:3 -= 5
		CASE 3
			LOCAL:3 -= 10
	ENDSELECT

	;防御側の回避率低下によるボーナス
	LOCAL:3 += DA:(PET:51):81

	;速度が関わる
	LOCAL:3 = (LOCAL:3 + PET:11 / 2)
	
	TIMES LOCAL:3, 0.8


	;空腹値補正
	LOCAL:3 = LOCAL:3 - (100 - PET:20) / 7

	;好感度補正
	SELECTCASE PET_LIKE()
		CASE 3
			LOCAL:3 += 10
		CASE 2
			LOCAL:3 += 7
		CASE 0
			LOCAL:3 -= 5
	ENDSELECT

	;ランクによるリミット
	SELECTCASE PET:1
		CASE 7
			LOCAL:3 = LIMIT(LOCAL:3, 40, 100)
		CASE 6
			LOCAL:3 = LIMIT(LOCAL:3, 30, 100)
		CASE 5
			LOCAL:3 = LIMIT(LOCAL:3, 30, 90)
		CASE 4
			LOCAL:3 = LIMIT(LOCAL:3, 30, 80)
		CASE 3
			LOCAL:3 = LIMIT(LOCAL:3, 20, 70)
		CASE 2
			LOCAL:3 = LIMIT(LOCAL:3, 15, 70)
		CASE 1
			LOCAL:3 = LIMIT(LOCAL:3, 10, 60)
	ENDSELECT

	;対象の状態次第で必中
	SIF DA:(PET:51):24 || DA:(PET:51):25
		LOCAL:3 = 100
ELSE
	;回復系は必中
	LOCAL:3 = 100
ENDIF
;-------------
;命中判定ここまで
;-------------

;-------------
;数字をどうこうする処理
;-------------

;攻撃回数が0なら1に修正
SIF PET:94 == 0
	PET:94 = 1

;攻撃回数だけループ
FOR LCOUNT:1, 0, PET:94
	;全体攻撃フラグあり
	IF PET:93
		;敵への攻撃
		IF PET:92 == 0
			;命中率表示回数は1回で良い
			PRINTFORML 命中率:{LOCAL:3}％
			;敵の数だけループ
			FOR LCOUNT, 1, TFLAG:15 + 1
				;死体殴り防止
				SIF DA:(TFLAG:LCOUNT):1 <= 0
					CONTINUE
				IF RAND:100 < 2 + PET:13 / 3
					SETCOLOR 255, 255, 0
					PRINTFORML クリティカルヒット！
					RESETCOLOR
					LOCAL:1 = LOCAL:1 * 3
					LOCAL:3 += 100
					LOCAL:5 = 1
				ENDIF
				PET:51 = TFLAG:LCOUNT
				IF RAND:100 > LOCAL:3
					PRINTFORML 外した！
					CONTINUE
				ENDIF
				PRINTFORM %SAVESTR:(PET:51)%に
				SETCOLOR 0x70FFFF
				PRINTFORM {LOCAL:1}
				RESETCOLOR
				PRINTFORML のダメージ！
				DA:(PET:51):1 -= LOCAL:1
				;ダメージによる拘束キャラ救出判定
				IF DA:(PET:51):1 > 0 && (DA:(PET:51):10 || DA:(PET:51):20)
					LOCAL:4 = 2 + LIMIT((LOCAL * 51 / DA:(PET:51):2), 1, 10) + LIMIT((DA:(PET:51):1 * 10 / DA:(PET:51):2), 0, 5)
					IF RAND:100 < LOCAL:4
						CALL STATUS_RENEW_RELEASE(DA:(PET:51):10, 0, 2)
						CALL STATUS_RENEW_RELEASE(DA:(PET:51):20, 0, 2)
					ENDIF
				ELSEIF DA:(PET:51):1 <= 0 && (DA:(PET:51):10 || DA:(PET:51):20)
					CALL STATUS_RENEW_RELEASE(DA:(PET:51):10, 0, 2)
					CALL STATUS_RENEW_RELEASE(DA:(PET:51):20, 0, 2)
				ENDIF
				IF LOCAL:5 == 1
					LOCAL:1 = LOCAL:1 / 3
					LOCAL:3 -= 100
					LOCAL:5 = 0
				ENDIF
				SIF PET:98
					TRYCALLFORM PET_EXTRA_ACTION_{PET:98}
			NEXT
		;味方への回復
		ELSEIF PET:92 >= 1
			PET:51 = 1
			;先頭キャラ
			PRINTFORM %CALLNAME:(PET:51)%の
			SELECTCASE PET:92
				CASE 1
					PRINT HPが
				CASE 2 
					PRINT MPが
				CASE 3
					PRINT TPが
			ENDSELECT
			SETCOLOR 0x70FFFF
			PRINTFORM {LOCAL:1}
			RESETCOLOR
			PRINTFORML 回復！
			SELECTCASE PET:92
				CASE 1
					BASE:(PET:51):0 += LOCAL:1
					SIF BASE:(PET:51):0 > MAXBASE:(PET:51):0
						BASE:(PET:51):0 = MAXBASE:(PET:51):0
				CASE 2
					BASE:(PET:51):1 += LOCAL:1
					SIF BASE:(PET:51):1 > MAXBASE:(PET:51):1
						BASE:(PET:51):1 = MAXBASE:(PET:51):1
				CASE 3
					BASE:(PET:51):4 += LOCAL:1
					SIF BASE:(PET:51):4 > MAXBASE:(PET:51):4
						BASE:(PET:51):4 = MAXBASE:(PET:51):4
			ENDSELECT
			SIF PET:98
				TRYCALLFORM PET_EXTRA_ACTION_{PET:98}
			;二人目（いる場合）
			IF FLAG:10
				PET:51 = FLAG:10
				PRINTFORM %CALLNAME:(PET:51)%の
				SELECTCASE PET:92
					CASE 1
						PRINT HPが
					CASE 2 
						PRINT MPが
					CASE 3
						PRINT TPが
				ENDSELECT
				SETCOLOR 0x70FFFF
				PRINTFORM {LOCAL:1}
				RESETCOLOR
				PRINTFORML 回復！
				SELECTCASE PET:92
					CASE 1
						BASE:(PET:51):0 += LOCAL:1
						SIF BASE:(PET:51):0 > MAXBASE:(PET:51):0
							BASE:(PET:51):0 = MAXBASE:(PET:51):0
					CASE 2
						BASE:(PET:51):1 += LOCAL:1
						SIF BASE:(PET:51):1 > MAXBASE:(PET:51):1
							BASE:(PET:51):1 = MAXBASE:(PET:51):1
					CASE 3
						BASE:(PET:51):4 += LOCAL:1
						SIF BASE:(PET:51):4 > MAXBASE:(PET:51):4
							BASE:(PET:51):4 = MAXBASE:(PET:51):4
				ENDSELECT
				SIF PET:98
					TRYCALLFORM PET_EXTRA_ACTION_{PET:98}
			ENDIF
			;三人目（いる場合）
			IF FLAG:11
				PET:51 = FLAG:11
				PRINTFORM %CALLNAME:(PET:51)%の
				SELECTCASE PET:92
					CASE 1
						PRINT HPが
					CASE 2 
						PRINT MPが
					CASE 3
						PRINT TPが
				ENDSELECT
				SETCOLOR 0x70FFFF
				PRINTFORM {LOCAL:1}
				RESETCOLOR
				PRINTFORML 回復！
				SELECTCASE PET:92
					CASE 1
						BASE:(PET:51):0 += LOCAL:1
						SIF BASE:(PET:51):0 > MAXBASE:(PET:51):0
							BASE:(PET:51):0 = MAXBASE:(PET:51):0
					CASE 2
						BASE:(PET:51):1 += LOCAL:1
						SIF BASE:(PET:51):1 > MAXBASE:(PET:51):1
							BASE:(PET:51):1 = MAXBASE:(PET:51):1
					CASE 3
						BASE:(PET:51):4 += LOCAL:1
						SIF BASE:(PET:51):4 > MAXBASE:(PET:51):4
							BASE:(PET:51):4 = MAXBASE:(PET:51):4
				ENDSELECT
				SIF PET:98
					TRYCALLFORM PET_EXTRA_ACTION_{PET:98}
			ENDIF
		ENDIF
	;全体フラグなし
	ELSE
		;攻撃する場合
		IF PET:92 == 0
			PRINTFORML 命中率:{LOCAL:3}％
			;クリティカルヒットの処理
			IF RAND:100 < 2 + PET:13 / 3
				SETCOLOR 255, 255, 0
				PRINTFORML クリティカルヒット！
				RESETCOLOR
				LOCAL:1 = LOCAL:1 * 3
				LOCAL:3 += 100
				LOCAL:5 = 1
			ENDIF
			IF RAND:100 > LOCAL:3
				PRINTFORML 外した！
				CONTINUE
			ENDIF
			PRINTFORM %SAVESTR:(PET:51)%に
			SETCOLOR 0x70FFFF
			PRINTFORM {LOCAL:1}
			RESETCOLOR
			PRINTFORML のダメージ！
			DA:(PET:51):1 -= LOCAL:1
			;ダメージによる拘束キャラ救出判定
			IF DA:(PET:51):1 > 0 && (DA:(PET:51):10 || DA:(PET:51):20)
				LOCAL:4 = 2 + LIMIT((LOCAL * 51 / DA:(PET:51):2), 1, 10) + LIMIT((DA:(PET:51):1 * 10 / DA:(PET:51):2), 0, 5)
				IF RAND:100 < LOCAL:4
					CALL STATUS_RENEW_RELEASE(DA:(PET:51):10, 0, 2)
					CALL STATUS_RENEW_RELEASE(DA:(PET:51):20, 0, 2)
				ENDIF
			ENDIF
			IF LOCAL:5 == 1
				LOCAL:1 = LOCAL:1 / 3
				LOCAL:3 -= 100
				LOCAL:5 = 0
			ENDIF
			SIF PET:98
				TRYCALLFORM PET_EXTRA_ACTION_{PET:98}
		ELSEIF PET:92 >= 1
			PRINTFORM %CALLNAME:(PET:51)%の
			SELECTCASE PET:92
				CASE 1
					PRINT HPが
				CASE 2 
					PRINT MPが
				CASE 3
					PRINT TPが
			ENDSELECT
			SETCOLOR 0x70FFFF
			PRINTFORM {LOCAL:1}
			RESETCOLOR
			PRINTFORML 回復！
			SELECTCASE PET:92
				CASE 1
					BASE:(PET:51):0 += LOCAL:1
					SIF BASE:(PET:51):0 > MAXBASE:(PET:51):0
						BASE:(PET:51):0 = MAXBASE:(PET:51):0
				CASE 2
					BASE:(PET:51):1 += LOCAL:1
					SIF BASE:(PET:51):1 > MAXBASE:(PET:51):1
						BASE:(PET:51):1 = MAXBASE:(PET:51):1
				CASE 3
					BASE:(PET:51):4 += LOCAL:1
					SIF BASE:(PET:51):4 > MAXBASE:(PET:51):4
						BASE:(PET:51):4 = MAXBASE:(PET:51):4
			ENDSELECT
			SIF PET:98
				TRYCALLFORM PET_EXTRA_ACTION_{PET:98}
		ENDIF
	ENDIF
NEXT

;ペットの攻撃で敵が死亡
IF PET:92 == 0 && DA:(PET:51):1 <= 0
	;主人公が倒した扱い
	CALL PRINT_MESSAGE(1, 31, PET:51, CALLNAME:1, SAVESTR:(PET:51))
	DA:(LOCAL:(LOCAL:0)):1 = 0
	
	CALL CHECK_DEFEAT_ENEMY_IN_BATTLE(PET:51)
ENDIF
;-------------
;数字をどうこうする処理終わり
;-------------

;-------------
;好感度変化
;-------------
SELECTCASE PET_LIKE()
	CASE 3
		PET:22 -= 3 + RAND:3
	CASE 2
		PET:22 -= 3 + RAND:2
	CASE 1
		PET:22 -= 2 + RAND:2
	CASE 0
		PET:22 -= 1
ENDSELECT
;-------------
;好感度変化終わり
;-------------

CALLFORM LIMIT_PET_STATUS
