;ドッペルとの会話
;ARG:0	対象敵ID
@TALK_3(ARG:0)
#DIM WHAT_DO
;LOCAL
;0	LOOP
;1	化けている対象
;2	TEMP

LOCAL:1 = GET_DOPPEL_BASE(ARG:0)

PRINTFORML 迷宮の中を進んでいくと、
SIF CFLAG:(LOCAL:1):43
	PRINTFORM 催眠状態の

TRYCALL PRINT_SHOW_CLOTH(LOCAL:1)

PRINTFORM %SAVESTR:(ARG:0)%  (戦闘素質 {ABL:(LOCAL:1):98, 2} / 速度 {ABL:(LOCAL:1):97, 2})  と出会った
PRINTFORML 

;【覚】による読心
IF TALENT:1:94 && CFLAG:1:29 == 0 && (CFLAG:1:28 == 0 || RAND:2 == 0)
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 0)
ELSEIF FLAG:10 && TALENT:(FLAG:10):94 && CFLAG:(FLAG:10):29 == 0 && (CFLAG:(FLAG:10):28 == 0 || RAND:2 == 0)
	CALL PRINT_MESSAGE(FLAG:10, 168, LOCAL:1, CALLNAME:(FLAG:10), SAVESTR:(ARG:0), 0)
ELSEIF FLAG:11 && TALENT:(FLAG:11):94 && CFLAG:(FLAG:11):29 == 0 && (CFLAG:(FLAG:11):28 == 0 || RAND:2 == 0)
	CALL PRINT_MESSAGE(FLAG:11, 168, LOCAL:1, CALLNAME:(FLAG:11), SAVESTR:(ARG:0), 0)
;自力で見抜く
ELSEIF ABL:1:1 >= 3 && ABL:1:2 >= 3 && ABL:1:5 >= 3 && CFLAG:1:29 == 0 && (CFLAG:1:28 == 0 || RAND:3 == 0)
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 1)
;子供の同族探知１
ELSEIF FLAG:10 && CFLAG:(FLAG:10):104 && CFLAG:(FLAG:10):29 == 0 && RAND:4 == 0
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 2)
	CALL PRINT_MESSAGE(FLAG:10, 168, LOCAL:1, CALLNAME:(FLAG:10), SAVESTR:(ARG:0), 4)
;子供の同族探知２
ELSEIF FLAG:11 && CFLAG:(FLAG:11):104 && CFLAG:(FLAG:11):29 == 0 && RAND:4 == 0
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 3)
	CALL PRINT_MESSAGE(FLAG:11, 168, LOCAL:1, CALLNAME:(FLAG:11), SAVESTR:(ARG:0), 4)
;自力で見抜く２
ELSEIF (ABL:1:2 >= 3 || ABL:1:5 >= 3) && CFLAG:1:29 == 0 && RAND:8 == 0
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 1)
;仲間が見抜く１
ELSEIF FLAG:10 && (ABL:(FLAG:10):2 >= 3 || ABL:(FLAG:10):5 >= 3) && CFLAG:(FLAG:10):29 == 0 && RAND:8 == 0
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 2)
	CALL PRINT_MESSAGE(FLAG:10, 168, LOCAL:1, CALLNAME:(FLAG:10), SAVESTR:(ARG:0), 5)
;仲間が見抜く２
ELSEIF FLAG:11 && (ABL:(FLAG:11):2 >= 3 || ABL:(FLAG:11):5 >= 3) && CFLAG:(FLAG:11):29 == 0 && RAND:8 == 0
	CALL PRINT_MESSAGE(1, 168, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 3)
	CALL PRINT_MESSAGE(FLAG:11, 168, LOCAL:1, CALLNAME:(FLAG:11), SAVESTR:(ARG:0), 5)
;気付かない……
ELSE
	CALL PRINT_MESSAGE(1, 101, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0))
ENDIF

IF FLAG:AUTOMODE
	TWAIT FLAG:AUTOMODE * 500, 0
ELSE
	WAIT
ENDIF

;アイテムを差し出せる判定
LOCAL:4 = 0
IF BASE:(LOCAL:1):0 < MAXBASE:(LOCAL:1):0 / 2
	LOCAL:5 = 50
	LOCAL:6 = 51
	SETBIT LOCAL:4, 0
ELSE
	LOCAL:5 = 0
	LOCAL:6 = 0
ENDIF
IF BASE:(LOCAL:1):1 < MAXBASE:(LOCAL:1):1 / 2
	LOCAL:7 = 52
	LOCAL:8 = 53
	SETBIT LOCAL:4, 1
ELSE
	LOCAL:7 = 0
	LOCAL:8 = 0
ENDIF
IF BASE:(LOCAL:1):3 <= 0
	LOCAL:9 = 54
	SETBIT LOCAL:4, 2
ELSE
	LOCAL:9 = 0
ENDIF
IF CFLAG:(LOCAL:1):22 && CFLAG:(LOCAL:1):36 == 0
	LOCAL:10 = 57
	SETBIT LOCAL:4, 3
ELSE
	LOCAL:10 = 0
ENDIF
IF GET_PENIS(LOCAL:1)
	LOCAL:11 = 55
ELSE
	LOCAL:11 = 0
ENDIF

$TALK_START


;遭遇相手の様子
CALL TALK_LOOK(LOCAL:1)

PRINTFORML どうしますか？
PRINTFORML [1] 雑談して気を紛らわせる
PRINTFORML [2] 情報交換を行う
PRINTFORML [3] 何か貰えないか聞いてみる
IF FLAG:11 == 0
	;3人目まで埋まってないなら誘える
	LOCAL:2 = 1
	PRINTFORML [4] 仲間に誘う
ELSE
	LOCAL:2 = 0
ENDIF
IF GETBIT(LOCAL:4, 0) && ITEM:50
	PRINTFORML [ 5] %ITEMNAME:50%(残り{ITEM:50}個)をあげる
ELSE
	LOCAL:5 = 0
ENDIF
IF GETBIT(LOCAL:4, 0) && ITEM:51
	PRINTFORML [ 6] %ITEMNAME:51%(残り{ITEM:51}個)をあげる
ELSE
	LOCAL:6 = 0
ENDIF
IF GETBIT(LOCAL:4, 1) && ITEM:52
	PRINTFORML [ 7] %ITEMNAME:52%(残り{ITEM:52}個)をあげる
ELSE
	LOCAL:7 = 0
ENDIF
IF GETBIT(LOCAL:4, 1) && ITEM:53
	PRINTFORML [ 8] %ITEMNAME:53%(残り{ITEM:53}個)をあげる
ELSE
	LOCAL:8 = 0
ENDIF
IF GETBIT(LOCAL:4, 2) && ITEM:54
	PRINTFORML [ 9] %ITEMNAME:54%(残り{ITEM:54}個)をあげる
ELSE
	LOCAL:9 = 0
ENDIF
IF GETBIT(LOCAL:4, 3) && ITEM:57
	PRINTFORML [10] %ITEMNAME:57%(残り{ITEM:57}個)をあげる
ELSE
	LOCAL:10 = 0
ENDIF
IF GET_PENIS(LOCAL:1) && ITEM:55
	PRINTFORML [11] %ITEMNAME:55%(残り{ITEM:55}個)をあげる
ELSE
	LOCAL:11 = 0
ENDIF

PRINTFORML [12] 装備品をプレゼントする

SIF TALENT:(LOCAL:1):130 >= 1
	PRINTFORML [13] 乳搾り

;催眠術による追加コマンド
IF ( CFLAG:1:7 == 40 || CFLAG:1:8 == 40 || CFLAG:1:9 == 40 || CFLAG:(FLAG:10):7 == 40 || CFLAG:(FLAG:10):8 == 40 || CFLAG:(FLAG:10):9 == 40 || CFLAG:(FLAG:11):7 == 40 || CFLAG:(FLAG:11):8 == 40 || CFLAG:(FLAG:11):9 == 40 )
	IF !CFLAG:(LOCAL:1):43
		PRINTFORML [15] 催眠をかける
	ELSEIF CFLAG:(LOCAL:1):43
		PRINTFORML [15] 催眠を解く
	ENDIF
ENDIF
IF CFLAG:(LOCAL:1):25 > 0 || CFLAG:(LOCAL:1):43
	;主人公がふたなりで、仲間がいないか全員戦意喪失かふたなりだと犯せる
	SIF GET_PENIS(1) &&	(FLAG:520 == 2 || (FLAG:10 == 0 || (FLAG:11 == 0 && (CFLAG:(FLAG:10):29 || GET_PENIS(FLAG:10))) || ((CFLAG:(FLAG:10):29 || GET_PENIS(FLAG:10)) && (CFLAG:(FLAG:11):29 || GET_PENIS(FLAG:11)))))
		PRINTFORML [16] 性欲を発散する
	SIF ITEM:8 && ITEM:88 >= 10
		PRINTFORML [17] %ITEMNAME:8%を使う
ENDIF
IF CFLAG:(LOCAL:1):43
	PRINTFORML [18] 視姦する
	IF CFLAG:1:29 == 0
		PRINTFORML [19] 罵倒してもらう
		PRINTFORML [20] 踏んでもらう
	ENDIF
ENDIF
IF (LOCAL:7 && ITEM:52 > 0) ||(LOCAL:8 && ITEM:53 > 0) && ITEM:65 > 0
	PRINTFORML [21] 酒に胡蝶夢丸ナイトメアを仕込む
ENDIF
SIF GET_PENIS(LOCAL:1)
	PRINTFORML [22] ふたなりを治療する
SIF CFLAG:1:29 == 0 && ABL:1:13 > 0
	PRINTFORML [30] キスをする

PRINTFORML [110] 能力を見る

PRINTFORML [0] 何もせず別れを告げる


$INPUT_LOOP

IF FLAG:AUTOMODE
	
	WHAT_DO = 0
	SELECTCASE RAND:3
		CASE 0
			WHAT_DO = 1
		CASE 1
			WHAT_DO = 2
		CASE 2
			IF FLAG:11
				WHAT_DO = 3
			ELSE
				WHAT_DO = 4
			ENDIF
			
		CASEELSE
			WHAT_DO = 0
	ENDSELECT
	TINPUT FLAG:AUTOMODE * 1000, WHAT_DO, 0, ""
ELSE
	INPUT
ENDIF

IF RESULT == 0
	;ドッペル警戒、および恨まれてる相手の回避はこれ
	CALL PRINT_MESSAGE(1, 102, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0))
	RETURN 0
ELSEIF ( RESULT >= 1 && RESULT <= 3 ) || (RESULT == 4 && LOCAL:2) || RESULT >= 13 
	CALL PRINT_MESSAGE(LOCAL:1, 142, 0, CALLNAME:1, SAVESTR:(ARG:0), 1)
	CALL PRINT_MESSAGE(1, 141, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), 1)
	DA:(ARG:0):45 = 1
	PRINTFORML %SAVESTR:(ARG:0)%はドッペルゲンガーが化けた偽者だった！
	CALL PRE_BATTLE(4)
	RETURN RESULT
ELSEIF RESULT == 9
	LOCAL:3 = LOCAL:(RESULT)
	PRINTFORML %CALLNAME:1%%TACHI()%は%SAVESTR:(ARG:0)%に%ITEMNAME:(LOCAL:3)%を渡した！
	CALL ADD_ITEM(LOCAL:3, -1, 0)
	CALL PRINT_MESSAGE(1, 163, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), LOCAL:3, 1)
	CALL PRINT_MESSAGE(LOCAL:1, 164, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), LOCAL:3, 1)
ELSEIF RESULT >= 5 && RESULT <= 11 && LOCAL:(RESULT)
	LOCAL:3 = LOCAL:(RESULT)
	PRINTFORML %CALLNAME:1%%TACHI()%は%SAVESTR:(ARG:0)%に%ITEMNAME:(LOCAL:3)%を渡した！
	CALL ADD_ITEM(LOCAL:3, -1, 0)
	CALL PRINT_MESSAGE(1, 163, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), LOCAL:3, 1)
	CALL PRINT_MESSAGE(LOCAL:1, 164, LOCAL:1, CALLNAME:1, SAVESTR:(ARG:0), LOCAL:3, 1)
	SELECTCASE LOCAL:3
		CASE 50
			CLEARBIT LOCAL:4, 0
		CASE 51
			CLEARBIT LOCAL:4, 0
		CASE 52
			CLEARBIT LOCAL:4, 1
		CASE 53
			CLEARBIT LOCAL:4, 1
		CASE 54
			CLEARBIT LOCAL:4, 2
		CASE 57
			CLEARBIT LOCAL:4, 3
		CASEELSE
	ENDSELECT
	GOTO TALK_START
ELSEIF RESULT == 12
	CALL PRESENT(LOCAL:1, 1)
	GOTO TALK_START
ELSE
	REUSELASTLINE 入力値が不正です。再入力してください
	GOTO INPUT_LOOP
ENDIF
