;フェイズごとの寄生チェック尻Ver
;ARG:0	対象キャラ
@CHECK_A_PARASITE(ARG:0)
#DIM MP_DECREASE_RATE
;LOCAL
;0	LOOP
;1	メッセージ表示フラグ
;2	
;3	
;5	ウォッチャーチェック
;11	ウォッチャーがいる

SIF CFLAG:(ARG:0):151 <= 0
	RETURN
;リタイアしてるなら黙る
SIF CFLAG:(ARG:0):2
	RETURN

;主人公と場所が違うかチェック
IF CFLAG:(ARG:0):4 != CFLAG:1:4
	LOCAL:1 = 0
ELSE
	LOCAL:1 = 1
ENDIF
IF CFLAG:(ARG:0):154 >= 3
	CFLAG:(ARG:0):151 = 0
	CFLAG:(ARG:0):152 = 0
	CFLAG:(ARG:0):154 -= 3
	IF LOCAL:1
		IF FLAG:AUTOMODE
			PRINTFORML 卵破壊の札が体内の異物を浄化したようだ
			TWAIT FLAG:AUTOMODE * 200, 0
		ELSE
			PRINTFORMW 卵破壊の札が体内の異物を浄化したようだ
		ENDIF
	ENDIF
	RETURN
ENDIF
CFLAG:(ARG:0):152 -= 1

;産卵ありかどうかで分岐　服がそのままだったり通常の寄生よりは比較的穏やか
IF LOCAL:1
	IF CFLAG:(ARG:0):152 >= 1
		IF FLAG:533
			CALL PRINT_MESSAGE(ARG:0, 221, CFLAG:(ARG:0):152, CALLNAME:(ARG:0), "")
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != ARG:0
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 222, CFLAG:(ARG:0):152, CALLNAME:(ARG:0), "", ARG:0)
			NEXT
		ELSE
			CALL PRINT_MESSAGE(ARG:0, 225, CFLAG:(ARG:0):152, CALLNAME:(ARG:0), "")
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != ARG:0
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 226, CFLAG:(ARG:0):152, CALLNAME:(ARG:0), "", ARG:0)
			NEXT
		ENDIF

	ENDIF
ENDIF

;産卵
IF CFLAG:(ARG:0):152 <= 0
	;ウォッチャーのチェック
	FOR LOCAL:5 , 1, FLAG:1
		;ウォッチャーだとフラグ
		IF DA:(LOCAL:5):0 == 97
			DA:(LOCAL:5):4 = CFLAG:(ARG:0):4
			LOCAL:11 += 1
			BREAK
		ENDIF
	NEXT

	IF LOCAL:1 || LOCAL:11
		;ウォッチャーがいる場合ライブ中継
		IF FLAG:533
			IF LOCAL:11
				CALL PRINT_MESSAGE(ARG:0, 127, 4, CALLNAME:(ARG:0), "", LOCAL:2)
			ENDIF
			CALL PRINT_MESSAGE(ARG:0, 223, 0, CALLNAME:(ARG:0), "")
			IF LOCAL:1
				FOR LOCAL:0, 0, 3
					SIF GET_MEMBER(LOCAL:0) != ARG:0
						CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 224, 0, CALLNAME:(ARG:0), "", ARG:0)
				NEXT
			ENDIF
		ELSE
			IF LOCAL:11
				CALL PRINT_MESSAGE(ARG:0, 127, 4, CALLNAME:(ARG:0), "", LOCAL:2)
			ENDIF
			CALL PRINT_MESSAGE(ARG:0, 227, 0, CALLNAME:(ARG:0), "")
			IF LOCAL:1
				FOR LOCAL:0, 0, 3
					SIF GET_MEMBER(LOCAL:0) != ARG:0
						CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 228, 0, CALLNAME:(ARG:0), "", ARG:0)
				NEXT
			ENDIF
		ENDIF
		;汚染度が高いと出産の隙を触手が狙う
		IF (FLAG:(FLAG:5 + 50) + RAND:70) >= 100
			IF FLAG:533
				CALL PRINT_MESSAGE(ARG:0, 223, 4, CALLNAME:(ARG:0), "")
			ELSE
				CALL PRINT_MESSAGE(ARG:0, 227, 3, CALLNAME:(ARG:0), "")
			ENDIF
			FOR LOCAL:0, 0, 3
				LOCAL:2 = RAND:4
				LOCAL:3 = 300 + RAND:401
				CALL ADD_ABL_EXP(LOCAL:2 + 6, ARG:0, 100 + RAND:100)
				CALL DOUKA_EFFECT_4(ARG)
				IF RESULT > 0
					MP_DECREASE_RATE = RESULT:1
				ELSE
					MP_DECREASE_RATE = 300
				ENDIF
				TFLAG:63 = LOCAL:2
				CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:3, MP_DECREASE_RATE, 1)
				TFLAG:63 = 0
			NEXT
		ENDIF
		
		MP_DECREASE_RATE = 3000
		;卵生や産卵体質ならペナルティ軽減
		IF TALENT:(ARG:0):135 == 1 && TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 5
		ELSEIF TALENT:(ARG:0):135 == 1 || TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 2
		ENDIF
		CALL EXTASY(ARG:0, 0, 400, MP_DECREASE_RATE)
		IF FLAG:533
			CALL PRINT_MESSAGE(ARG:0, 223, 1, CALLNAME:(ARG:0), "")
		ELSE
			CALL PRINT_MESSAGE(ARG:0, 227, 1, CALLNAME:(ARG:0), "")
		ENDIF

		FOR LOCAL:0, 0, 3
			IF GET_MEMBER(LOCAL:0) != ARG:0
				IF FLAG:533
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 224, 1, CALLNAME:(ARG:0), "")
				ELSE
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 228, 1, CALLNAME:(ARG:0), "")
				ENDIF
			ENDIF
		NEXT
		CALL ADD_ABL_EXP(11, ARG:0, 100)
		IF FLAG:533
			CALL PRINT_MESSAGE(ARG:0, 223, 2, CALLNAME:(ARG:0), "")
		ELSE
			CALL PRINT_MESSAGE(ARG:0, 227, 2, CALLNAME:(ARG:0), "")
		ENDIF
		FOR LOCAL:0, 0, 3
			IF GET_MEMBER(LOCAL:0) != ARG:0
				IF FLAG:533
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 224, 2, CALLNAME:(ARG:0), "")
				ELSE
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 228, 2, CALLNAME:(ARG:0), "")
				ENDIF
			ENDIF
		NEXT
	ELSE
		;非表示の場合でも、MP減少などの処理は入れておく
		FLAG:20 = 1
		;汚染度が高いと出産の隙を触手が狙う
		IF (FLAG:(FLAG:5 + 50) + RAND:70) >= 100
			FOR LOCAL:0, 0, 3
				LOCAL:2 = RAND:4
				LOCAL:3 = 300 + RAND:401
				CALL ADD_ABL_EXP(LOCAL:2 + 6, ARG:0, 100 + RAND:100)
				CALL DOUKA_EFFECT_4(ARG)
				IF RESULT > 0
					MP_DECREASE_RATE = RESULT:1
				ELSE
					MP_DECREASE_RATE = 300
				ENDIF
				TFLAG:63 = LOCAL:2
				CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:3, MP_DECREASE_RATE, 1)
				TFLAG:63 = 0
			NEXT
		ENDIF
		MP_DECREASE_RATE = 3000 * (50 + FLAG:4 * 10) / 100
		;卵生や産卵体質ならペナルティ軽減
		IF TALENT:(ARG:0):135 == 1 && TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 5
		ELSEIF TALENT:(ARG:0):135 == 1 || TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 2
		ENDIF
		CALL EXTASY(ARG:0, 0, 400, MP_DECREASE_RATE)
		CALL ADD_ABL_EXP(11, ARG:0, 100)
		FLAG:20 = 0
	ENDIF
ENDIF

IF CFLAG:(ARG:0):152 <= 0
	;生まれた場合の共通処理
	CALL ADD_FEELING(ARG:0, -10)
	;卵生や産卵体質ならペナルティ軽減
	IF TALENT:(ARG:0):135 == 1 && TALENT:(ARG:0):136 == 1
		BASE:(ARG:0):0 /= 2
	ELSEIF TALENT:(ARG:0):135 == 1 || TALENT:(ARG:0):136 == 1
		BASE:(ARG:0):0 /= 6
	ELSE
		BASE:(ARG:0):0 = 0
	ENDIF

	SIF CFLAG:(ARG:0):44 != 1
		CFLAG:(ARG:0):44 = 1
	
	;貞操帯破壊
	SIF CFLAG:(ARG:0):47 == 1
		CFLAG:(ARG:0):47 = 0

	BASE:(ARG:0):4 = 0

	;ED用
	IF EXP:(ARG:0):22 == 0
		CALL ADD_HISTORY(DAY, ARG:0, CFLAG:(ARG:0):151, 3)
	ENDIF

	CALL CREATE_ENEMY(CFLAG:(ARG:0):151, 0, FLAG:5, ARG:0)
	CFLAG:(ARG:0):151 = 0
	CFLAG:(ARG:0):152 = 0

	;産卵回数追加
	IF FLAG:533
		EXP:(ARG:0):23 += 1
	ELSE
		EXP:(ARG:0):22 += 1
	ENDIF
	;産卵体質入手
	IF TALENT:(ARG:0):136 == 0 && FLAG:533 && EXP:(ARG:0):23 >= 5 && RAND:2 == 0
		CALL PRINT_MESSAGE(ARG:0, 223, 3, CALLNAME:(ARG:0), "")
		TALENT:(ARG:0):136 = 1
	ENDIF

ENDIF

