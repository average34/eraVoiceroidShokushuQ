;フェイズごとの妊娠チェックふたなりVer

;とりあえず玉のみ　竿はそのうち追加
;妊娠中は射精不可の絶頂発生
;玉は2つあるのでC寄生とC妊娠は同時に可能

;ARG:0	対象キャラ
@CHECK_C_NINSIN(ARG:0)
#DIM MP_DECREASE_RATE
;LOCAL
;0	LOOP
;1	メッセージ表示フラグ
;2	
;3	
;5	ウォッチャーチェック
;11	ウォッチャーがいる

SIF CFLAG:(ARG:0):173 <= 0
	RETURN
;リタイアしてるなら黙る
SIF CFLAG:(ARG:0):2
	RETURN

;主人公と場所が違うかチェック
IF CFLAG:(ARG:0):4 != CFLAG:1:4
	LOCAL:1 = 0
ELSE
	LOCAL:1 = 1
ENDIF

CFLAG:(ARG:0):174 -= 1

IF LOCAL:1
	IF CFLAG:(ARG:0):174 >= 1
		CALL PRINT_MESSAGE(ARG:0, 552, CFLAG:(ARG:0):174, CALLNAME:(ARG:0), "")
		FOR LOCAL:0, 0, 3
			SIF GET_MEMBER(LOCAL:0) != ARG:0
				CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 553, CFLAG:(ARG:0):174, CALLNAME:(ARG:0), "", ARG:0)
		NEXT
	ENDIF
	;妊娠している間は精力増強と強制絶頂
	IF GET_PENIS(ARG:0) == 1
		CFLAG:(ARG:0):42 += 5
	ELSEIF CFLAG:(ARG:0):28 < 4
		CFLAG:(ARG:0):28 += 1
	ENDIF
	CALL EXTASY(ARG:0, 2, 5, 100, 0)
ENDIF

;出産
IF CFLAG:(ARG:0):174 <= 0
	;ウォッチャーのチェック
	FOR LOCAL:5 , 1, FLAG:1
		;ウォッチャーだとフラグ
		IF DA:(LOCAL:5):0 == 97
			DA:(LOCAL:5):4 = CFLAG:(ARG:0):4
			LOCAL:11 += 1
			BREAK
		ENDIF
	NEXT

	IF LOCAL:1 || LOCAL:11
		;ウォッチャーがいる場合ライブ中継
			IF LOCAL:11
				CALL PRINT_MESSAGE(ARG:0, 127, 4, CALLNAME:(ARG:0), "", LOCAL:2)
			ENDIF
			CALL PRINT_MESSAGE(ARG:0, 554, 0, CALLNAME:(ARG:0), "")
			IF LOCAL:1
				FOR LOCAL:0, 0, 3
					SIF GET_MEMBER(LOCAL:0) != ARG:0
						CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 555, 0, CALLNAME:(ARG:0), "", ARG:0)
				NEXT
			ENDIF

		CALL PRINT_MESSAGE(ARG:0, 554, 1, CALLNAME:(ARG:0), "")
		;産卵時射精させるためこのタイミングで寄生フラグ解除
		CALL CREATE_ENEMY(CFLAG:(ARG:0):173, 0, FLAG:5, ARG:0)
		CFLAG:(ARG:0):173 = 0
		CFLAG:(ARG:0):174 = 0

		;汚染度が高いと出産の隙を触手が狙う
		IF (FLAG:(FLAG:5 + 50) + RAND:70) >= 100
			CALL PRINT_MESSAGE(ARG:0, 554, 3, CALLNAME:(ARG:0), "")
			FOR LOCAL:0, 0, 3
				LOCAL:2 = 2
				LOCAL:3 = 10000
				CALL ADD_ABL_EXP(LOCAL:2 + 6, ARG:0, 100 + RAND:100)
				IF RESULT > 0
					MP_DECREASE_RATE = RESULT:1
				ELSE
					MP_DECREASE_RATE = 300
				ENDIF
				TFLAG:63 = LOCAL:2
				CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:3, MP_DECREASE_RATE, 1)
				TFLAG:63 = 0
			NEXT
		ENDIF

		MP_DECREASE_RATE = 3000

		CALL EXTASY(ARG:0, 2, 400, MP_DECREASE_RATE)

		FOR LOCAL:0, 0, 3
			IF GET_MEMBER(LOCAL:0) != ARG:0
				CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 555, 1, CALLNAME:(ARG:0), "")
			ENDIF
		NEXT
		CALL ADD_ABL_EXP(11, ARG:0, 100)
		CALL PRINT_MESSAGE(ARG:0, 554, 2, CALLNAME:(ARG:0), "")
		FOR LOCAL:0, 0, 3
			IF GET_MEMBER(LOCAL:0) != ARG:0
				CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 555, 2, CALLNAME:(ARG:0), "")
			ENDIF
		NEXT
	ELSE
		;非表示の場合でも、MP減少などの処理は入れておく
		FLAG:20 = 1

		;産卵時射精させるためこのタイミングで寄生フラグ解除
		CALL CREATE_ENEMY(CFLAG:(ARG:0):173, 0, FLAG:5, ARG:0)
		CFLAG:(ARG:0):173 = 0
		CFLAG:(ARG:0):174 = 0

		;汚染度が高いと出産の隙を触手が狙う
		IF (FLAG:(FLAG:5 + 50) + RAND:70) >= 100
			FOR LOCAL:0, 0, 3
				LOCAL:2 = 2
				LOCAL:3 = 10000
				CALL ADD_ABL_EXP(LOCAL:2 + 6, ARG:0, 100 + RAND:100)
				IF RESULT > 0
					MP_DECREASE_RATE = RESULT:1
				ELSE
					MP_DECREASE_RATE = 300
				ENDIF
				TFLAG:63 = LOCAL:2
				CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:3, MP_DECREASE_RATE, 1)
				TFLAG:63 = 0
			NEXT
		ENDIF

		MP_DECREASE_RATE = 3000 * (50 + FLAG:4 * 10) / 100
		CALL EXTASY(ARG:0, 2, 400, MP_DECREASE_RATE)
		CALL ADD_ABL_EXP(11, ARG:0, 100)
		FLAG:20 = 0
	ENDIF
ENDIF

IF CFLAG:(ARG:0):174 <= 0
	;生まれた場合の共通処理
	CALL ADD_FEELING(ARG:0, -10)
	BASE:(ARG:0):0 = 0
	BASE:(ARG:0):4 = 0

	;ED用
	IF EXP:(ARG:0):22 == 0
		CALL ADD_HISTORY(DAY, ARG:0, CFLAG:(ARG:0):173, 3)
	ENDIF

	;出産回数追加
	EXP:(ARG:0):22 += 1

	;玉ありのコンフィグなら肥大化
	IF TALENT:(ARG:0):180 < 4 && FLAG:580 && RAND:2 == 0
		TALENT:(ARG:0):180 += 1
		CALL PRINT_MESSAGE(ARG:0, 550, 0, CALLNAME:(ARG:0), "")
	ENDIF

ENDIF

