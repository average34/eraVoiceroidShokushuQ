;各フェイズの終了処理
;ARG:0	探索スキップフラグ（1が指定されている場合、探索無視）
@END_PHASE(ARG:0)
#DIM LCOUNT,3	;ループ用
;LOCAL	キャラID

;女体化魔法陣を一時的に出現させる
SIF FLAG:181 == 0
	FLAG:181 = RAND:30 + 1


;探索を行っていた場合、探索チェック
IF CFLAG:1:11 == 3 && ARG:0 == 0
	CALL SEARCH_EVENT
	;キャラデータがリセットされている＝クリアした場合、処理中断
	SIF CHARANUM < 2
		RETURN 1
ENDIF


;HPが0になった敵を削除 内部でFLAG:1が変わるので後ろから見ていく
FOR LCOUNT, FLAG:1 - 1, 0, -1
	FLAG:210 = 0
	FLAG:211 = 0
	SIF DA:(LCOUNT):1 <= 0
		CALL DELETE_ENEMY(LCOUNT)
NEXT

;捕食されている味方の処理
FOR LCOUNT, 1, CHARANUM
	CALL PREDATION(LCOUNT)
NEXT

;寄生処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_PARASITE(LCOUNT)
NEXT

;妊娠処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_NINSHIN(LCOUNT)
NEXT

;A寄生処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_A_PARASITE(LCOUNT)
NEXT

;B寄生処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_B_PARASITE(LCOUNT)
NEXT

;C寄生処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_C_PARASITE(LCOUNT)
NEXT

;C妊娠処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_C_NINSIN(LCOUNT)
NEXT

;寄生侵食処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_PARASITE_SINSHOKU(LCOUNT)
NEXT

;媚薬爆弾処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_PARASITE_BOMB(LCOUNT)
NEXT

;同化自然回復
FOR LOCAL:0, 1, CHARANUM
	CALL DOUKA_PROGRESS_2(LOCAL:0)
NEXT

;触手包帯処理
FOR LCOUNT, 1, CHARANUM
	IF CFLAG:(LCOUNT):46
		CALL SHOW_TUTORIAL(21)
	ENDIF
	CALL CHECK_SYOKUSYUHOUTAI(LCOUNT)
NEXT

;スライム服処理
FOR LCOUNT, 1, CHARANUM
	IF CFLAG:(LCOUNT):48
		CALL SHOW_TUTORIAL(21)
	ENDIF
	CALL CHECK_SLIMESUIT(LCOUNT)
NEXT

;触手スーツ処理
FOR LCOUNT, 1, CHARANUM
	IF CFLAG:(LCOUNT):37
		CALL SHOW_TUTORIAL(21)
	ENDIF
	CALL CHECK_SYOKUSYUSUIT(LCOUNT)
NEXT

;悪堕ち処理
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_AKUOCHI(LCOUNT)
NEXT

;ウォッチャーチェック
FOR LCOUNT, 1, CHARANUM
	CALL WATCHER(LCOUNT)
NEXT

;悲鳴処理
;NPCのみ処理 主人公(ID.1)は除外
FOR LCOUNT, 2, CHARANUM
	CALL NPC_SCREAM(LCOUNT)
NEXT

;放置プレイチェック
FOR LCOUNT, 1, CHARANUM
	CALL LEAVE_PLAY(LCOUNT)
NEXT

;リタイア処理
FOR LCOUNT, 1, CHARANUM
	CALL RETIRE(LCOUNT)
	;ゲームオーバーになったので処理中断
	SIF RESULT == 1		
		RETURN 1
NEXT

;母乳製造装置チェック
FOR LCOUNT, 1, CHARANUM
	IF TALENT:(LCOUNT):130
		CALL SHOW_TUTORIAL(19)
	ENDIF
	IF TALENT:(LCOUNT):130 >= 3
		CALL CHECK_GROW_BUST(LCOUNT)
	ENDIF
NEXT

;【覚】の消耗チェック
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_SATORIDESCARTES(LCOUNT)
NEXT

;新キャラ迷い込み
CALL TURIZAO_R

;ふたなりカスタマイズ
FOR LCOUNT, 1, CHARANUM
	IF !FLAG:590
		CALL FUTANARI_CUSTOMIZE_GET_2(LCOUNT)
	ELSEIF FLAG:590 == 2
		CALL FUTANARI_RANDOM_GET_2(LCOUNT)
	ENDIF
NEXT

;卵巣成長チェック
FOR LCOUNT, 1, CHARANUM
	SIF FLAG:535 == 1
		CALL CHECK_GROW_OVARY(LCOUNT)
NEXT

;【しもべ】への改造
FOR LCOUNT, 1, CHARANUM
	CALL CHECK_SERVANT(LCOUNT)
NEXT

;喪失キャラの捕食開始処理
FOR LCOUNT, 1, FLAG:1
	CALL START_PREDATION(LCOUNT)
NEXT

IF FLAG:997
	CALL RANDOM_TRAP_3
ENDIF


;自然回復処理
FOR LCOUNT, 1, CHARANUM
	CALL AUTO_HEAL_PT(LCOUNT)
NEXT
FOR LCOUNT, 1, FLAG:1
	CALL AUTO_HEAL_ENEMY(LCOUNT)
NEXT

;汚染処理、自然浄化処理
FOR LCOUNT, 1, CHARANUM
	CALL AUTO_CLEAN_PT(LCOUNT)
NEXT
FOR LCOUNT, 1, FLAG:1
	CALL AUTO_CLEAN_ENEMY(LCOUNT)
NEXT

;◆誰もいない部屋の汚染度上昇
IF FLAG:541
	FOR LOCAL:2, 1, 30
		LOCAL:3 = 0
		FOR LCOUNT, 1, CHARANUM
			SIF CFLAG:(LCOUNT):4 == LOCAL:2
				LOCAL:3 = 1
		NEXT
		FOR LCOUNT, 1, FLAG:1
			SIF DA:(LCOUNT):4 == LOCAL:2
				LOCAL:3 = 1
		NEXT
		SIF !LOCAL:3
			FLAG:(LOCAL:2 + 50) += RAND:6
		SIF FLAG:(LOCAL:2 + 50) > 100
			FLAG:(LOCAL:2 + 50) = 100
	NEXT
ENDIF

;浄化力回復処理
FLAG:6 += 15 + RAND:21
SIF TALENT:1:152
	FLAG:6 += RAND:6
SIF FLAG:10 && TALENT:(FLAG:10):152
	FLAG:6 += RAND:6
SIF FLAG:11 && TALENT:(FLAG:11):152
	FLAG:6 += RAND:6
SIF FLAG:6 > 300
	FLAG:6 = 300


;TP変動処理
FOR LCOUNT, 1, CHARANUM
	CALL CHANGE_TP(LCOUNT, 0)
NEXT


;妖精の一回休み解除判定
FOR LCOUNT, 1, CHARANUM
	CALL REVIVE_FAIRLY(LCOUNT)
NEXT


;好感度低下による離脱判定
CALL BREAK_UP_CHECK(FLAG:10)
CALL BREAK_UP_CHECK(FLAG:11)

;発情回復判定　薬毒耐性だと回復しやすい
FOR LCOUNT, 1, CHARANUM
	IF CFLAG:LCOUNT:28 && RAND:10 <= 0 + TALENT:LCOUNT:56
		;媚薬装備時は発情レベル1を維持する、それ以外の場合のみ回復
		CALL GET_EQUIP_BONUS(LCOUNT, 39)
		IF !(RESULT && CFLAG:LCOUNT:28 == 1)
			CFLAG:(LCOUNT):28 = LIMIT(CFLAG:LCOUNT:28 - 1, 0, __INT_MAX__)
			CALL PRINT_MESSAGE(LCOUNT, 121, 99, CALLNAME:LCOUNT, "")
		ENDIF
	ENDIF
NEXT

;ランダム自慰判定
FOR LCOUNT, 1, CHARANUM
	CALL RANDOM_MASTERBATION((LCOUNT),CALLNAME:(LCOUNT))
NEXT

;新規敵追加処理
CALL REPOP



;時間を進める
TIME:0 += 1

IF TIME:0 >= 4
	;日数を進める
	TIME:0 = 0
	DAY += 1
ENDIF


;眠気追加
IF FLAG:8
	;普通の睡眠ならここで起きる
	IF (FLAG:8 % 10) == 1
		FLAG:8 = 0
	ELSE
		;気絶睡眠の場合、SHOW_SHOP で処理させるので、ここでは何もしない
	ENDIF
ELSEIF CFLAG:1:10
	;捕食されている場合はとりあえず眠気が溜まらないようにしておく
ELSE
	;寝ていなければ眠気追加
	FLAG:7 += 1
	CALL PRINT_MESSAGE(-1, 131, FLAG:7, CALLNAME:1, "")
	CALL PRINT_MESSAGE(1, 131, FLAG:7, CALLNAME:1, "")
	CALL PRINT_MESSAGE(FLAG:10, 131, FLAG:7, CALLNAME:1, "")
	CALL PRINT_MESSAGE(FLAG:11, 131, FLAG:7, CALLNAME:1, "")
ENDIF

;睡眠のチュートリアル
SIF FLAG:7 >= 3
	CALL SHOW_TUTORIAL(8)

SIF FLAG:7 < 0
	FLAG:7 = 0

;結界の効果切れ
IF FLAG:98
	FLAG:(50 + FLAG:98) = 0
	FLAG:98 = 0
ENDIF

;★尿意パッチ加筆点★
;尿意追加
CALL ADD_BASE_NP(1,1+RAND:2)
SIF FLAG:10
	CALL ADD_BASE_NP(FLAG:10,1+RAND:2)
SIF FLAG:11
	CALL ADD_BASE_NP(FLAG:11,1+RAND:2)
;★ここまで★

;便意追加
CALL UPDATE_BP(1)
SIF FLAG:10
	CALL UPDATE_BP(FLAG:10)
SIF FLAG:11
	CALL UPDATE_BP(FLAG:11)

;ランダム発情
IF GETBIT(FLAG:530,1)
	CALL RANDOM_ESTRUS(1,CALLNAME:1)
	SIF FLAG:10
		CALL RANDOM_ESTRUS(FLAG:10,CALLNAME:(FLAG:10))
	SIF FLAG:11
		CALL RANDOM_ESTRUS(FLAG:11,CALLNAME:(FLAG:11))
ENDIF

IF GETBIT(FLAG:530,3)
	SIF FLAG:10 || FLAG:11
		CALL RANDOM_LESBIAN(1,CALLNAME:1)
	SIF	 FLAG:10
		CALL RANDOM_LESBIAN(FLAG:10,CALLNAME:(FLAG:10))
	SIF FLAG:11
		CALL RANDOM_LESBIAN(FLAG:11,CALLNAME:(FLAG:11))
ENDIF

;－－－－－服装リジェネ－－－－－
FOR LCOUNT, 0, 3
	IF GET_MEMBER(LCOUNT) > 0
		LOCAL = GET_MEMBER(LCOUNT)
		FOR LCOUNT:1, 0, 5
			CALL CLOTH_TYPE_EFFECT_リジェネ(GET_MEMBER(LCOUNT), LCOUNT:1)
			IF RESULT > 0
				SELECTCASE LCOUNT:1
					CASE 0
						BASE:(LOCAL):HP = LIMIT(BASE:(LOCAL):HP + RESULT:1, 0, MAXBASE:(LOCAL):HP)
					CASE 1
						IF CFLAG:(LOCAL):戦意喪失 == 0 && BASE:(LOCAL):MP > 0
							BASE:(LOCAL):MP = LIMIT(BASE:(LOCAL):MP + RESULT:1, 1, MAXBASE:(LOCAL):MP)
						ENDIF
					CASE 2
						IF BASE:(LOCAL):EP > 0
							BASE:(LOCAL):EP = LIMIT(BASE:(LOCAL):EP + RESULT:1, 1, MAXBASE:(LOCAL):EP)
						ENDIF
					CASE 3
						IF BASE:(LOCAL):CP > 0
							BASE:(LOCAL):CP = LIMIT(BASE:(LOCAL):CP + RESULT:1, 1, MAXBASE:(LOCAL):CP)
						ENDIF
					CASE 4
						BASE:(LOCAL):TP = LIMIT(BASE:(LOCAL):TP + RESULT:1, 0, MAXBASE:(LOCAL):TP)
					CASE 5
						BASE:(LOCAL):DP = LIMIT(BASE:(LOCAL):DP + RESULT:1, 0, 150)
				ENDSELECT
			ENDIF
		NEXT
	ENDIF
NEXT
;－－－－－－－－－－

;ペットの空腹処理・レイプ判定
IF PET:0
	CALL PET_CHECK_PREGNANCY
	CALL CHECK_PET_SUBMISSION
	CALL PET_DECREASE_SUBMISSION
	CALL PET_DECREASE_SATIETY
	CALL PET_RAPE
	CALL LIMIT_PET_STATUS
ENDIF

;避妊パッチ********************************************************
	SIF CFLAG:1:70
		CFLAG:1:70 -= 1
	SIF CFLAG:(FLAG:10):70
		CFLAG:(FLAG:10):70 -= 1
	SIF CFLAG:(FLAG:11):70
		CFLAG:(FLAG:11):70 -= 1
;********************************************************

CALL ENDPHASE_TRAP

