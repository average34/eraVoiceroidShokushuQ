;フェイズごとの媚薬爆弾チェック
;ARG:0	対象キャラ
@CHECK_PARASITE_BOMB(ARG:0)
#DIM MP_DECREASE_RATE
;LOCAL
;0	LOOP
;1	メッセージ表示フラグ
;2	触手が襲う部位
;3	ダメージ

SIF CFLAG:(ARG:0):158 == 0
	RETURN
;リタイアしてるなら黙る
SIF CFLAG:(ARG:0):2
	RETURN

;主人公と場所が違うかチェック
IF CFLAG:(ARG:0):4 != CFLAG:1:4
	LOCAL:1 = 0
ELSE
	LOCAL:1 = 1
ENDIF
CFLAG:(ARG:0):158 -= 1

;寄生妊娠と違って時間経過がわかりにくい時限爆弾式
;発動すると絶頂4回+発情、途中回復手段なし
;代わりにCPダメージ無し、母乳体質は爆乳以降、ウォッチャーライブなし
IF CFLAG:(ARG:0):158 <= 0 && LOCAL:1 == 1
	CALL PRINT_MESSAGE(ARG:0, 517, 0, CALLNAME:(ARG:0), "")
	;ある程度妊娠に近くするのでVBに一回ずつ、残り2回はランダム
	TFLAG:63 = 1
	CALL DAMAGE_COMMON(ARG:0, 2, MAXBASE:(ARG:0):2, 3000)
	TFLAG:63 = RAND:4
	CALL DAMAGE_COMMON(ARG:0, 2, MAXBASE:(ARG:0):2, 2000)
	TFLAG:63 = RAND:4
	CALL DAMAGE_COMMON(ARG:0, 2, MAXBASE:(ARG:0):2, 2000)
	TFLAG:63 = 3
	CALL DAMAGE_COMMON(ARG:0, 2, MAXBASE:(ARG:0):2, 2000)
	;触手スーツ暴走
	IF CFLAG:(ARG:0):40 == 1
		PRINTFORML さらに、衣服に擬態していた触手が暴走し始めた！
		CALL WAIT_AUTOMODE(200, 0)
		CALL EXTASY(ARG:0, RAND:4, 400, 100)
		CALL EXTASY(ARG:0, RAND:4, 400, 100)
	ENDIF
	;暴走終わり
	CALL ADD_ABL_EXP(11, ARG:0, 100)
	;最低発情レベル3 回復が大変だけど母乳体質がつきにくいので互換
	CFLAG:(ARG:0):28 = 3 + RAND:3
	CALL PRINT_MESSAGE(ARG:0, 517, 1, CALLNAME:(ARG:0), "")
	;媚薬爆弾でえろぼでーに
	IF FLAG:521 == 1
		;豊乳化OFF設定なら無効
	ELSEIF FLAG:521 == 3 && TALENT:(ARG:0):122 > 0
		;オトコのみOFF設定かつオトコなら無効
	ELSE
		;絶壁
		IF GET_BUST(ARG:0) <= -2
			SIF LOCAL:1
				CALL PRINT_MESSAGE(ARG:0, 427, 5, CALLNAME:(ARG:0), "")
		;貧乳
		ELSEIF GET_BUST(ARG:0) == -1
			SIF LOCAL:1
				CALL PRINT_MESSAGE(ARG:0, 427, 0, CALLNAME:(ARG:0), "")
		;普通
		ELSEIF GET_BUST(ARG:0) == 0
			SIF LOCAL:1
				CALL PRINT_MESSAGE(ARG:0, 427, 1, CALLNAME:(ARG:0), "")
		;巨乳
		ELSEIF GET_BUST(ARG:0) == 1
			SIF LOCAL:1
				CALL PRINT_MESSAGE(ARG:0, 427, 2, CALLNAME:(ARG:0), "")
		;爆乳
		ELSEIF GET_BUST(ARG:0) == 2
			IF LOCAL:1
				CALL PRINT_MESSAGE(ARG:0, 427, 3, CALLNAME:(ARG:0), "")
				CALL PRINT_MESSAGE(ARG:0, 427, 4, CALLNAME:(ARG:0), "")
			ENDIF
		;超乳
		ELSEIF GET_BUST(ARG:0) >= 3
			IF LOCAL:1
				CALL PRINT_MESSAGE(ARG:0, 427, 6, CALLNAME:(ARG:0), "")
				CALL PRINT_MESSAGE(ARG:0, 427, 4, CALLNAME:(ARG:0), "")
			ENDIF
		ENDIF
		
		CALL ADD_BUST(ARG:0, 1, 2)
	ENDIF
	
	CALL MILK_COME(ARG:0, 1, 2)
	CALL MILK_ADJUST(ARG:0, 0)
	
ELSEIF CFLAG:(ARG:0):158 <= 0
	;非表示の場合でも、MP減少などの処理は入れておく
	FLAG:20 = 1
	MP_DECREASE_RATE = 3000 * (50 + FLAG:4 * 10) / 100
	CALL LOST_VIRGIN(ARG:0, 2, 6)
	CALL EXTASY(ARG:0, 3, 400, MP_DECREASE_RATE)
	CALL EXTASY(ARG:0, RAND:4, 400, MP_DECREASE_RATE)
	CALL EXTASY(ARG:0, RAND:4, 400, MP_DECREASE_RATE)
	CALL EXTASY(ARG:0, 1, 400, MP_DECREASE_RATE)
	CALL ADD_ABL_EXP(11, ARG:0, 100)
	CALL ADD_BUST(ARG:0,1,2)
	CALL MILK_COME(ARG:0, 1, 2)
	CALL MILK_ADJUST(ARG:0, 0)
	;複乳チェック
	IF FLAG:598 > 0
		TRYCALL SUPERNUMERARY_BREASTS(ARG:0, 3)
	ENDIF
	;最低発情レベル3 回復が大変だけど母乳体質がつかないので互換
	CFLAG:(ARG:0):28 = 3 + RAND:3
	FLAG:20 = 0
ENDIF

IF CFLAG:(ARG:0):158 <= 0
	;発動した場合のの共通処理
	CALL ADD_FEELING(ARG:0, -10)
	BASE:(ARG:0):0 = 0
	BASE:(ARG:0):4 = 0
	CFLAG:(ARG:0):158 = 0
ENDIF

