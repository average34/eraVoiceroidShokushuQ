;フェイズごとの寄生チェックふたなりVer

;とりあえず玉のみ　竿はそのうち追加
;寄生中は射精不可の絶頂発生

;ARG:0	対象キャラ
@CHECK_C_PARASITE(ARG:0)
#DIM MP_DECREASE_RATE
;LOCAL
;0	LOOP
;1	メッセージ表示フラグ
;2	
;3	
;5	ウォッチャーチェック
;11	ウォッチャーがいる

SIF CFLAG:(ARG:0):171 <= 0
	RETURN
;リタイアしてるなら黙る
SIF CFLAG:(ARG:0):2
	RETURN

;主人公と場所が違うかチェック
IF CFLAG:(ARG:0):4 != CFLAG:1:4
	LOCAL:1 = 0
ELSE
	LOCAL:1 = 1
ENDIF
IF CFLAG:(ARG:0):154 >= 3
	CFLAG:(ARG:0):171 = 0
	CFLAG:(ARG:0):172 = 0
	CFLAG:(ARG:0):154 -= 3
	IF LOCAL:1
		IF FLAG:AUTOMODE
			PRINTFORML 卵破壊の札が体内の異物を浄化したようだ
			TWAIT FLAG:AUTOMODE * 200, 0
		ELSE
			PRINTFORMW 卵破壊の札が体内の異物を浄化したようだ
		ENDIF
	ENDIF
	RETURN
ENDIF
CFLAG:(ARG:0):172 -= 1

;産卵ありかどうかで分岐　服がそのままだったり通常の寄生よりは比較的穏やか
IF LOCAL:1
	IF CFLAG:(ARG:0):172 >= 1
		IF FLAG:533
			CALL PRINT_MESSAGE(ARG:0, 541, CFLAG:(ARG:0):172, CALLNAME:(ARG:0), "")
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != ARG:0
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 542, CFLAG:(ARG:0):172, CALLNAME:(ARG:0), "", ARG:0)
			NEXT
		ELSE
			CALL PRINT_MESSAGE(ARG:0, 545, CFLAG:(ARG:0):172, CALLNAME:(ARG:0), "")
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != ARG:0
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 546, CFLAG:(ARG:0):172, CALLNAME:(ARG:0), "", ARG:0)
			NEXT
		ENDIF
	ENDIF
	;寄生している間は精力増強と強制絶頂
	IF GET_PENIS(ARG:0) == 1
		CFLAG:(ARG:0):42 += 5
	ELSEIF CFLAG:(ARG:0):28 < 4
		CFLAG:(ARG:0):28 += 1
	ENDIF
	;todo:なんかここミスっぽい気がする MP_DECREASE_RATEを計算してから突っ込ませたい
	CALL EXTASY(ARG:0, 2, 5, 100, 0)
ENDIF

;産卵
IF CFLAG:(ARG:0):172 <= 0
	;ウォッチャーのチェック
	FOR LOCAL:5 , 1, FLAG:1
		;ウォッチャーだとフラグ
		IF DA:(LOCAL:5):0 == 97
			DA:(LOCAL:5):4 = CFLAG:(ARG:0):4
			LOCAL:11 += 1
			BREAK
		ENDIF
	NEXT

	IF LOCAL:1 || LOCAL:11
		;ウォッチャーがいる場合ライブ中継
		IF FLAG:533
			IF LOCAL:11
				CALL PRINT_MESSAGE(ARG:0, 127, 4, CALLNAME:(ARG:0), "", LOCAL:2)
			ENDIF
			CALL PRINT_MESSAGE(ARG:0, 543, 0, CALLNAME:(ARG:0), "")
			IF LOCAL:1
				FOR LOCAL:0, 0, 3
					SIF GET_MEMBER(LOCAL:0) != ARG:0
						CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 544, 0, CALLNAME:(ARG:0), "", ARG:0)
				NEXT
			ENDIF
		ELSE
			IF LOCAL:11
				CALL PRINT_MESSAGE(ARG:0, 127, 4, CALLNAME:(ARG:0), "", LOCAL:2)
			ENDIF
			CALL PRINT_MESSAGE(ARG:0, 547, 0, CALLNAME:(ARG:0), "")
			IF LOCAL:1
				FOR LOCAL:0, 0, 3
					SIF GET_MEMBER(LOCAL:0) != ARG:0
						CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 548, 0, CALLNAME:(ARG:0), "", ARG:0)
				NEXT
			ENDIF
		ENDIF

		;産卵時射精させるためこのタイミングで寄生フラグ解除
		CALL CREATE_ENEMY(CFLAG:(ARG:0):171, 0, FLAG:5, ARG:0)
		CFLAG:(ARG:0):171 = 0
		CFLAG:(ARG:0):172 = 0

		;汚染度が高いと出産の隙を触手が狙う
		IF (FLAG:(FLAG:5 + 50) + RAND:70) >= 100
			IF FLAG:533
				CALL PRINT_MESSAGE(ARG:0, 543, 4, CALLNAME:(ARG:0), "")
			ELSE
				CALL PRINT_MESSAGE(ARG:0, 547, 3, CALLNAME:(ARG:0), "")
			ENDIF
			FOR LOCAL:0, 0, 3
				LOCAL:2 = 2
				LOCAL:3 = 10000
				CALL ADD_ABL_EXP(LOCAL:2 + 6, ARG:0, 100 + RAND:100)
				IF RESULT > 0
					MP_DECREASE_RATE = RESULT:1
				ELSE
					MP_DECREASE_RATE = 300
				ENDIF
				TFLAG:63 = LOCAL:2
				CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:3, MP_DECREASE_RATE, 1)
				TFLAG:63 = 0
			NEXT
		ENDIF

		MP_DECREASE_RATE = 3000
		;卵生や産卵体質ならペナルティ軽減
		IF TALENT:(ARG:0):135 == 1 && TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 5
		ELSEIF TALENT:(ARG:0):135 == 1 || TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 2
		ENDIF
		CALL EXTASY(ARG:0, 2, 400, MP_DECREASE_RATE)
		IF FLAG:533
			CALL PRINT_MESSAGE(ARG:0, 543, 1, CALLNAME:(ARG:0), "")
		ELSE
			CALL PRINT_MESSAGE(ARG:0, 547, 1, CALLNAME:(ARG:0), "")
		ENDIF

		FOR LOCAL:0, 0, 3
			IF GET_MEMBER(LOCAL:0) != ARG:0
				IF FLAG:533
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 544, 1, CALLNAME:(ARG:0), "")
				ELSE
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 548, 1, CALLNAME:(ARG:0), "")
				ENDIF
			ENDIF
		NEXT
		CALL ADD_ABL_EXP(11, ARG:0, 100)
		IF FLAG:533
			CALL PRINT_MESSAGE(ARG:0, 543, 2, CALLNAME:(ARG:0), "")
		ELSE
			CALL PRINT_MESSAGE(ARG:0, 547, 2, CALLNAME:(ARG:0), "")
		ENDIF
		FOR LOCAL:0, 0, 3
			IF GET_MEMBER(LOCAL:0) != ARG:0
				IF FLAG:533
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 544, 2, CALLNAME:(ARG:0), "")
				ELSE
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 548, 2, CALLNAME:(ARG:0), "")
				ENDIF
			ENDIF
		NEXT
	ELSE
		;非表示の場合でも、MP減少などの処理は入れておく
		FLAG:20 = 1

		;産卵時射精させるためこのタイミングで寄生フラグ解除
		CALL CREATE_ENEMY(CFLAG:(ARG:0):171, 0, FLAG:5, ARG:0)
		CFLAG:(ARG:0):171 = 0
		CFLAG:(ARG:0):172 = 0

		;汚染度が高いと出産の隙を触手が狙う
		IF (FLAG:(FLAG:5 + 50) + RAND:70) >= 100
			FOR LOCAL:0, 0, 3
				LOCAL:2 = 2
				LOCAL:3 = 10000
				CALL ADD_ABL_EXP(LOCAL:2 + 6, ARG:0, 100 + RAND:100)
				IF RESULT > 0
					MP_DECREASE_RATE = RESULT:1
				ELSE
					MP_DECREASE_RATE = 300
				ENDIF
				TFLAG:63 = LOCAL:2
				CALL DAMAGE_COMMON(ARG:0, 2, LOCAL:3, MP_DECREASE_RATE, 1)
				TFLAG:63 = 0
			NEXT
		ENDIF

		MP_DECREASE_RATE = 3000 * (50 + FLAG:4 * 10) / 100
		;卵生や産卵体質ならペナルティ軽減
		IF TALENT:(ARG:0):135 == 1 && TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 5
		ELSEIF TALENT:(ARG:0):135 == 1 || TALENT:(ARG:0):136 == 1
			MP_DECREASE_RATE /= 2
		ENDIF
		CALL EXTASY(ARG:0, 2, 400, MP_DECREASE_RATE)
		CALL ADD_ABL_EXP(11, ARG:0, 100)
		FLAG:20 = 0
	ENDIF
ENDIF

IF CFLAG:(ARG:0):172 <= 0
	;生まれた場合の共通処理
	CALL ADD_FEELING(ARG:0, -10)
	;卵生や産卵体質ならペナルティ軽減
	IF TALENT:(ARG:0):135 == 1 && TALENT:(ARG:0):136 == 1
		BASE:(ARG:0):0 /= 2
	ELSEIF TALENT:(ARG:0):135 == 1 || TALENT:(ARG:0):136 == 1
		BASE:(ARG:0):0 /= 6
	ELSE
		BASE:(ARG:0):0 = 0
	ENDIF

	BASE:(ARG:0):4 = 0

	;ED用
	IF EXP:(ARG:0):22 == 0
		CALL ADD_HISTORY(DAY, ARG:0, CFLAG:(ARG:0):171, 3)
	ENDIF

	;産卵回数追加
	IF FLAG:533
		EXP:(ARG:0):23 += 1
	ELSE
		EXP:(ARG:0):22 += 1
	ENDIF

	;産卵体質入手
	IF TALENT:(ARG:0):136 == 0 && FLAG:533 && EXP:(ARG:0):23 >= 5 && RAND:2 == 0
		CALL PRINT_MESSAGE(ARG:0, 543, 3, CALLNAME:(ARG:0), "")
		TALENT:(ARG:0):136 = 1
	ENDIF

	;玉ありなら肥大化
	IF TALENT:(ARG:0):180 < 4 && TALENT:(ARG:0):180 > 0 && RAND:2 == 0
		TALENT:(ARG:0):180 += 1
		CALL PRINT_MESSAGE(ARG:0, 550, 0, CALLNAME:(ARG:0), "")
	ENDIF

ENDIF

