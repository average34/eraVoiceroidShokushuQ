;行動の解決処理
;D&Tみたいにコマンドの拡張性考えるつもりは無いので、
;割と決め打ちな部分も多かったり
@FIX_BATTLE_ACTION
;LOCAL
;0	LOOP
;1	攻撃側陣営(0:敵　1:味方)
;2	TEMP
;3	命中フラグ
;4	ダメージなど
;5	サブダメージ１
;6	サブダメージ２
;7	カウンター発動
;9	霊撃のHP補正倍率
;11-20	敵1～10を対象に取るかどうか(取る場合は対象のキャラID)
;21-23	PT1～3を対象に取るかどうか(取る場合は対象のキャラID)

;初期化
VARSET LOCAL, 0, 1, 24

RESETCOLOR

IF TFLAG:51
	LOCAL:1 = 1
ELSE
	LOCAL:1 = 0
ENDIF


;指定キャラ死亡チェック
IF LOCAL:1
	;味方の行動の場合、コマンドID10以上(主に敵への攻撃)の場合、死亡チェックを行う
	IF CFLAG:(TFLAG:51):50 >= 10 && TFLAG:60 == 0
		IF TFLAG:53
			IF DA:(TFLAG:53):1 <= 0
				;既に対象が死亡している場合、別の対象を選択
				CALL SELECT_LIVE_MEMBER_ENEMY
				TFLAG:53 = RESULT
			ENDIF
		ENDIF
	ENDIF
ELSE
	;敵の行動の場合はいつでも死亡(戦意喪失)チェックを行う　ただし、大抵無視フラグ付き
	IF TFLAG:60 == 0
		IF TFLAG:53
			IF DA:(TFLAG:53):1 <= 0
				;既に対象が死亡している場合、別の対象を選択
				CALL SELECT_LIVE_MEMBER_ENEMY
				TFLAG:53 = RESULT
			ENDIF
		ENDIF
		IF TFLAG:54
			IF CFLAG:(TFLAG:54):29
				CALL SELECT_LIVE_MEMBER_PT
				TFLAG:54 = RESULT
			ENDIF
		ENDIF
	ENDIF
ENDIF

;対象キャラ確定
IF TFLAG:59 == 0
	;単体が対象の場合、先頭に対象キャラのIDを入れておく
	IF TFLAG:53
		LOCAL:11 = TFLAG:53
	ELSEIF TFLAG:54
		LOCAL:21 = TFLAG:54
	ENDIF
ELSE
	;全体が対象の場合、残っているキャラを全部入れる
	;※前詰めする必要は無いので、居る場所だけIDを入れれば良い
	IF TFLAG:53
		FOR LOCAL:0, 1, 11
			IF TFLAG:(LOCAL:0) && (DA:(TFLAG:(LOCAL:0)):1 > 0 || TFLAG:60)
				LOCAL:(LOCAL:0 + 10) = TFLAG:(LOCAL:0)
			ENDIF
		NEXT
	ELSEIF TFLAG:54
		IF CFLAG:1:29 == 0 || TFLAG:60
			LOCAL:21 = 1
		ENDIF
		IF FLAG:10
			IF CFLAG:(FLAG:10):29 == 0 || TFLAG:60
				LOCAL:22 = FLAG:10
			ENDIF
		ENDIF
		IF FLAG:11
			IF CFLAG:(FLAG:11):29 == 0 || TFLAG:60
				LOCAL:23 = FLAG:11
			ENDIF
		ENDIF
	ENDIF
ENDIF

;敵の性攻撃時、TFLAG:91が設定されていなければ1を代入
IF TFLAG:55 == 3
	IF TFLAG:91 == 0
		TFLAG:91 = 1
	ENDIF
	;攻撃対象がおねだりの場合、メイン性属性が同じだった場合攻撃回数+2、違った場合攻撃回数+1
	IF CFLAG:(TFLAG:54):50 == TFLAG:63 + 54
		TFLAG:91 += 2
	ELSEIF CFLAG:(TFLAG:54):50 >= 54 && CFLAG:(TFLAG:54):50 <= 58
		TFLAG:91 += 1
	ENDIF
ENDIF
CALL SET_ENEMY_ATTACK_TIMES(TFLAG:91)

$MAIN_ACTION

;各自の分を処理
FOR LOCAL:0, 11, 24
	IF TFLAG:94 && CFLAG:(LOCAL:(LOCAL:0)):50 < 54
	;おねだりによる追加攻撃は、おねだり中のキャラ以外はスキップ
		CONTINUE
	ENDIF
	;対象が居なければスキップ
	IF LOCAL:(LOCAL:0) == 0
		CONTINUE
	ENDIF
	
	;対象が丸呑みされている場合、丸呑みした本人以外の行動は届かない
	;霊撃を除く
	IF LOCAL:0 > 20 && CFLAG:(LOCAL:(LOCAL:0)):21 && (TFLAG:50 != 19 && CFLAG:(LOCAL:(LOCAL:0)):21)
		IF LOCAL:1 == 1 || DA:(TFLAG:52):0 != 2 || (DA:(CFLAG:(LOCAL:(LOCAL:0)):20):0 != 1 && DA:(CFLAG:(LOCAL:(LOCAL:0)):10):0 != 1)
			IF (LOCAL:1 == 1 && TFLAG:51 != LOCAL:(LOCAL:0)) || (LOCAL:1 == 0 && TFLAG:52 != CFLAG:(LOCAL:(LOCAL:0)):20 && TFLAG:52 != CFLAG:(LOCAL:(LOCAL:0)):10)
				IF CFLAG:(LOCAL:(LOCAL:0)):20
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 37, CFLAG:(LOCAL:(LOCAL:0)):20, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(CFLAG:(LOCAL:(LOCAL:0)):20))
					IF TFLAG:51
						CALL PRINT_MESSAGE(TFLAG:51, 38, CFLAG:(LOCAL:(LOCAL:0)):20, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(CFLAG:(LOCAL:(LOCAL:0)):20))
					ENDIF
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 37, CFLAG:(LOCAL:(LOCAL:0)):10, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(CFLAG:(LOCAL:(LOCAL:0)):10))
					IF TFLAG:51
						CALL PRINT_MESSAGE(TFLAG:51, 38, CFLAG:(LOCAL:(LOCAL:0)):10, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(CFLAG:(LOCAL:(LOCAL:0)):10))
					ENDIF
				ENDIF
				CONTINUE
			ENDIF
		ENDIF
	ENDIF
	
	;命中フラグなどをリセットしておく
	LOCAL:3 = 0
	LOCAL:4 = 0
	LOCAL:5 = 0
	LOCAL:6 = 0
	LOCAL:7 = 0
	
	;種別判定
	SELECTCASE TFLAG:55
		CASE 0
			;味方の通常攻撃
			CALL CHECK_ATTACK_0(TFLAG:51, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			IF LOCAL:3
				;攻撃戦闘ならそっちの経験値それ以外なら道具戦闘
				IF TFLAG:56 == 0 || TFLAG:56 == 4
					CALL ADD_ABL_EXP(3, TFLAG:51, 200 + RAND:200)
				ELSE
					CALL ADD_ABL_EXP(4, TFLAG:51, 200 + RAND:200)
				ENDIF
				;攻撃の種類が霊撃でなく、対象が誰かを【捕虜】にしていた場合、ダメージが【捕虜】に当たる
				IF DA:(LOCAL:(LOCAL:0)):36 && TFLAG:55 != 9
					CALL PRINT_MESSAGE(TFLAG:51, 11, TFLAG:50, CALLNAME:(TFLAG:51), CALLNAME:(DA:(LOCAL:(LOCAL:0)):36), LOCAL:4)
					PRINTFORM %SAVESTR:(LOCAL:(LOCAL:0))%によって盾にされた%CALLNAME:(DA:(LOCAL:(LOCAL:0)):36)%に
					SETCOLOR 0x70FFFF
					PRINTFORM {LOCAL:4}
					RESETCOLOR
					PRINTFORML のダメージ！
					BASE:(DA:(LOCAL:(LOCAL:0)):36):0 -= LOCAL:4
					CALL CHANGE_TP(TFLAG:51, 23)
				;攻撃の種類が霊撃、または対象が誰も【捕虜】にしていない場合、通常通りのダメージ
				ELSE
					CALL PRINT_MESSAGE(TFLAG:51, 11, TFLAG:50, CALLNAME:(TFLAG:51), SAVESTR:(LOCAL:(LOCAL:0)), LOCAL:4)
					PRINTFORM %SAVESTR:(LOCAL:(LOCAL:0))%に
					SETCOLOR 0x70FFFF
					PRINTFORM {LOCAL:4}
					RESETCOLOR
					PRINTFORML のダメージ！
					DA:(LOCAL:(LOCAL:0)):1 -= LOCAL:4
					CALL CHANGE_TP(TFLAG:51, 1)
				ENDIF
				IF TFLAG:50 == 60 && (CFLAG:(TFLAG:51):7 >= 20 && CFLAG:(TFLAG:51):7 <= 23)
					CALL PRINT_MESSAGE(TFLAG:51, 1, 60, CALLNAME:(TFLAG:51), ITEMNAME:(CFLAG:(TFLAG:51):7), CFLAG:(TFLAG:51):7, 2)
					CFLAG:(TFLAG:51):7 = 0
				ENDIF
				IF TFLAG:50 == 61 && (CFLAG:(TFLAG:51):8 >= 20 && CFLAG:(TFLAG:51):8 <= 23)
					CALL PRINT_MESSAGE(TFLAG:51, 1, 60, CALLNAME:(TFLAG:51), ITEMNAME:(CFLAG:(TFLAG:51):8), CFLAG:(TFLAG:51):8, 2)
					CFLAG:(TFLAG:51):8 = 0
				ENDIF
				
				;ダメージによる拘束キャラ救出判定
				IF DA:(LOCAL:(LOCAL:0)):1 > 0 && (DA:(LOCAL:(LOCAL:0)):10 || DA:(LOCAL:(LOCAL:0)):20)
					LOCAL:5 = 2 + LIMIT((LOCAL:4 * 50 / DA:(LOCAL:(LOCAL:0)):2), 1, 10) + LIMIT((DA:(LOCAL:(LOCAL:0)):1 * 10 / DA:(LOCAL:(LOCAL:0)):2), 0, 5)
					IF RAND:100 < LOCAL:5
						CALL STATUS_RENEW_RELEASE(DA:(LOCAL:(LOCAL:0)):10, 0, 2)
						CALL STATUS_RENEW_RELEASE(DA:(LOCAL:(LOCAL:0)):20, 0, 2)
					ENDIF
				ENDIF
			ELSE
				;攻撃戦闘ならそっちの経験値それ以外なら道具戦闘
				IF TFLAG:56 == 0 || TFLAG:56 == 4
					CALL ADD_ABL_EXP(3, TFLAG:51, 200 + RAND:200)
				ELSE
					CALL ADD_ABL_EXP(4, TFLAG:51, 200 + RAND:200)
				ENDIF
				CALL PRINT_MESSAGE(TFLAG:51, 21, TFLAG:50, CALLNAME:(TFLAG:51), SAVESTR:(LOCAL:(LOCAL:0)), LOCAL:4)
				CALL CHANGE_TP(TFLAG:51, 3)
			ENDIF
		CASE 1
			;敵の通常攻撃(TFLAG:64がCP倍率)
			CALL CHECK_ATTACK_1(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			LOCAL:5 = LOCAL:4 * TFLAG:64 / 1000
			IF CFLAG:(LOCAL:(LOCAL:0)):50 == 58
			;メイン属性とおねだり箇所が一致した場合ダメージ2倍
				LOCAL:4 = LOCAL:4 * 20 / 10
			ELSEIF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
			;おねだり中はダメージ1.5倍
				LOCAL:4 = LOCAL:4 * 15 / 10
			ENDIF
			IF LOCAL:3
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 4)
				IF BASE:(LOCAL:(LOCAL:0)):0 <= 0
					;既にHP0の場合、1/4で怯む
					IF RAND:4 == 0
						CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 39, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52))
						CALL ADD_STUN(LOCAL:(LOCAL:0))
					ENDIF
				ENDIF
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 12, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
				;喋る悪堕ちキャラ・転生キャラ
				IF DA:(TFLAG:52):99 >= 2
					CALL PRINT_MESSAGE(DA:(TFLAG:52):46, 1012, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
				ENDIF
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 0, LOCAL:4, TFLAG:90)
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 3, LOCAL:5, TFLAG:90)
			ELSE
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 100 + RAND:100)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 5)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 22, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52))
				ENDIF
				;胸揺れダメージ
				SIF TFLAG:59 == 0 && TFLAG:91 == 1 && TFLAG:96 == 0
					CALL PURUN_BAST(LOCAL:(LOCAL:0), TFLAG:90)
				;骨折ダメージ　胸揺れダメージ発生と同じ条件で発生
				SIF TFLAG:59 == 0 && TFLAG:96 == 0
					CALL FRACTURE_DAMAGE(LOCAL:(LOCAL:0))
			ENDIF
		CASE 2
			;敵の衣服攻撃(TFLAG:64がMP倍率　TFLAG:65がCP0時のEP倍率)
			CALL CHECK_ATTACK_2(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			LOCAL:5 = LOCAL:4 * TFLAG:64 / 1000
			IF CFLAG:(LOCAL:(LOCAL:0)):50 == 58
			;メイン属性とおねだり箇所が一致した場合ダメージ2倍
			;MPダメージは0.5倍
				LOCAL:4 = LOCAL:4 * 20 / 10
				LOCAL:5 = LOCAL:5 * 5 / 10
			ELSEIF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
			;おねだり中はダメージ1.5倍
			;MPダメージは0.8倍
				LOCAL:4 = LOCAL:4 * 15 / 10
				LOCAL:5 = LOCAL:5 * 8 / 10
			ENDIF
			IF LOCAL:3
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 6)
				IF BASE:(LOCAL:(LOCAL:0)):3 <= 0 || (BASE:(LOCAL:(LOCAL:0)):3 * 100 / MAXBASE:(LOCAL:(LOCAL:0)):3 <= 40 && FLAG:529 == 1)
					;既にCP0の場合、MPダメージ2倍＋CPダメージがHP・EPダメージに
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 13, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63, 0, CALC_SENSITIVITY(LOCAL:(LOCAL:0), TFLAG:63, (LOCAL:4 * TFLAG:65 / 1000)), TFLAG:98)
					;喋る悪堕ちキャラ・転生キャラ
					IF DA:(TFLAG:52):99 >= 2
						CALL PRINT_MESSAGE(DA:(TFLAG:52):46, 1013, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
					ENDIF
					CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 0, LOCAL:4, TFLAG:90)
					LOCAL:5 *= 2
					LOCAL:4 = LOCAL:4 * TFLAG:65 / 1000
					CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 2, CALC_SENSITIVITY(LOCAL:(LOCAL:0), TFLAG:63, LOCAL:4), TFLAG:90)
					CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 1, LOCAL:5, TFLAG:90)
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 13, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63, LOCAL:4, 0, TFLAG:98)
					;喋る悪堕ちキャラ・転生キャラ
					IF DA:(TFLAG:52):99 >= 2
						CALL PRINT_MESSAGE(DA:(TFLAG:52):46, 1013, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
					ENDIF
					CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 3, LOCAL:4, TFLAG:90)
					CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 1, LOCAL:5, TFLAG:90)
				ENDIF
				SIF DA:(TFLAG:52):85 & 1
					CALL ADD_ABL_EXP(13, LOCAL:(LOCAL:0), 2 + RAND:5)
			ELSE
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 100 + RAND:100)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 7)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 23, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63)
				ENDIF
				;胸揺れダメージ
				SIF TFLAG:59 == 0 && TFLAG:91 == 1 && TFLAG:96 == 0
					CALL PURUN_BAST(LOCAL:(LOCAL:0), TFLAG:90)
				;骨折ダメージ　胸揺れダメージ発生と同じ条件で発生
				SIF TFLAG:59 == 0 && TFLAG:96 == 0
					CALL FRACTURE_DAMAGE(LOCAL:(LOCAL:0))
			ENDIF
		CASE 3
			;敵の性攻撃(TFLAG:64がMP倍率　TFLAG:65がCP倍率)
			CALL CHECK_ATTACK_3(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			LOCAL:5 = LOCAL:4 * TFLAG:64 / 1000
			IF CFLAG:(LOCAL:(LOCAL:0)):50 == TFLAG:63 + 54
			;メイン属性とおねだり箇所が一致した場合ダメージ2倍
			;MPダメージは0.25倍
				LOCAL:4 = LOCAL:4 * 20 / 10
				LOCAL:5 = LOCAL:5 * 25 / 100
			ELSEIF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
			;おねだり中はダメージ1.5倍
			;MPダメージは0.5倍
				LOCAL:4 = LOCAL:4 * 15 / 10
				LOCAL:5 = LOCAL:5 * 5 / 10
			ENDIF
			IF TFLAG:63 == 0
				;A攻撃で便意追加
				CALL ADD_BP(LOCAL:(LOCAL:0), 1)
			ENDIF
			;素質の影響
			;性属性ダメージに付随するMPダメージ倍率への補正はここでだけ
			SIF TALENT:(LOCAL:(LOCAL:0)):17
				LOCAL:5 = LOCAL:5 * 9 / 10
			IF TALENT:(LOCAL:(LOCAL:0)):42 && (TFLAG:63 == 0 || TFLAG:63 == 3)
				LOCAL:4 = LOCAL:4 * 12 / 10
				LOCAL:5 = LOCAL:5 * 8 / 10
			ENDIF
			SIF TALENT:(LOCAL:(LOCAL:0)):43 && (TFLAG:63 == 0 || TFLAG:63 == 3)
				LOCAL:4 = LOCAL:4 * 8 / 10
			SIF TALENT:(LOCAL:(LOCAL:0)):100 == 1 && (TFLAG:63 == 0 || TFLAG:63 == 3)
				LOCAL:5 = LOCAL:5 * 12 / 10
			SIF TALENT:(LOCAL:(LOCAL:0)):100 == 2 && (TFLAG:63 == 0 || TFLAG:63 == 3)
				LOCAL:5 = LOCAL:5 * 13 / 10
			;MPは強絶頂による補正が元々あるので、感度倍率をキャンセルする
			LOCAL:5 = LOCAL:5 * 100 / CALC_SENSITIVITY(LOCAL:(LOCAL:0), TFLAG:63, 100)
			LOCAL:6 = LOCAL:4 * TFLAG:65 / 1000
			IF FLAG:4 <= 0
				;EASY はMP/EPダメージ半減
				LOCAL:5 /= 2
				LOCAL:6 /= 2
			ENDIF
			;男にVは無効化
			IF TFLAG:63 == 3 && TALENT:(LOCAL:(LOCAL:0)):122
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 414, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63, LOCAL:4, TFLAG:98)
			ELSEIF LOCAL:3
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 400 + RAND:400)
				CALL ADD_ABL_EXP(TFLAG:63 + 6, LOCAL:(LOCAL:0), 200 + RAND:200)
				;複合属性による感覚経験
				IF TFLAG:92
					IF TFLAG:92 & 1
						CALL ADD_ABL_EXP(6, LOCAL:(LOCAL:0), 100 + RAND:100)
						;A攻撃で便意追加
						CALL ADD_BP(LOCAL:(LOCAL:0), 1)
					ENDIF
					SIF TFLAG:92 & 2
						CALL ADD_ABL_EXP(7, LOCAL:(LOCAL:0), 100 + RAND:100)
					SIF TFLAG:92 & 4
						CALL ADD_ABL_EXP(8, LOCAL:(LOCAL:0), 100 + RAND:100)
					SIF TFLAG:92 & 8
						CALL ADD_ABL_EXP(9, LOCAL:(LOCAL:0), 100 + RAND:100)
					SIF TFLAG:92 & 32
						CALL ADD_ABL_EXP(15, LOCAL:(LOCAL:0), 100 + RAND:100)
				ENDIF
				CALL ADD_ABL_EXP(11, LOCAL:(LOCAL:0), 1)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 8)
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 14, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63, LOCAL:4, TFLAG:98)
				;喋る悪堕ちキャラ・転生キャラ
				IF DA:(TFLAG:52):99 >= 2
					CALL PRINT_MESSAGE(DA:(TFLAG:52):46, 1014, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
				ENDIF
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 3, LOCAL:6, TFLAG:90)
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 2, LOCAL:4, TFLAG:90)
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 1, LOCAL:5, TFLAG:90)
				;メイン性属性がVでTFLAG:95 == 0の時処女喪失判定
				SIF TFLAG:63 == 3 && TFLAG:95 == 0
					CALL LOST_VIRGIN(LOCAL:(LOCAL:0), 0, 1, TFLAG:52)
				SIF DA:(TFLAG:52):85 & 1
					CALL ADD_ABL_EXP(13, LOCAL:(LOCAL:0), 2 + RAND:5)
			ELSE
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 9)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 24, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63)
				ENDIF
				;胸揺れダメージ
				SIF TFLAG:59 == 0 && TFLAG:91 == 1 && TFLAG:96 == 0
					CALL PURUN_BAST(LOCAL:(LOCAL:0), TFLAG:90)
				;骨折ダメージ　胸揺れダメージ発生と同じ条件で発生
				SIF TFLAG:59 == 0 && TFLAG:96 == 0
					CALL FRACTURE_DAMAGE(LOCAL:(LOCAL:0))
			ENDIF
		CASE 4
			;敵の拘束攻撃(TFLAG:65が指定されている場合は命中時に丸呑みも付加)
			;拘束中の処理はCAPTURE_LEVELで一括処理
			IF CFLAG:(LOCAL:(LOCAL:0)):20 || CFLAG:(LOCAL:(LOCAL:0)):10
				;丸呑み中ならここに来る前に除外をかけているので、そのまま拘束レベルアップ
				CALL CAPTURE_LEVEL(LOCAL:(LOCAL:0))
				CONTINUE
			ENDIF
			CALL CHECK_ATTACK_4(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			IF LOCAL:3
				CALL CLOTH_ESCAPE(LOCAL:(LOCAL:0))
				IF RESULT == 0
					LOCAL:3 = 0
				ENDIF
			ENDIF
			IF LOCAL:3
				IF CFLAG:(LOCAL:(LOCAL:0)):50 == 58
				;その他おねだり中の拘束攻撃は拘束レベル5
					CFLAG:(LOCAL:(LOCAL:0)):38 = 5
				ENDIF
				CALL ADD_ABL_EXP(5, LOCAL:(LOCAL:0), 300 + RAND:300)
				CALL ADD_ABL_EXP(11, LOCAL:(LOCAL:0), 2)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 10)
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 15, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:65, TFLAG:98)
				;喋る悪堕ちキャラ・転生キャラ
				IF DA:(TFLAG:52):99 >= 2
					CALL PRINT_MESSAGE(DA:(TFLAG:52):46, 1015, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
				ENDIF
				CALL ADD_BIND(LOCAL:(LOCAL:0), TFLAG:52, TFLAG:65, TFLAG:64)
				
				;捕まった仲間以外もTP変化
				SIF LOCAL:(LOCAL:0) != 1
					CALL CHANGE_TP(1, 19)
				SIF FLAG:10 != 0 && LOCAL:(LOCAL:0) != FLAG:10
					CALL CHANGE_TP(FLAG:10, 19)
				SIF FLAG:11 != 0 && LOCAL:(LOCAL:0) != FLAG:11
					CALL CHANGE_TP(FLAG:11, 19)
				SIF DA:(TFLAG:52):85 & 1
					CALL ADD_ABL_EXP(13, LOCAL:(LOCAL:0), 2 + RAND:5)
				CALL SHOW_TUTORIAL(15)
			ELSE
				CALL ADD_ABL_EXP(5, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 11)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 25, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52))
				ENDIF
				;胸揺れダメージ
				SIF TFLAG:96 == 1 && TFLAG:59 == 0 && TFLAG:91 == 1
					CALL PURUN_BAST(LOCAL:(LOCAL:0), TFLAG:90)
				;骨折ダメージ　胸揺れダメージ発生と同じ条件で発生
				SIF TFLAG:59 == 0 && TFLAG:96 == 0
					CALL FRACTURE_DAMAGE(LOCAL:(LOCAL:0))
			ENDIF
		CASE 5
			CALL SHOW_TUTORIAL(20)
			;敵の寄生攻撃(TFLAG:65の確率で寄生成功)
			;既に拘束解除されている場合スキップ
			;ただし、コウノトリの全体空気妊娠攻撃(ID842)の場合はスキップしない
			IF CFLAG:(LOCAL:(LOCAL:0)):20 != TFLAG:52 && CFLAG:(LOCAL:(LOCAL:0)):10 != TFLAG:52 && TFLAG:50 != 842 && FLAG:997 != 81
				PRINTFORML しかし%CALLNAME:(LOCAL:(LOCAL:0))%は既に助け出されている！
				CONTINUE
			ENDIF
			CALL CHECK_ATTACK_5(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			IF CFLAG:(LOCAL:(LOCAL:0)):50 == 57
			;メイン属性とおねだり箇所が一致した場合ダメージ0.5倍
				LOCAL:4 = LOCAL:4 * 5 / 10
			ELSEIF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
			;おねだり中はダメージ0.8倍
				LOCAL:4 = LOCAL:4 * 8 / 10
			ENDIF
			;EASY はMPダメージ半減
			SIF FLAG:4 <= 0
				LOCAL:4 /= 2
			;男にVは無効化
			IF TFLAG:63 == 3 && TALENT:(LOCAL:(LOCAL:0)):122
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 415, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:64, LOCAL:4, TFLAG:98)
			ELSEIF LOCAL:3
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 400 + RAND:400)
				CALL ADD_ABL_EXP(5, LOCAL:(LOCAL:0), 400 + RAND:400)
				CALL ADD_ABL_EXP(11, LOCAL:(LOCAL:0), 3)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 12)
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 16, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:64, LOCAL:4, TFLAG:98)
				;喋る悪堕ちキャラ・転生キャラ
				IF DA:(TFLAG:52):99 >= 2
					CALL PRINT_MESSAGE(DA:(TFLAG:52):46, 1016, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), LOCAL:4, LOCAL:5, TFLAG:98)
				ENDIF
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 1, LOCAL:4, TFLAG:90)
				;TFLAG:95 == 1の場合は処女喪失判定無し
				SIF TFLAG:95 == 0 && TFLAG:63 == 3
					CALL LOST_VIRGIN(LOCAL:(LOCAL:0), 0, 1, TFLAG:52)
				CALL ADD_FEELING(LOCAL:(LOCAL:0), -5)
				IF TFLAG:64 == 0
					;通常の寄生処理
					IF TFLAG:63 == 3
						IF CFLAG:(LOCAL:(LOCAL:0)):50 == 57
						;Vおねだり中は確率60%増加
							LOCAL:5 = TFLAG:65 + 60
						ELSEIF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
						;おねだり中は確率30%増加
							LOCAL:5 = TFLAG:65 + 30
						ELSE
							LOCAL:5 = TFLAG:65
						ENDIF
						;体調や素質の補正
						IF FLAG:7 >= 11
							LOCAL:5 += 20
						ELSEIF FLAG:7 >= 7
							LOCAL:5 += 10
						ENDIF
						SIF TALENT:(LOCAL:(LOCAL:0)):132
							LOCAL:5 = LOCAL:5 / 2 + 1
						IF RAND:100 < LOCAL:5 && TALENT:(LOCAL:(LOCAL:0)):0 == 0
							;ナカに寄生
							IF CFLAG:(LOCAL:(LOCAL:0)):22 == 0 && RAND:3
								CALL PARASITE_TYPE(LOCAL:(LOCAL:0), 0, DA:(TFLAG:52):0, 4 + RAND:5 + RAND:5 + RAND:3, 0)
								CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 40, TFLAG:52, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
							;身体に寄生
							ELSE
								IF CFLAG:(LOCAL:(LOCAL:0)):80
									CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 445, 1, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
								ELSE
									CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 445, 0, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
								ENDIF
								CFLAG:(LOCAL:(LOCAL:0)):80 += 1
							ENDIF
						ENDIF
					ELSEIF TFLAG:63 == 0
						;口から入れる場合があるのでおねだりでは確率増加なし
						LOCAL:5 = TFLAG:65
						;体調や素質の補正
						IF FLAG:7 >= 11
							LOCAL:5 += 20
						ELSEIF FLAG:7 >= 7
							LOCAL:5 += 10
						ENDIF
						SIF TALENT:(LOCAL:(LOCAL:0)):132
							LOCAL:5 = LOCAL:5 / 2 + 1
						SIF TALENT:(LOCAL:(LOCAL:0)):136
							LOCAL:5 += 5
						IF RAND:100 < LOCAL:5
							;尻
							IF CFLAG:(LOCAL:(LOCAL:0)):151 == 0 && RAND:3
								CALL PARASITE_TYPE(LOCAL:(LOCAL:0), 2, DA:(TFLAG:52):0, 4 + RAND:5 + RAND:5 + RAND:3, 0)
								CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 40, TFLAG:52, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
							;身体
							ELSE
								IF CFLAG:(LOCAL:(LOCAL:0)):80
									CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 445, 1, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
								ELSE
									CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 445, 0, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
								ENDIF
								CFLAG:(LOCAL:(LOCAL:0)):80 += 1
							ENDIF
						ENDIF
					ELSEIF TFLAG:63 == 1
						;Bおねだり中は確率30％増加
						IF CFLAG:(LOCAL:(LOCAL:0)):50 == 55
							LOCAL:5 = TFLAG:65 + 30
						ELSE
							LOCAL:5 = TFLAG:65
						ENDIF
						;体調や素質の補正
						IF FLAG:7 >= 11
							LOCAL:5 += 20
						ELSEIF FLAG:7 >= 7
							LOCAL:5 += 10
						ENDIF
						SIF TALENT:(LOCAL:(LOCAL:0)):76
							LOCAL:5 += 5
						SIF TALENT:(LOCAL:(LOCAL:0)):132
							LOCAL:5 = LOCAL:5 / 2 + 1
						SIF TALENT:(LOCAL:(LOCAL:0)):136
							LOCAL:5 += 5
						SIF GET_BUST(LOCAL:(LOCAL:0)) == 1
							LOCAL:5 += 5
						SIF GET_BUST(LOCAL:(LOCAL:0)) == 2
							LOCAL:5 += 10
						SIF GET_BUST(LOCAL:(LOCAL:0)) == 3
							LOCAL:5 += 15 + LIMIT(TALENT:(LOCAL:(LOCAL:0)):158, 0, 5)
						SIF GET_BUST(LOCAL:(LOCAL:0)) == 4
							LOCAL:5 += 25 + LIMIT(TALENT:(LOCAL:(LOCAL:0)):222, 0, 5)
						SIF GET_BUST(LOCAL:(LOCAL:0)) >= 5
							LOCAL:5 += 35 + LIMIT(TALENT:(LOCAL:(LOCAL:0)):223, 0, 5)
						SIF TALENT:(LOCAL:(LOCAL:0)):162
							LOCAL:5 += TALENT:(LOCAL:(LOCAL:0)):162 * 10
						IF RAND:100 < LOCAL:5
							;乳
							IF CFLAG:(LOCAL:(LOCAL:0)):161 == 0 && RAND:3
								CALL PARASITE_TYPE(LOCAL:(LOCAL:0), 3, DA:(TFLAG:52):0, 4 + RAND:5 + RAND:5 + RAND:3, 0)
								CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 40, TFLAG:52, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
							;身体
							ELSE
								IF CFLAG:(LOCAL:(LOCAL:0)):80
									CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 445, 1, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
								ELSE
									CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 445, 0, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
								ENDIF
								CFLAG:(LOCAL:(LOCAL:0)):80 += 1
							ENDIF
						ENDIF
					ELSEIF TFLAG:63 == 2 && GET_PENIS(LOCAL:(LOCAL:0)) > 1
						;Cおねだり中は確率30％増加
						IF CFLAG:(LOCAL:(LOCAL:0)):50 == 55
							LOCAL:5 = TFLAG:65 + 30
						ELSE
							LOCAL:5 = TFLAG:65
						ENDIF
						;体調や素質の補正
						IF FLAG:7 >= 11
							LOCAL:5 += 20
						ELSEIF FLAG:7 >= 7
							LOCAL:5 += 10
						ENDIF
						SIF TALENT:(LOCAL:(LOCAL:0)):77
							LOCAL:5 += 5
						SIF TALENT:(LOCAL:(LOCAL:0)):132
							LOCAL:5 = LOCAL:5 / 2 + 1
						SIF TALENT:(LOCAL:(LOCAL:0)):136
							LOCAL:5 += 5
						;竿が太くて玉が大きければプラス、長くて包茎ならマイナス
						SIF TALENT:(LOCAL:(LOCAL:0)):170 > 0
							LOCAL:5 -= 5
						SIF TALENT:(LOCAL:(LOCAL:0)):171
							LOCAL:5 += 10
						SIF TALENT:(LOCAL:(LOCAL:0)):173
							LOCAL:5 -= 5
						SIF TALENT:(LOCAL:(LOCAL:0)):180
							LOCAL:5 += TALENT:(LOCAL:(LOCAL:0)):180 * 5
						IF RAND:100 < LOCAL:5
							;C寄生
							CALL PARASITE_TYPE(LOCAL:(LOCAL:0), 5, DA:(TFLAG:52):0, 4 + RAND:5 + RAND:5 + RAND:3, 0)
							CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 40, TFLAG:52, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
						ENDIF
					ENDIF
				ELSE
					;妊娠処理(ここでは射精量を溜めるのと、妊娠の対象を選ぶだけ)
					IF CFLAG:(LOCAL:(LOCAL:0)):50 == 57
					;Vおねだり中は射精量+60
						TFLAG:64 += 60
					ELSEIF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
					;おねだり中は射精量+30
						TFLAG:64 += 30
					ENDIF
					
					CALL ESTRUS_CYCLE(LOCAL:(LOCAL:0))
					TFLAG:64 = MAX(TFLAG:64 * RESULT / 100, 1)
					IF CFLAG:(LOCAL:(LOCAL:0)):47 == 0
						CFLAG:(LOCAL:(LOCAL:0)):60 += TFLAG:64
						CALL SAMEN_GAGE(CFLAG:(LOCAL:(LOCAL:0)):60, (LOCAL:(LOCAL:0)))
					ENDIF
					IF RAND:(1 + CFLAG:(LOCAL:(LOCAL:0)):60) <= TFLAG:64
						IF TFLAG:93
							CALL PARASITE_TYPE(LOCAL:(LOCAL:0), 4, 0, 0, 0)
						ELSE
							CFLAG:(LOCAL:(LOCAL:0)):57 = DA:(TFLAG:52):0
						ENDIF
					ENDIF
					;妊娠ほぼ確定まで精液注入されたメッセージ
					IF TFLAG:64 > 100
						CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 532, DA:(TFLAG:52):0, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:98)
					ENDIF
				ENDIF
				SIF DA:(TFLAG:52):85 & 1
					CALL ADD_ABL_EXP(13, LOCAL:(LOCAL:0), 2 + RAND:5)
				SIF TFLAG:91 == 1 && TFLAG:59 == 0
					CALL SAMEN_DAMAGE(LOCAL:(LOCAL:0), TFLAG:90)
				CALL ADD_ABL_EXP(14, LOCAL:(LOCAL:0), SQRT(TFLAG:64))
				;汚れ+5
				BASE:(LOCAL:(LOCAL:0)):5 += 5
			ELSE
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL ADD_ABL_EXP(5, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 13)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 26, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52))
				ENDIF
			ENDIF
		CASE 6
			;その他の行動＝強制的に命中扱い　細かい処理はTFLAG:99に任せる
			LOCAL:3 = 1



		CASE 8
			;敵の触手責め攻撃(TFLAG:64がHP倍率)
			CALL CHECK_ATTACK_8(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			LOCAL:5 = LOCAL:4 * TFLAG:64 / 1000

			IF CFLAG:(LOCAL:(LOCAL:0)):50 >= 54 && CFLAG:(LOCAL:(LOCAL:0)):50 <= 58
			;おねだり中はダメージ1.5倍
			;MPダメージは0.8倍
				LOCAL:4 = LOCAL:4 * 8 / 10
				LOCAL:5 = LOCAL:5 * 15 / 10
			ENDIF

			IF LOCAL:3
				;汚れ+2
				BASE:(LOCAL:(LOCAL:0)):5 += 2

				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 4)

				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 18, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63, LOCAL:4, TFLAG:98)
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 1, LOCAL:4, TFLAG:90)
				CALL DAMAGE_COMMON(LOCAL:(LOCAL:0), 0, LOCAL:5, TFLAG:90)
			ELSE
				CALL ADD_ABL_EXP(1, LOCAL:(LOCAL:0), 100 + RAND:100)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 5)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 28, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:63)
				ENDIF
			ENDIF






			
		;****************霊撃**********************
		CASE 9
			;----- HP補正倍率計算 -----
			;消費HP = 戦闘値/100 * 最大HP
			;HP補正倍率 = HP/消費HP
			;HPが0なら強制的にミス
			IF BASE:(TFLAG:51):0 == 0
				LOCAL:9 = 0
			;戦闘値が90以上且つHP9割以上なら9割消費固定
			ELSEIF ABL:(TFLAG:51):98 >= 90 && 100 * BASE:(TFLAG:51):0 / MAXBASE:(TFLAG:51):0 > 90
				LOCAL:9 = 9000 * BASE:(TFLAG:51):0 / MAXBASE:(TFLAG:51):0
			ELSE
				LOCAL:9 = 10000 * BASE:(TFLAG:51):0 / ABL:(TFLAG:51):98 / MAXBASE:(TFLAG:51):0
			ENDIF
			;霊撃の威力、命中計算
			CALL CHECK_ATTACK_9(TFLAG:51, LOCAL:(LOCAL:0), LOCAL:9)
			LOCAL:3 = RESULT:0
			LOCAL:4 = RESULT:1
			IF LOCAL:3
				CALL ADD_ABL_EXP(3, TFLAG:51, 200 + RAND:200)
				CALL PRINT_MESSAGE(TFLAG:51, 11, TFLAG:50, CALLNAME:(TFLAG:51), SAVESTR:(LOCAL:(LOCAL:0)), LOCAL:4)
				PRINTFORM %SAVESTR:(LOCAL:(LOCAL:0))%に
				SETCOLOR 0x70FFFF
				PRINTFORM {LOCAL:4}
				RESETCOLOR
				PRINTFORML のダメージ！
				DA:(LOCAL:(LOCAL:0)):1 -= LOCAL:4
				CALL CHANGE_TP(TFLAG:51, 1)
				;HP補正による拘束キャラ救出判定
				IF DA:(LOCAL:(LOCAL:0)):1 > 0 && (DA:(LOCAL:(LOCAL:0)):10 || DA:(LOCAL:(LOCAL:0)):20)
					IF RAND:100 < LOCAL:9
						CALL STATUS_RENEW_RELEASE(DA:(LOCAL:(LOCAL:0)):10, 0, 3)
						CALL STATUS_RENEW_RELEASE(DA:(LOCAL:(LOCAL:0)):20, 0, 3)
						;【捕虜】も同時に解除される
						CALL STATUS_RENEW_RELEASE(DA:(LOCAL:(LOCAL:0)):36, 0, 3)
						;【捕虜】を霊撃で救出した場合のＴＰ変動
						IF TFLAG:51 == FLAG:10
							CALL CHANGE_TP(FLAG:10, 24)
						ELSEIF TFLAG:51 == FLAG:11
							CALL CHANGE_TP(FLAG:11, 24)
						ELSE
							CALL CHANGE_TP(1, 24)
						ENDIF
					ENDIF
				ENDIF
			ELSE
				CALL ADD_ABL_EXP(3, TFLAG:51, 300 + RAND:500)
				CALL PRINT_MESSAGE(TFLAG:51, 21, TFLAG:50, CALLNAME:(TFLAG:51), SAVESTR:(LOCAL:(LOCAL:0)), LOCAL:4)
				CALL CHANGE_TP(TFLAG:51, 3)
			ENDIF
			
			;HP消費
			;戦闘値が90以上且つHP9割以上なら9割消費固定
			IF ABL:(TFLAG:51):98 >= 90 && 100 * BASE:(TFLAG:51):0 / MAXBASE:(TFLAG:51):0 > 90
				BASE:(TFLAG:51):0 -= MAXBASE:(TFLAG:51):0 * 90 / 100
			ELSE
				BASE:(TFLAG:51):0 -= MAXBASE:(TFLAG:51):0 * ABL:(TFLAG:51):98 / 100
			ENDIF

			IF BASE:(TFLAG:51):0 < 0
				BASE:(TFLAG:51):0 = 0
			ENDIF
		;フェアリーイーターの丸呑み
		CASE 10
			CALL CHECK_ATTACK_4(TFLAG:52, LOCAL:(LOCAL:0))
			LOCAL:3 = RESULT:0
			IF LOCAL:3
				IF CFLAG:(LOCAL:(LOCAL:0)):50 == 58
				;その他おねだり中の拘束攻撃は拘束レベル5
					CFLAG:(LOCAL:(LOCAL:0)):38 = 5
				ENDIF
				CALL ADD_ABL_EXP(5, LOCAL:(LOCAL:0), 300 + RAND:300)
				CALL ADD_ABL_EXP(11, LOCAL:(LOCAL:0), 2)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 10)
				CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 15, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:65)
				CALL ADD_BIND(LOCAL:(LOCAL:0), TFLAG:52, TFLAG:65, TFLAG:64)
				CFLAG:(LOCAL:(LOCAL:0)):21 = 1
				CALL CAPTURE_LEVEL(LOCAL:(LOCAL:0))
				;捕まった仲間以外もTP変化
				IF LOCAL:(LOCAL:0) != 1
					CALL CHANGE_TP(1, 19)
				ENDIF
				IF FLAG:10 != 0 && LOCAL:(LOCAL:0) != FLAG:10
					CALL CHANGE_TP(FLAG:10, 19)
				ENDIF
				IF FLAG:11 != 0 && LOCAL:(LOCAL:0) != FLAG:11
					CALL CHANGE_TP(FLAG:11, 19)
				ENDIF
			ELSE
				CALL ADD_ABL_EXP(5, LOCAL:(LOCAL:0), 200 + RAND:200)
				CALL CHANGE_TP(LOCAL:(LOCAL:0), 11)
				IF CFLAG:(LOCAL:(LOCAL:0)):33
					CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 200 + RAND:200)
					CALL EXTRA_ACTION_62(LOCAL:(LOCAL:0), TFLAG:52)
					LOCAL:7 = 1
				ELSE
					CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 25, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52))
				ENDIF
				;胸揺れダメージ
				SIF TFLAG:96 == 1 && TFLAG:59 == 0 && TFLAG:91 == 1
					CALL PURUN_BAST(LOCAL:(LOCAL:0), TFLAG:90)
				;骨折ダメージ　胸揺れダメージ発生と同じ条件で発生
				SIF TFLAG:59 == 0 && TFLAG:96 == 0
					CALL FRACTURE_DAMAGE(LOCAL:(LOCAL:0))
			ENDIF

		;******************************************
			
		CASEELSE
			PRINTFORMW (FIX_BATTLE_ACTION)無効なスキル種別{TFLAG:55}が指定されました 使用キャラ{TFLAG:51}/{DA:(TFLAG:52):0}
	ENDSELECT
	
	IF TFLAG:99 && TFLAG:50 == 60
		IF CFLAG:(TFLAG:51):7 == 25
			CALL PRINT_MESSAGE(TFLAG:51, 1, 60, CALLNAME:(TFLAG:51), ITEMNAME:(CFLAG:(TFLAG:51):7), CFLAG:(TFLAG:51):7, 2)
			CFLAG:1:26 = 0
			CFLAG:1:27 = 0
			CFLAG:(FLAG:10):26 = 0
			CFLAG:(FLAG:10):27 = 0
			CFLAG:(FLAG:11):26 = 0
			CFLAG:(FLAG:11):27 = 0
			CFLAG:(FLAG:15):26 = 0
			CFLAG:(FLAG:15):27 = 0
			CFLAG:(FLAG:16):26 = 0
			CFLAG:(FLAG:16):27 = 0
		ENDIF
		TFLAG:99 = 0
	ENDIF
	IF TFLAG:99 && TFLAG:50 == 61
		IF CFLAG:(TFLAG:51):8 == 25
			CALL PRINT_MESSAGE(TFLAG:51, 1, 60, CALLNAME:(TFLAG:51), ITEMNAME:(CFLAG:(TFLAG:51):8), CFLAG:(TFLAG:51):8, 2)
			CFLAG:1:26 = 0
			CFLAG:1:27 = 0
			CFLAG:(FLAG:10):26 = 0
			CFLAG:(FLAG:10):27 = 0
			CFLAG:(FLAG:11):26 = 0
			CFLAG:(FLAG:11):27 = 0
			CFLAG:(FLAG:15):26 = 0
			CFLAG:(FLAG:15):27 = 0
			CFLAG:(FLAG:16):26 = 0
			CFLAG:(FLAG:16):27 = 0
		ENDIF
		TFLAG:99 = 0
	ENDIF
	;特殊フラグが指定されている場合、命中したなら特殊効果発動
	IF TFLAG:99 && LOCAL:3
		IF LOCAL:1
			TRYCCALLFORM EXTRA_ACTION_{TFLAG:99}(TFLAG:51, LOCAL:(LOCAL:0))
			CATCH
				PRINTFORMW (FIX_BATTLE_ACTION)未実装の特殊効果(ID:{TFLAG:99})が指定されました
			ENDCATCH
		ELSE
			TRYCCALLFORM EXTRA_ACTION_{TFLAG:99}(TFLAG:52, LOCAL:(LOCAL:0))
			CATCH
				PRINTFORMW (FIX_BATTLE_ACTION)未実装の特殊効果(ID:{TFLAG:99})が指定されました
			ENDCATCH
		ENDIF
	ENDIF
	
	;寝ている相手に攻撃を当てた場合、起きる（昏睡なら確率で起きる）
	IF TFLAG:52 && LOCAL:3 && CFLAG:(LOCAL:(LOCAL:0)):25 && TFLAG:55 != 6
		IF CFLAG:(LOCAL:(LOCAL:0)):25 == 1
			CFLAG:(LOCAL:(LOCAL:0)):25 = 0
			CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 41, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:55, TFLAG:63)
		ELSEIF CFLAG:(LOCAL:(LOCAL:0)):25 >= 2 && RAND:20 == 0
			CFLAG:(LOCAL:(LOCAL:0)):25 = 0
			CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 41, TFLAG:50, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52), TFLAG:55, TFLAG:63)
		ENDIF
	ENDIF
	
	;死亡チェック
	IF LOCAL:0 <= 20
		;敵が対象の場合、HP0以下で死亡
		IF DA:(LOCAL:(LOCAL:0)):1 <= 0
			IF (TFLAG:50 / 10) == 1
				CALL ADD_ABL_EXP(3, TFLAG:51, 600 + RAND:400)
			ELSE
				CALL ADD_ABL_EXP(4, TFLAG:51, 600 + RAND:400)
			ENDIF
			CALL PRINT_MESSAGE(TFLAG:51, 31, LOCAL:(LOCAL:0), CALLNAME:(TFLAG:51), SAVESTR:(LOCAL:(LOCAL:0)))
			DA:(LOCAL:(LOCAL:0)):1 = 0
			CALL ADD_FEELING(TFLAG:51, 3)
			
			;TP変化とか、拘束キャラ解放とか
			CALL CHANGE_TP(TFLAG:51, 2)
			CALL CHECK_DEFEAT_ENEMY_IN_BATTLE(LOCAL:(LOCAL:0))
		ENDIF
	ELSEIF LOCAL:7
		;カウンターが発動している場合、攻撃側が死んでいないかチェック
		IF DA:(TFLAG:52):1 <= 0
			CALL ADD_ABL_EXP(4, LOCAL:(LOCAL:0), 600 + RAND:400)
			CALL PRINT_MESSAGE(LOCAL:(LOCAL:0), 31, TFLAG:52, CALLNAME:(LOCAL:(LOCAL:0)), SAVESTR:(TFLAG:52))
			DA:(TFLAG:52):1 = 0
			;処理が残らないように全体攻撃2回行動などを削除
			TFLAG:59 = 0
			TFLAG:91 = 0
			DA:(TFLAG:52):8 = 0
			CALL ADD_FEELING(LOCAL:(LOCAL:0), 3)
			
			;TP変化とか、拘束キャラ解放とか
			CALL CHANGE_TP(LOCAL:(LOCAL:0), 2)
			CALL CHECK_DEFEAT_ENEMY_IN_BATTLE(TFLAG:52)
			
			CALL MSG_WAIT(1)
			RETURN
		ENDIF
	ELSE
		;味方が対象の場合、MP0以下で戦意喪失
		;ダメージ側でも喪失処理入ってるけど念のため
		IF CFLAG:(LOCAL:(LOCAL:0)):29
			;既に戦意喪失している場合、MPが0未満にならないようにだけしておく
			IF BASE:(LOCAL:(LOCAL:0)):1 < 0
				BASE:(LOCAL:(LOCAL:0)):1 = 0
			ENDIF
		ELSE
			IF BASE:(LOCAL:(LOCAL:0)):1 <= 0
				CALL HEART_BREAK(LOCAL:(LOCAL:0))
			ENDIF
		ENDIF
	ENDIF
	
	;1キャラ分処理が終わったらWAIT
	CALL MSG_WAIT(1)
	
NEXT

IF TFLAG:54 > 0 && CFLAG:(TFLAG:54):50 >= 54 && CFLAG:(TFLAG:54):50 <= 58
;おねだり判断フラグ
	TFLAG:94 = 1
ENDIF

IF TFLAG:91 > 1
	TFLAG:91 -= 1
	GOTO MAIN_ACTION
ENDIF

;味方の攻撃。装備１の弾を消費する攻撃をしている。道具戦闘が１より大きい。装備２の残弾が十分。装備１と装備２が同じ。
IF TFLAG:55 == 0 && TFLAG:80 > 0 && ABL:(TFLAG:51):4 > 1 && CFLAG:(TFLAG:51):18 >= TFLAG:80 && CFLAG:(TFLAG:51):7 == CFLAG:(TFLAG:51):8
	TFLAG:81 = TFLAG:80
	TFLAG:80 = 0
	RESTART
ENDIF

;誤動作防止のため敵の最大攻撃回数を0に再設定
CALL SET_ENEMY_ATTACK_TIMES(0)
