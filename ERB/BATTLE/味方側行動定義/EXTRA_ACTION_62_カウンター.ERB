;カウンター
@EXTRA_ACTION_62(CHARA_ID, ENEMY_ID)
#DIM CHARA_ID
#DIM ENEMY_ID
;LOCAL
;0	LOOP
;1	当たったかどうか
;2	ダメージ
;3	攻撃力
;4	防御力(今の所未使用)
;5	属性倍率
;6	命中率
;7	TEMP
;8	関連スキル


VARSET LOCAL, 0, 1, 9

;----- 攻撃力計算 -----
;ひるんだり押し倒されて行動が変わるとカウンターコマンド選択時に仕込んだどの装備を使ったかが保存されずダメージ0になる
LOCAL:3 = EQUIP_POWER(CFLAG:CHARA_ID:(6 + CFLAG:CHARA_ID:50 / 100), CHARA_ID)

;体術・剣技補正
IF TALENT:CHARA_ID:161 == 2 && (CFLAG:CHARA_ID:(6 + CFLAG:CHARA_ID:50 / 100) == 12 || CFLAG:CHARA_ID:(6 + CFLAG:CHARA_ID:50 / 100) == 16)
	LOCAL:3 += ABL:CHARA_ID:98 / 4
ELSEIF TALENT:CHARA_ID:161 == 1
	LOCAL:3 += ABL:CHARA_ID:98 / 5
ENDIF

;基本値
LOCAL:2 = LOCAL:3 * 80

;TP倍率
LOCAL:7 = 0
IF BASE:CHARA_ID:4 >= 100
	LOCAL:7 = BASE:CHARA_ID:4
ELSE
	LOCAL:7 = 100 - (100 - BASE:CHARA_ID:4) / 2
ENDIF
LOCAL:2 = LOCAL:2 * LOCAL:7 / 100



;対応スキルのレベル倍率
LOCAL:7 = 0
LOCAL:8 = 4

IF ABL:CHARA_ID:(LOCAL:8) == 0
	LOCAL:7 = 100
ELSEIF ABL:CHARA_ID:(LOCAL:8) == 1
	LOCAL:7 = 120
ELSEIF ABL:CHARA_ID:(LOCAL:8) == 2
	LOCAL:7 = 150
ELSE
	LOCAL:7 = 200
ENDIF
LOCAL:2 = LOCAL:2 * LOCAL:7 / 100


;媚薬装備中は威力2倍
CALL GET_EQUIP_BONUS(CHARA_ID, 39)
IF RESULT
	LOCAL:2 *= 2
ENDIF


;前進中は威力1.2倍
IF CFLAG:CHARA_ID:34
	LOCAL:2 = LOCAL:2 * 12 / 10
ENDIF

;乱数加算および桁補正
LOCAL:2 = LOCAL:2 * (90 + RAND:11 + RAND:11) / 1000


;----- 属性倍率計算 -----
LOCAL:5 = 100
IF DA:ENEMY_ID:0 == 5 || DA:ENEMY_ID:0 == 6 || DA:ENEMY_ID:0 == 15 || DA:ENEMY_ID:0 == 16
	;敵が植物系の場合、炎属性・炎攻撃は1.5倍
	IF TFLAG:56 == 3 || TFLAG:56 == 4
		LOCAL:5 = 150
	ENDIF
ELSEIF DA:ENEMY_ID:0 == 13
	;敵がスライムの場合、攻撃・消耗武器以外は0.5倍
	IF TFLAG:56 == 1 || TFLAG:56 == 3
		LOCAL:5 = 50
	ENDIF
ELSEIF DA:ENEMY_ID:0 == 14
	;敵がブロブの場合、消耗武器以外は0.5倍
	IF TFLAG:56 == 0 || TFLAG:56 == 1 || TFLAG:56 == 3 || TFLAG:56 == 4
		LOCAL:5 = 50
	ENDIF
ENDIF

LOCAL:2 = LOCAL:2 * LOCAL:5 / 100

CALL PRINT_MESSAGE(CHARA_ID, 51, ENEMY_ID, CALLNAME:CHARA_ID, SAVESTR:ENEMY_ID, LOCAL:2)
PRINTFORML %SAVESTR:ENEMY_ID%に{LOCAL:2}のダメージ！
DA:ENEMY_ID:1 -= LOCAL:2

