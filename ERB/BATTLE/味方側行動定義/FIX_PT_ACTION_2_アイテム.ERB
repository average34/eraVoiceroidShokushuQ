;アイテム使用
;CHARA_ID	実行キャラ
@FIX_PT_ACTION_2(CHARA_ID)
#DIM CHARA_ID

;実処理はTFLAG:99に任せる

TFLAG:51 = CHARA_ID
TFLAG:54 = CFLAG:CHARA_ID:51
TFLAG:55 = 6
TFLAG:99 = 2
TFLAG:65 = CFLAG:CHARA_ID:54
TFLAG:60 = 1

CALL PRINT_MESSAGE(CHARA_ID, 1, 2, CALLNAME:CHARA_ID, ITEMNAME:(CFLAG:CHARA_ID:54), CFLAG:CHARA_ID:54, CFLAG:CHARA_ID:51)



@EXTRA_ACTION_2(USE_CHARA_ID, TARGET_CHARA_ID)
#DIM USE_CHARA_ID
#DIM TARGET_CHARA_ID
;LOCAL
;0	LOOP
;1	効果が無いかどうか

LOCAL:1 = 0

;誰かが先に使いきった場合、何も起きない
IF ITEM:(TFLAG:65) == 0
	PRINTFORML しかしもうアイテムが残っていなかった！
	RETURN
ENDIF

;万能薬・気付け薬・煙玉以外は、戦意喪失していると効果が無い
IF TFLAG:65 != 57 && TFLAG:65 != 58 && TFLAG:65 != 59 && CFLAG:TARGET_CHARA_ID:29
	LOCAL:1 = 1
ENDIF

;気付け薬は戦意喪失していないと効果が無い
IF TFLAG:65 == 58 && CFLAG:TARGET_CHARA_ID:29 == 0
	LOCAL:1 = 1
ENDIF

;HP/MP/CP 回復薬は、折角なので元々全快しているかどうか確認しておく
IF (TFLAG:65 == 50 || TFLAG:65 == 51) && BASE:TARGET_CHARA_ID:0 >= MAXBASE:TARGET_CHARA_ID:0
	LOCAL:1 = 1
ENDIF
IF (TFLAG:65 == 52 || TFLAG:65 == 53) && BASE:TARGET_CHARA_ID:1 >= MAXBASE:TARGET_CHARA_ID:1
	LOCAL:1 = 1
ENDIF
IF TFLAG:65 == 54 && BASE:TARGET_CHARA_ID:3 >= MAXBASE:TARGET_CHARA_ID:3
	LOCAL:1 = 1
ENDIF

IF LOCAL:1
	PRINTFORML しかし効果が無かった！
	RETURN
ENDIF

;◆触手スーツ時のみ別メッセージ
IF TFLAG:65 == 54 && CFLAG:TARGET_CHARA_ID:40 == 1
	CALL PRINT_MESSAGE(TARGET_CHARA_ID, 440, 16, CALLNAME:TARGET_CHARA_ID, ITEMNAME:(TFLAG:65), USE_CHARA_ID)
ELSE
	CALL PRINT_MESSAGE(TARGET_CHARA_ID, 36, TFLAG:65, CALLNAME:TARGET_CHARA_ID, ITEMNAME:(TFLAG:65), USE_CHARA_ID)
ENDIF
;◆◆

;以下、各種アイテムの効果発動
SELECTCASE TFLAG:65
	CASE 50
		CALL ADD_FEELING(TARGET_CHARA_ID, 3)
		BASE:TARGET_CHARA_ID:0 += MAXBASE:TARGET_CHARA_ID:0 / 2
		IF BASE:TARGET_CHARA_ID:0 > MAXBASE:TARGET_CHARA_ID:0
			BASE:TARGET_CHARA_ID:0 = MAXBASE:TARGET_CHARA_ID:0
		ENDIF
	CASE 51
		CALL ADD_FEELING(TARGET_CHARA_ID, 5)
		BASE:TARGET_CHARA_ID:0 = MAXBASE:TARGET_CHARA_ID:0
	CASE 52
		CALL ADD_FEELING(TARGET_CHARA_ID, 5)
		BASE:TARGET_CHARA_ID:1 += MAXBASE:TARGET_CHARA_ID:1 / 4
		;使用者が【鼓舞】持ちだと効果増加　ただし煙幕・砂煙・発情・寄生or妊娠末期は無理
		SIF TALENT:USE_CHARA_ID:118 && CFLAG:USE_CHARA_ID:26 == 0 && CFLAG:USE_CHARA_ID:27 == 0 && CFLAG:USE_CHARA_ID:28 == 0 && (CFLAG:USE_CHARA_ID:22 == 0 || CFLAG:USE_CHARA_ID:23 >= 5)
			BASE:TARGET_CHARA_ID:1 += MAXBASE:TARGET_CHARA_ID:1 / 8

		IF BASE:TARGET_CHARA_ID:1 > MAXBASE:TARGET_CHARA_ID:1
			BASE:TARGET_CHARA_ID:1 = MAXBASE:TARGET_CHARA_ID:1
		ENDIF
	CASE 53
		CALL ADD_FEELING(TARGET_CHARA_ID, 10)
		BASE:TARGET_CHARA_ID:1 += MAXBASE:TARGET_CHARA_ID:1 / 2
		;使用者が【鼓舞】持ちだと効果増加　ただし煙幕・砂煙・発情・寄生or妊娠末期は無理
		SIF TALENT:USE_CHARA_ID:118 && CFLAG:USE_CHARA_ID:26 == 0 && CFLAG:USE_CHARA_ID:27 == 0 && CFLAG:USE_CHARA_ID:28 == 0 && (CFLAG:USE_CHARA_ID:22 == 0 || CFLAG:USE_CHARA_ID:23 >= 5)
			BASE:TARGET_CHARA_ID:1 += MAXBASE:TARGET_CHARA_ID:1 / 4

		IF BASE:TARGET_CHARA_ID:1 > MAXBASE:TARGET_CHARA_ID:1
			BASE:TARGET_CHARA_ID:1 = MAXBASE:TARGET_CHARA_ID:1
		ENDIF
	CASE 54
		CALL ADD_FEELING(TARGET_CHARA_ID, 5)
		;CPが残っていれば汚れも回復
		BASE:TARGET_CHARA_ID:5 *= (MAXBASE:TARGET_CHARA_ID:3 - BASE:TARGET_CHARA_ID:3) / MAXBASE:TARGET_CHARA_ID:3
		BASE:TARGET_CHARA_ID:3 = MAXBASE:TARGET_CHARA_ID:3
		;◆触手スーツ
		IF ((FLAG:(FLAG:5 + 50) + RAND:250) >= 200 && CFLAG:TARGET_CHARA_ID:40 == 0) || CFLAG:(LOCAL:51):501 == 15 || CFLAG:(LOCAL:51):501 == 22
			CALL SYOKUSYU_HUKU_B(TARGET_CHARA_ID)
		ENDIF
		;◆◆
	CASE 55
		BASE:TARGET_CHARA_ID:2 = MAXBASE:TARGET_CHARA_ID:2
		BASE:TARGET_CHARA_ID:4 = 0
		
		;BC勃起75%減衰
		CALL ERECTION_B(TARGET_CHARA_ID, -(GET_ERECTION_LEVEL_B(TARGET_CHARA_ID) * 75 / 100), 1)
		CALL ERECTION_C(TARGET_CHARA_ID, -(GET_ERECTION_LEVEL_C(TARGET_CHARA_ID) * 75 / 100), 1)
		
	CASE 56
		BASE:TARGET_CHARA_ID:4 = MAXBASE:TARGET_CHARA_ID:4
		;◆発情レベル
		CFLAG:TARGET_CHARA_ID:28 = LIMIT(CFLAG:TARGET_CHARA_ID:28 + 1, 1, 5)
		
		;BC勃起MAX増加
		;勃起処理は各種関数で増加値が補正されるので最大値を渡す
		CALL ERECTION_B(TARGET_CHARA_ID, 100, 1)
		CALL ERECTION_C(TARGET_CHARA_ID, 200, 1)
		
		;◆◆
	CASE 57
		CALL ADD_FEELING(TARGET_CHARA_ID, 5)
		CFLAG:TARGET_CHARA_ID:22 = 0
		CFLAG:TARGET_CHARA_ID:23 = 0
		CFLAG:TARGET_CHARA_ID:24 = 0
		CFLAG:TARGET_CHARA_ID:25 = 0
		CFLAG:TARGET_CHARA_ID:26 = 0
		CFLAG:TARGET_CHARA_ID:27 = 0
		CFLAG:TARGET_CHARA_ID:300 = 0
		CFLAG:TARGET_CHARA_ID:301 = 0
		CFLAG:TARGET_CHARA_ID:302 = 0
		CFLAG:TARGET_CHARA_ID:303 = 0
		CFLAG:TARGET_CHARA_ID:80 = LIMIT(CFLAG:TARGET_CHARA_ID:80 - 6, 0, __INT_MAX__)

	CASE 58
		CALL ADD_FEELING(TARGET_CHARA_ID, 20)
		BASE:TARGET_CHARA_ID:1 = MAXBASE:TARGET_CHARA_ID:1 / 4
		;使用者が【治療】持ちだと効果増加　ただし煙幕・砂煙・発情・寄生or妊娠末期は無理
		SIF TALENT:USE_CHARA_ID:117 && CFLAG:USE_CHARA_ID:26 == 0 && CFLAG:USE_CHARA_ID:27 == 0 && CFLAG:USE_CHARA_ID:28 == 0 && (CFLAG:USE_CHARA_ID:22 == 0 || CFLAG:USE_CHARA_ID:23 >= 5)
			BASE:TARGET_CHARA_ID:1 += MAXBASE:TARGET_CHARA_ID:1 / 4

		CFLAG:TARGET_CHARA_ID:29 = 0
	CASE 59
		TFLAG:12 = 1
	CASE 71
		FLAG:(50 + FLAG:5) = MAX(FLAG:(50 + FLAG:5) - 50, 0)
	CASEELSE
		PRINTFORMW (EXTRA_ACTION_2)不正なアイテムが使用されました(ID:{TFLAG:65})
ENDSELECT

CALL ADD_ITEM(TFLAG:65, -1, 0)


;◆触手スーツ
@SYOKUSYU_HUKU_B(CHARA_ID)
#DIM CHARA_ID
;LOCALリスト
;0　ループ用
;1　ダメージ乱数
CALL PRINT_MESSAGE(CHARA_ID, 440, 0, CALLNAME:CHARA_ID, "")
FOR LOCAL:0, 0, 15
	TFLAG:63 = RAND:4
	LOCAL:1 = RAND:5
	CALL DAMAGE_COMMON(CHARA_ID, 2, 30*(LOCAL:1+10) * (TALENT:CHARA_ID:(101+TFLAG:63) + 2), 50)
NEXT

;戦闘中はさすがに悪あがき不可。とりあえず、地の文変更はなしで
CALL PRINT_MESSAGE(CHARA_ID, 440, 5, CALLNAME:CHARA_ID, "")

CALL PRINT_MESSAGE(CHARA_ID, 440, 15, CALLNAME:CHARA_ID, "")

CALL ADD_ABL_EXP(11, CHARA_ID, 100)
CFLAG:CHARA_ID:40 = 1
;◆◆


