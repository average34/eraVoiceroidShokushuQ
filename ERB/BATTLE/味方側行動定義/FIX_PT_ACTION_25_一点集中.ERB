;一点集中
;CHARA_ID	実行キャラ
;EQUIP_NO	装備１と２のどちらなのか
@FIX_PT_ACTION_25(CHARA_ID, EQUIP_NO)
#DIM CHARA_ID
#DIM EQUIP_NO

TFLAG:51 = CHARA_ID
TFLAG:53 = CFLAG:CHARA_ID:51
TFLAG:55 = 0
IF TFLAG:67 == 3
	TFLAG:56 = 3
	FLAG:(FLAG:5 + 50) -= RAND:3
	SIF FLAG:(FLAG:5 + 50) < 0
		FLAG:(FLAG:5 + 50) = 0
;触手放射器は火炎放射器の逆効果
ELSEIF TFLAG:67 == 9
	TFLAG:56 = 2
	FLAG:(FLAG:5 + 50) += (2 + RAND:5)
	SIF FLAG:(FLAG:5 + 50) > 100
		FLAG:(FLAG:5 + 50) = 100
ELSE
	TFLAG:56 = 2
ENDIF
TFLAG:57 = EQUIP_POWER(TFLAG:67, CHARA_ID)

TFLAG:58 = 140
TFLAG:61 = 80
;【鷲の目】持ちはほんのり命中補正
IF TALENT:CHARA_ID:161
	TFLAG:61 += 5
ENDIF

;汚染度ＭＡＸかつ触手系武器を装備していた場合は命中率が上昇
SIF FLAG:(FLAG:5 + 50) == 100 && TFLAG:67 == 9
	TFLAG:61 += 30


TFLAG:(EQUIP_NO + 79) = 3
IF TALENT:CHARA_ID:53
	TFLAG:58 = TFLAG:58 * 11 / 10
ENDIF

TFLAG:68 = 150



CALL PRINT_MESSAGE(CHARA_ID, 1, 25, CALLNAME:CHARA_ID, "")

; ここから連撃パッチ、装備の組み合わせによってTFLAG:99が変動
; 連撃可能かどうかをチェック
;【鷲の目】を持ち、後列から攻撃した
IF TALENT:CHARA_ID:163 && CFLAG:CHARA_ID:34 == 0 
	; 装備1と2が同じ装備で残弾が2以上あった場合は通常の二丁撃ちなので弾く
	IF (CFLAG:CHARA_ID:7 == CFLAG:CHARA_ID:8) && CFLAG:CHARA_ID:18 >= 2 && CFLAG:CHARA_ID:17 >= 2
		TFLAG:99 = 63
	; 装備1と2が違うか、通常二丁撃ちの弾が足りない場合は連撃発動
	ELSE
		TFLAG:99 = 64
	ENDIF
;【鷲の目】を持っていないか、前列に居た場合は通常通り
ELSE
	TFLAG:99 = 63
ENDIF


;連撃発動
@EXTRA_ACTION_64(CHARA_ID, ENEMY_ID)
#DIM CHARA_ID
#DIM ENEMY_ID
PRINTFORMW %CALLNAME:CHARA_ID%は反動を利用して身を捩り、更なる攻撃を繰り出した！	

; 今回装備1の消耗武器で攻撃した
IF CFLAG:CHARA_ID:50 == 125

	; 装備2に消耗武器装備 & 残弾2以上なら射撃弱攻撃
	IF (CFLAG:CHARA_ID:8 >= 1 && CFLAG:CHARA_ID:8 <= 9) && CFLAG:CHARA_ID:18 >= 2
		TFLAG:67 = CFLAG:CHARA_ID:8
		TFLAG:50 = 20

		;TFLAG:99はすでに使っているのでこっちで無理矢理処理（攻撃内容は常に弱なので2）
		CFLAG:CHARA_ID:18 -= 2
		CALLFORM FIX_PT_ACTION_20(CHARA_ID, 2)

	; 攻撃用の装備品がないなら攻撃弱で攻撃
	; 当然装備２が非消耗でも弱攻撃
	ELSE
		TFLAG:50 = CFLAG:CHARA_ID:10
		CALLFORM FIX_PT_ACTION_10(CHARA_ID)
	ENDIF
	;装備1の弾薬も3減らす
	CFLAG:CHARA_ID:17 -= 3

; 今回装備2の消耗武器で攻撃した
ELSEIF CFLAG:CHARA_ID:50 == 225

	; 装備１に消耗武器装備 & 残弾2以上なら射撃弱攻撃
	IF (CFLAG:CHARA_ID:7 >= 1 && CFLAG:CHARA_ID:7 <= 9) && CFLAG:CHARA_ID:17 >= 2
		PRINTFORMW %CALLNAME:CHARA_ID%は反動を利用して身を捩り、更なる攻撃を繰り出した！	
		TFLAG:67 = CFLAG:CHARA_ID:7
		TFLAG:50 = 20

		;消耗武器使用時の弾薬消費がどういうわけか動いてない（TFLAG:99が競合してる？）のでこっちで無理矢理処理（攻撃内容は常に弱なので2
		CFLAG:CHARA_ID:17 -= 2
		CALLFORM FIX_PT_ACTION_20(CHARA_ID, 2)

	; 攻撃用の装備品がないなら攻撃弱で攻撃
	; 当然装備１が非消耗でも弱攻撃
	ELSE
		TFLAG:50 = CFLAG:CHARA_ID:10
		CALLFORM FIX_PT_ACTION_10(CHARA_ID)
	ENDIF
	;装備2の弾薬も3減らす
	CFLAG:CHARA_ID:18 -= 3
ENDIF

; -- 実際のダメージ処理 --------------------------------------------------------
CALL CHECK_ATTACK_0(TFLAG:51, ENEMY_ID)

; 攻撃命中
IF RESULT:0
	IF (TFLAG:50 / 10) == 1
		CALL ADD_ABL_EXP(3, TFLAG:51, 200 + RAND:200)
	ELSE
		CALL ADD_ABL_EXP(4, TFLAG:51, 200 + RAND:200)
	ENDIF
	CALL PRINT_MESSAGE(TFLAG:51, 11, TFLAG:50, CALLNAME:(TFLAG:51), SAVESTR:ENEMY_ID, RESULT:1)
	PRINTFORM %SAVESTR:ENEMY_ID%に
	SETCOLOR 0x70FFFF
	PRINTFORM {RESULT:1}
	RESETCOLOR
	PRINTFORML のダメージ！
	DA:ENEMY_ID:1 -= RESULT:1
	CALL CHANGE_TP(TFLAG:51, 1)
	
	IF TFLAG:50 == 60 && (CFLAG:(TFLAG:51):7 >= 20 && CFLAG:(TFLAG:51):7 <= 23)
		CALL PRINT_MESSAGE(TFLAG:51, 1, 60, CALLNAME:(TFLAG:51), ITEMNAME:(CFLAG:(TFLAG:51):7), CFLAG:(TFLAG:51):7, 2)
		CFLAG:(TFLAG:51):7 = 0
	ENDIF
	IF TFLAG:50 == 61 && (CFLAG:(TFLAG:51):8 >= 20 && CFLAG:(TFLAG:51):8 <= 23)
		CALL PRINT_MESSAGE(TFLAG:51, 1, 60, CALLNAME:(TFLAG:51), ITEMNAME:(CFLAG:(TFLAG:51):8), CFLAG:(TFLAG:51):8, 2)
		CFLAG:(TFLAG:51):8 = 0
	ENDIF
	
	;ダメージによる拘束キャラ救出判定
	IF DA:ENEMY_ID:1 > 0 && (DA:ENEMY_ID:10 || DA:ENEMY_ID:20)
		IF RAND:100 < (2 + LIMIT((RESULT:1 * 50 / DA:ENEMY_ID:2), 1, 10) + LIMIT((DA:ENEMY_ID:1 * 10 / DA:ENEMY_ID:2), 0, 5))
			CALL STATUS_RENEW_RELEASE(DA:ENEMY_ID:10, 0, 2)
			CALL STATUS_RENEW_RELEASE(DA:ENEMY_ID:20, 0, 2)
		ENDIF
	ENDIF
	
; 攻撃回避
ELSE
	IF (TFLAG:50 / 10) == 1
		CALL ADD_ABL_EXP(3, TFLAG:51, 300 + RAND:500)
	ELSE
		CALL ADD_ABL_EXP(4, TFLAG:51, 300 + RAND:500)
	ENDIF
	CALL PRINT_MESSAGE(TFLAG:51, 21, TFLAG:50, CALLNAME:(TFLAG:51), SAVESTR:ENEMY_ID, RESULT:1)
	CALL CHANGE_TP(TFLAG:51, 3)
ENDIF

