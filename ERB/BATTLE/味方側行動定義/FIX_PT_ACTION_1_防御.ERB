;防御
;CHARA_ID	実行キャラ
@FIX_PT_ACTION_1(CHARA_ID)
#DIM CHARA_ID

;全部こちらで処理するのでメイン処理不要
TFLAG:66 = 1

CALL PRINT_MESSAGE(CHARA_ID, 1, 1, CALLNAME:CHARA_ID, "")

IF CFLAG:CHARA_ID:7 >=1 && CFLAG:CHARA_ID:7 <= 8 && CFLAG:CHARA_ID:17 == 0 && ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:7)) >= 1 && ABL:CHARA_ID:4 >= 2 && CFLAG:CHARA_ID:20 == 0
	;装備１のリロード
	CALL PRINT_MESSAGE(CHARA_ID, 1, 1, CALLNAME:CHARA_ID, ITEMNAME:(CFLAG:CHARA_ID:7), 1, CFLAG:CHARA_ID:7)
	IF GET_MAX_BULLET(CFLAG:CHARA_ID:7) <= ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:7))
		CFLAG:CHARA_ID:17 = GET_MAX_BULLET(CFLAG:CHARA_ID:7)
		CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:7), -GET_MAX_BULLET(CFLAG:CHARA_ID:7), 0)
	ELSE
		CFLAG:CHARA_ID:17 = ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:7))
		CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:7), -ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:7)), 0)
	ENDIF

	IF CFLAG:CHARA_ID:18 == 0 && ITEM:(CFLAG:CHARA_ID:8) >= 1 && ABL:CHARA_ID:4 >= 3 && CFLAG:CHARA_ID:8 >=1 && CFLAG:CHARA_ID:8 < 10
		;道具戦闘レベルが３以上なら、同時にリロード
		CALL PRINT_MESSAGE(CHARA_ID, 1, 1, CALLNAME:CHARA_ID, ITEMNAME:(CFLAG:CHARA_ID:8), 1, CFLAG:CHARA_ID:8)
		IF GET_MAX_BULLET(CFLAG:CHARA_ID:8) <= ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8))
			CFLAG:CHARA_ID:18 = GET_MAX_BULLET(CFLAG:CHARA_ID:8)
			CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8), -GET_MAX_BULLET(CFLAG:CHARA_ID:8), 0)
		ELSE
			CFLAG:CHARA_ID:18 = ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8))
			CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8), -ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8)), 0)
		ENDIF
	ENDIF
ELSEIF CFLAG:CHARA_ID:8 >=1 && CFLAG:CHARA_ID:8 <= 8 && CFLAG:CHARA_ID:18 == 0 && ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8)) >= 1 && ABL:CHARA_ID:4 >= 2 && CFLAG:CHARA_ID:20 == 0
	;装備２のリロード
	CALL PRINT_MESSAGE(CHARA_ID, 1, 1, CALLNAME:CHARA_ID, ITEMNAME:(CFLAG:CHARA_ID:8), 1, CFLAG:CHARA_ID:8)
	IF GET_MAX_BULLET(CFLAG:CHARA_ID:8) <= ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8))
		CFLAG:CHARA_ID:18 = GET_MAX_BULLET(CFLAG:CHARA_ID:8)
		CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8), -GET_MAX_BULLET(CFLAG:CHARA_ID:8), 0)
	ELSE
		CFLAG:CHARA_ID:18 = ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8))
		CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8), -ITEM:(GET_BULLET_ITEMID(CFLAG:CHARA_ID:8)), 0)
	ENDIF
ENDIF

;ユニーク武器追加パッチ　【☆触手放射器】の再装填処理
;LOCAL
;0	搾精回数計算用A
;1	MP回復量計算用？
;2	射精量計算用
;3	搾精回数計算用B

LOCAL:2 = EXP:CHARA_ID:12
;装備者にチンコついてないと再装填できない（素質じゃないとダメ）
IF (CFLAG:CHARA_ID:7 == 9 || CFLAG:CHARA_ID:8 == 9) && TALENT:CHARA_ID:121 != 0 && CFLAG:CHARA_ID:20 == 0
	;弾がフル装填だろうが強制的に搾精される・射精量に応じて装填
	CALL PRINT_MESSAGE(CHARA_ID, 448, 0, CALLNAME:CHARA_ID)
		;搾精回数は対象の自慰＋触手＋射精中毒の合計値からランダム（最低5回）
		LOCAL:0 = 5 + RAND:((ABL:CHARA_ID:10) + (ABL:CHARA_ID:11) + (ABL:CHARA_ID:12))
		$TT_RELOAD
		TFLAG:57 = 230
		TFLAG:63 = 2
		CALL DAMAGE_COMMON(CHARA_ID, 2, 105 * (RAND:150 + 30) * (TALENT:CHARA_ID:(101+TFLAG:63) + 1), 100)
		LOCAL:3 += 1
		IF LOCAL:3 < LOCAL:0
			GOTO TT_RELOAD
		ELSE
			CALL ADD_ABL_EXP(11, CHARA_ID, RAND:20 + LOCAL:0)
		ENDIF
	;射精経験の差分から射精回数算出
	LOCAL:2 = EXP:CHARA_ID:12 - LOCAL:2 
	;ふたなりのオプションによって射精量増減
	;玉ありなら+2、巨玉爆玉なら+3、超巨玉なら+4
	IF TALENT:CHARA_ID:180 == 1
		LOCAL:2 = LOCAL:2 + 2
	ELSEIF TALENT:CHARA_ID:180 >= 2 && TALENT:CHARA_ID:180 <= 3
		LOCAL:2 = LOCAL:2 + 3
	ELSEIF TALENT:CHARA_ID:180 == 4
		LOCAL:2 = LOCAL:2 + 4
	ENDIF
	;少量射精なら半分、大量なら+2、超大量なら+3
	IF TALENT:CHARA_ID:185 == 1
		LOCAL:2 = LOCAL:2 / 2
	ELSEIF TALENT:CHARA_ID:185 >= 2 && TALENT:CHARA_ID:185 <= 3
		LOCAL:2 = LOCAL:2 + 2
	ELSEIF TALENT:CHARA_ID:185 == 4
		LOCAL:2 = LOCAL:2 + 3
	ENDIF
	;精液薄めなら半分、濃厚なら+3、特濃なら+4
	IF TALENT:CHARA_ID:186 == 1
		LOCAL:2 = LOCAL:2 / 2
	ELSEIF TALENT:CHARA_ID:186 >= 2 && TALENT:CHARA_ID:186 <= 3
		LOCAL:2 = LOCAL:2 + 3
	ELSEIF TALENT:CHARA_ID:186 == 4
		LOCAL:2 = LOCAL:2 + 4
	ENDIF
	;搾り取った精液を触手放射器に装填
	IF CFLAG:CHARA_ID:7 == 9
		CFLAG:CHARA_ID:17 = LIMIT(CFLAG:CHARA_ID:17 + LOCAL:2, 0, GET_MAX_BULLET(9))
		CALL PRINT_MESSAGE(CHARA_ID, 448, 1, CALLNAME:CHARA_ID, ITEMNAME:(CFLAG:CHARA_ID:7), LOCAL:2)
	ELSEIF CFLAG:CHARA_ID:8 == 9
		CFLAG:CHARA_ID:18 = LIMIT(CFLAG:CHARA_ID:18 + LOCAL:2, 0, GET_MAX_BULLET(9))
		CALL PRINT_MESSAGE(CHARA_ID, 448, 1, CALLNAME:CHARA_ID, ITEMNAME:(CFLAG:CHARA_ID:8), LOCAL:2)
	ENDIF
	;念のためLOCAL:2と3を0に
	LOCAL:2 = 0
	LOCAL:3 = 0
ENDIF

;防御状態はターン開始時の処理で自動的に付与されているので、MPの回復だけ行う

LOCAL:1 = MAXBASE:CHARA_ID:1 / 200

PRINTFORML %CALLNAME:CHARA_ID%のMPが{LOCAL:1}回復した！

BASE:CHARA_ID:1 += LOCAL:1

IF BASE:CHARA_ID:1 > MAXBASE:CHARA_ID:1
	BASE:CHARA_ID:1 = MAXBASE:CHARA_ID:1
ENDIF

