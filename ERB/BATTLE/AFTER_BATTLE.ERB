;戦闘終了後の処理（味方）
;ARG:0	対象ID
@AFTER_BATTLE(CHARA_ID)
#DIM CHARA_ID
#DIM LCOUNT
#DIM BULLET_ADD_COUNT
#DIM CHECK_NINSHIN

SIF CHARA_ID == 0
	RETURN

;戦闘中のみの内容をリセット
CFLAG:CHARA_ID:24 = 0
CFLAG:CHARA_ID:25 = 0
CFLAG:CHARA_ID:26 = 0
CFLAG:CHARA_ID:27 = 0
CFLAG:CHARA_ID:30 = 0
CFLAG:CHARA_ID:31 = 0
CFLAG:CHARA_ID:32 = 0
CFLAG:CHARA_ID:33 = 0
CFLAG:CHARA_ID:34 = 0
CFLAG:CHARA_ID:39 = 0
CFLAG:CHARA_ID:43 = 0
CFLAG:CHARA_ID:50 = 0
CFLAG:CHARA_ID:51 = 0
CFLAG:CHARA_ID:52 = 0
CFLAG:CHARA_ID:53 = 0
CFLAG:CHARA_ID:54 = 0
CFLAG:CHARA_ID:55 = 0
CFLAG:CHARA_ID:59 = 0
CFLAG:CHARA_ID:99 = 0
CFLAG:CHARA_ID:200 = 0
CFLAG:CHARA_ID:202 = 0


;●りばーすでの追加系

CFLAG:CHARA_ID:300 = 0
CFLAG:CHARA_ID:301 = 0
CFLAG:CHARA_ID:302 = 0
CFLAG:CHARA_ID:303 = 0
CFLAG:CHARA_ID:304 = 0
CFLAG:CHARA_ID:305 = 0
CFLAG:CHARA_ID:306 = 0


IF CFLAG:CHARA_ID:35
	;絶頂していた場合、回復と同時にEPも全快
	BASE:CHARA_ID:2 = MAXBASE:CHARA_ID:2
	CFLAG:CHARA_ID:35 = 0
ENDIF


IF CFLAG:CHARA_ID:20
	;戦闘終了時に拘束されていた場合、戦闘後も引き継ぐ
	;ただし、先客が居ない場合のみ
	IF DA:(CFLAG:CHARA_ID:20):10 == 0 
		CFLAG:CHARA_ID:10 = CFLAG:CHARA_ID:20
	ELSE
		CFLAG:CHARA_ID:20 = 0
		CFLAG:CHARA_ID:21 = 0
	ENDIF
ENDIF


;妊娠チェック
IF CFLAG:CHARA_ID:60 && CFLAG:CHARA_ID:22 == 0
	;触手中毒による増加
	CFLAG:CHARA_ID:60 = CFLAG:CHARA_ID:60 * (ABL:CHARA_ID:11 + 2) / 2
	;蓬莱人か薬毒耐性で妊娠確率半減
	IF TALENT:CHARA_ID:56 || TALENT:CHARA_ID:128
		CFLAG:CHARA_ID:60 /= 2
	ENDIF
	;母乳体質で確率倍加
	IF TALENT:CHARA_ID:130
		CFLAG:CHARA_ID:60 *= 2
	ENDIF
	;小柄体型or幼稚で確率少しダウン
	IF TALENT:CHARA_ID:100 || TALENT:CHARA_ID:132
		CFLAG:CHARA_ID:60 = CFLAG:CHARA_ID:60 * 8 / 10
	ENDIF
	;封印卵巣解除後で確率増加
	IF CFLAG:(CHARA_ID):509 == 2
		CFLAG:CHARA_ID:60 = CFLAG:CHARA_ID:60 * 15 / 10
	ENDIF
	
	CHECK_NINSHIN = LIMIT((CFLAG:CHARA_ID:60 + 15), 25, 70)
	CHECK_NINSHIN = LIMIT((CHECK_NINSHIN + (CFLAG:CHARA_ID:60 / 50 * 5)), 25, 95)
	
	CALL DOUKA_EFFECT_1(CHARA_ID, CHECK_NINSHIN)
	IF RESULT > 0
		CHECK_NINSHIN = LIMIT(CHECK_NINSHIN + RESULT:1, 25, 95)
	ENDIF
	
	;処女は確率激減
	IF TALENT:CHARA_ID:0
		CHECK_NINSHIN /= 10
	ENDIF
	
	;卵巣パッチONでメス嫁苗床卵巣だと2割増加
	IF TALENT:CHARA_ID:137 == 5
		CHECK_NINSHIN = CHECK_NINSHIN * 12 / 10
	ENDIF

	;************避妊パッチ********************	
	SIF CFLAG:CHARA_ID:70
		CHECK_NINSHIN /= CFLAG:CHARA_ID:70 * 25
	;******************************************

	IF RAND:100 < CHECK_NINSHIN
		CHECK_NINSHIN = 1
		FOR LCOUNT, 0, (3 + CFLAG:CHARA_ID:60 / 50)
			IF RAND:100 < 30
				CHECK_NINSHIN = 2
			ENDIF
		NEXT
		CALL PARASITE_TYPE(CHARA_ID, 1, CFLAG:CHARA_ID:57, 8 + LIMIT(RAND:4 + RAND:4 + RAND:4 + RAND:4, 1, 10), CHECK_NINSHIN)
	ELSE
		CHECK_NINSHIN = 0
	ENDIF
ENDIF

;C妊娠チェック
;玉は2つあるのでC寄生とC妊娠は一緒にできる
IF CFLAG:CHARA_ID:175
	;蓬莱人か薬毒耐性で妊娠確率半減
	IF TALENT:CHARA_ID:56 || TALENT:CHARA_ID:128
		CFLAG:CHARA_ID:175 /= 2
	ENDIF
	;竿が極太で確率倍加
	IF TALENT:CHARA_ID:171
		CFLAG:CHARA_ID:175 *= 3 / 2
	ENDIF
	;巨玉以上で確率増加
	IF TALENT:CHARA_ID:180 <= 1
		CFLAG:CHARA_ID:175 = CFLAG:CHARA_ID:175 * 5 / 10
	ELSEIF TALENT:CHARA_ID:180
		CFLAG:CHARA_ID:175 = CFLAG:CHARA_ID:175 * TALENT:CHARA_ID:180 * 7 / 10
	ENDIF

	;************避妊パッチ********************	
	SIF CFLAG:CHARA_ID:70
		CFLAG:CHARA_ID:175 /= CFLAG:CHARA_ID:70 * 25
	;******************************************

	IF RAND:100 < CFLAG:CHARA_ID:175
		CALL PARASITE_TYPE(CHARA_ID, 6, CFLAG:CHARA_ID:176, 8 + LIMIT(RAND:4 + RAND:4 + RAND:4 + RAND:4, 1, 10))
	ENDIF
ENDIF

CFLAG:CHARA_ID:57 = 0
CFLAG:CHARA_ID:60 = 0
CFLAG:CHARA_ID:175 = 0
CFLAG:CHARA_ID:176 = 0


IF FLAG:506
	;消耗武器を装備している場合、弾に余裕があるなら自動で補充
	FOR LCOUNT, 0, 3
		IF CFLAG:CHARA_ID:(7 + LCOUNT) >= 1 && CFLAG:CHARA_ID:(7 + LCOUNT) <= 9
			; 装備武器の残弾がMAX or 弾のストックが無いなら処理不要
			SIF (CFLAG:CHARA_ID:(17 + LCOUNT) == GET_MAX_BULLET(CFLAG:CHARA_ID:(7 + LCOUNT))) || ITEM:GET_BULLET_ITEMID(CFLAG:CHARA_ID:(7 + LCOUNT)) == 0
				CONTINUE
			
			; 残弾補充
			BULLET_ADD_COUNT = GET_MAX_BULLET(CFLAG:CHARA_ID:(7 + LCOUNT)) - CFLAG:CHARA_ID:(17 + LCOUNT)
			SIF BULLET_ADD_COUNT > ITEM:GET_BULLET_ITEMID(CFLAG:CHARA_ID:(7 + LCOUNT))
				BULLET_ADD_COUNT = ITEM:GET_BULLET_ITEMID(CFLAG:CHARA_ID:(7 + LCOUNT))
			CALL ADD_ITEM(GET_BULLET_ITEMID(CFLAG:CHARA_ID:(7 + LCOUNT)), -BULLET_ADD_COUNT, 0)
			CFLAG:CHARA_ID:(17 + LCOUNT) += BULLET_ADD_COUNT
			
			PRINTFORML %CALLNAME:CHARA_ID%が装備している%ITEMNAME:(CFLAG:CHARA_ID:(7 + LCOUNT))%の残弾を補充しました！（残弾：{CFLAG:CHARA_ID:(17 + LCOUNT)}  ストック：{ITEM:GET_BULLET_ITEMID(CFLAG:CHARA_ID:(7 + LCOUNT))}）
			CALL MSG_WAIT(1)
		ENDIF
	NEXT
ENDIF


;!!!戦闘後の自動回復とかもこの辺
IF CFLAG:CHARA_ID:29 == 0
	CALL GET_EQUIP_BONUS(CHARA_ID, 32)
	IF RESULT
		BASE:CHARA_ID:0 += MAXBASE:CHARA_ID:0 / 5
		IF BASE:CHARA_ID:0 > MAXBASE:CHARA_ID:0
			BASE:CHARA_ID:0 = MAXBASE:CHARA_ID:0
		ENDIF
	ENDIF
	CALL GET_EQUIP_BONUS(CHARA_ID, 33)
	IF RESULT
		BASE:CHARA_ID:1 += MAXBASE:CHARA_ID:1 / 10
		IF BASE:CHARA_ID:1 > MAXBASE:CHARA_ID:1
			BASE:CHARA_ID:1 = MAXBASE:CHARA_ID:1
		ENDIF
	ENDIF
	CALL GET_EQUIP_BONUS(CHARA_ID, 34)
	IF RESULT
		BASE:CHARA_ID:2 += MAXBASE:CHARA_ID:2 / 5
		IF BASE:CHARA_ID:2 > MAXBASE:CHARA_ID:2
			BASE:CHARA_ID:2 = MAXBASE:CHARA_ID:2
		ENDIF
	ENDIF
	CALL GET_EQUIP_BONUS(CHARA_ID, 35)
	IF RESULT && BASE:CHARA_ID:3 > 0
		BASE:CHARA_ID:3 += MAXBASE:CHARA_ID:3 / 3
		IF BASE:CHARA_ID:3 > MAXBASE:CHARA_ID:3
			BASE:CHARA_ID:3 = MAXBASE:CHARA_ID:3
		ENDIF
	ENDIF
	
	IF TALENT:1:117
		BASE:CHARA_ID:0 += MAXBASE:CHARA_ID:0 / 50
		IF BASE:CHARA_ID:0 > MAXBASE:CHARA_ID:0
			BASE:CHARA_ID:0 = MAXBASE:CHARA_ID:0
		ENDIF
	ENDIF
	IF FLAG:10 && TALENT:(FLAG:10):117
		BASE:CHARA_ID:0 += MAXBASE:CHARA_ID:0 / 50
		IF BASE:CHARA_ID:0 > MAXBASE:CHARA_ID:0
			BASE:CHARA_ID:0 = MAXBASE:CHARA_ID:0
		ENDIF
	ENDIF
	IF FLAG:11 && TALENT:(FLAG:11):117
		BASE:CHARA_ID:0 += MAXBASE:CHARA_ID:0 / 50
		IF BASE:CHARA_ID:0 > MAXBASE:CHARA_ID:0
			BASE:CHARA_ID:0 = MAXBASE:CHARA_ID:0
		ENDIF
	ENDIF
	
	IF TALENT:1:118
		BASE:CHARA_ID:1 += MAXBASE:CHARA_ID:1 / 100
		IF BASE:CHARA_ID:1 > MAXBASE:CHARA_ID:1
			BASE:CHARA_ID:1 = MAXBASE:CHARA_ID:1
		ENDIF
	ENDIF
	IF FLAG:10 && TALENT:(FLAG:10):118
		BASE:CHARA_ID:1 += MAXBASE:CHARA_ID:1 / 100
		IF BASE:CHARA_ID:1 > MAXBASE:CHARA_ID:1
			BASE:CHARA_ID:1 = MAXBASE:CHARA_ID:1
		ENDIF
	ENDIF
	IF FLAG:11 && TALENT:(FLAG:11):118
		BASE:CHARA_ID:1 += MAXBASE:CHARA_ID:1 / 100
		IF BASE:CHARA_ID:1 > MAXBASE:CHARA_ID:1
			BASE:CHARA_ID:1 = MAXBASE:CHARA_ID:1
		ENDIF
	ENDIF
	
	IF TALENT:CHARA_ID:153 && BASE:CHARA_ID:3 > 0
		BASE:CHARA_ID:3 += MAXBASE:CHARA_ID:3 / 10
		IF BASE:CHARA_ID:3 > MAXBASE:CHARA_ID:3
			BASE:CHARA_ID:3 = MAXBASE:CHARA_ID:3
		ENDIF
	ENDIF
ENDIF

;BC勃起減衰
;発情中は減衰率が低下します、喪失時は減衰しません
;発情中、もしくは現在勃起中のみメッセージ表示
;戦闘中一度も表示されていない勃起メッセージが減衰する違和感を避ける為
IF !CFLAG:CHARA_ID:29
	IF !CFLAG:CHARA_ID:28
		IF GET_ERECTION_LEVEL_B(CHARA_ID) > 0
			IF GET_ERECTION_STATE_B(CHARA_ID)
				CALL ERECTION_B(CHARA_ID, -(GET_ERECTION_LEVEL_B(CHARA_ID) * 50 / 100), 1)
			ELSE
				FLAG:20 = 1
				CALL ERECTION_B(CHARA_ID, -(GET_ERECTION_LEVEL_B(CHARA_ID) * 50 / 100), 2)
				FLAG:20 = 0
			ENDIF
		ENDIF
		IF GET_ERECTION_LEVEL_C(CHARA_ID) > 0
			IF GET_ERECTION_STATE_C(CHARA_ID)
				CALL ERECTION_C(CHARA_ID, -(GET_ERECTION_LEVEL_C(CHARA_ID) * 50 / 100), 1)
			ELSE
				FLAG:20 = 1
				CALL ERECTION_C(CHARA_ID, -(GET_ERECTION_LEVEL_C(CHARA_ID) * 50 / 100), 2)
				FLAG:20 = 0
			ENDIF
		ENDIF
	ELSE
		SIF GET_ERECTION_LEVEL_B(CHARA_ID) > 0
			CALL ERECTION_B(CHARA_ID, -(GET_ERECTION_LEVEL_B(CHARA_ID) * 25 / 100), 1)
		SIF GET_ERECTION_LEVEL_C(CHARA_ID) > 0
			CALL ERECTION_C(CHARA_ID, -(GET_ERECTION_LEVEL_C(CHARA_ID) * 25 / 100), 1)
	ENDIF
ENDIF


;戦闘終了後の処理（敵）
;ARG:0	対象ID
@AFTER_BATTLE_E(ENEMY_ID)
#DIM ENEMY_ID

;戦闘中のみの内容をリセット
DA:ENEMY_ID:24 = 0
DA:ENEMY_ID:25 = 0
DA:ENEMY_ID:26 = 0
DA:ENEMY_ID:27 = 0
DA:ENEMY_ID:30 = 0
DA:ENEMY_ID:31 = 0
DA:ENEMY_ID:32 = 0
DA:ENEMY_ID:33 = 0
DA:ENEMY_ID:34 = 0
DA:ENEMY_ID:35 = 0
DA:ENEMY_ID:50 = 0
DA:ENEMY_ID:51 = 0
DA:ENEMY_ID:52 = 0
DA:ENEMY_ID:53 = 0
DA:ENEMY_ID:80 = 0
DA:ENEMY_ID:81 = 0
DA:ENEMY_ID:36 = 0 ;肉盾フラグもリセット
DA:ENEMY_ID:37 = 0 ;火傷蓄積数もリセット
IF DA:ENEMY_ID:10 == 0
	IF DA:ENEMY_ID:72
		;戦闘終了時に拘束していた場合、戦闘後も引き継ぐ
		DA:ENEMY_ID:10 = DA:ENEMY_ID:72
	ENDIF
	IF DA:ENEMY_ID:71
		;戦闘終了時に拘束していた場合、戦闘後も引き継ぐ
		DA:ENEMY_ID:10 = DA:ENEMY_ID:71
	ENDIF
	IF DA:ENEMY_ID:70
		;戦闘終了時に拘束していた場合、戦闘後も引き継ぐ
		DA:ENEMY_ID:10 = DA:ENEMY_ID:70
	ENDIF
ENDIF
DA:ENEMY_ID:70 = 0
DA:ENEMY_ID:71 = 0
DA:ENEMY_ID:72 = 0

IF DA:ENEMY_ID:10 != 0 && DA:ENEMY_ID:10 != DA:ENEMY_ID:20
	;誰かを捕食中だが、捕食中キャラと拘束中キャラが異なる（＝２人同時拘束中の）場合、
	;現在の拘束キャラを捨て、捕食キャラと合せる
	CALL STATUS_RENEW_RELEASE(DA:ENEMY_ID:20)
	DA:ENEMY_ID:20 = DA:ENEMY_ID:10
	CFLAG:(DA:ENEMY_ID:10):20 = ENEMY_ID
ENDIF

;バグ対策
IF DA:ENEMY_ID:10 && CFLAG:(DA:ENEMY_ID:10):10 != ENEMY_ID
	;捕食している相手が、自分に捕食されている扱いになっていなかった場合、相手だけ差し替える
	;厳密に調整しようとすると逆にバグが増えそうなので、とりあえず応急処置
	IF CFLAG:(DA:ENEMY_ID:10):10
		DA:(CFLAG:(DA:ENEMY_ID:10):10):10 = 0
	ENDIF
	IF CFLAG:(DA:ENEMY_ID:10):20
		DA:(CFLAG:(DA:ENEMY_ID:10):20):20 = 0
	ENDIF
	CFLAG:(DA:ENEMY_ID:10):10 = ENEMY_ID
	CFLAG:(DA:ENEMY_ID:10):20 = ENEMY_ID
	DA:ENEMY_ID:20 = DA:ENEMY_ID:10
ENDIF

;!!!戦闘後の自動回復とかもこの辺




