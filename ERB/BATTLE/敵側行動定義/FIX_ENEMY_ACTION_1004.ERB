@FIX_ENEMY_ACTION_1004(ENEMY_ID)
#DIM ENEMY_ID

TFLAG:52 = ENEMY_ID
TFLAG:54 = DA:ENEMY_ID:51
TFLAG:55 = 5
TFLAG:60 = 1

TFLAG:57 = DA:ENEMY_ID:5

TFLAG:58 = 100
TFLAG:59 = 0

TFLAG:61 = 100
TFLAG:63 = 3
TFLAG:64 = 20
TFLAG:65 = 20


TFLAG:99 = 1004

CALL ACTION_FILTER(-1, 7, 1004, CALLNAME:(TFLAG:54), SAVESTR:ENEMY_ID, TFLAG:54)



@EXTRA_ACTION_1004(ENEMY_ID, CHARA_ID)
#DIM ENEMY_ID
#DIM CHARA_ID
;LOCAL
;1	命中率
;2	TEMP

;妊娠していなければ寄生すら上塗りして強制妊娠
IF CFLAG:CHARA_ID:36 == 0 && CFLAG:CHARA_ID:158 == 0
	IF RAND:500 < CFLAG:CHARA_ID:60
		CFLAG:CHARA_ID:22 = 0
		CFLAG:CHARA_ID:23 = 0
		CALL PARASITE_TYPE(CHARA_ID, 1, CFLAG:CHARA_ID:57, 8 + RAND:4 + RAND:4, 3)
	ENDIF
ELSEIF CFLAG:CHARA_ID:36
	CALL PRINT_MESSAGE(CHARA_ID, 17, TFLAG:99, CALLNAME:CHARA_ID, SAVESTR:CHARA_ID, CHARA_ID)
	CFLAG:CHARA_ID:23 -= 2 + RAND:4
	;出産処理
	IF CFLAG:CHARA_ID:23 <= 0
		
		;出産
		IF CFLAG:CHARA_ID:23 <= 0
			LOCAL:2 = RAND:2
			;コンフィグで男女比を弄られている場合、強制的にそちらに変更
			IF FLAG:511 == 1
				LOCAL:2 = 1
			ELSEIF FLAG:511 == 2
				LOCAL:2 = 0
			ENDIF

			;ウォッチャーのチェック
			FOR LOCAL:5 , 1, FLAG:1
				;ウォッチャーだとフラグ
				IF DA:(LOCAL:5):0 == 97
					DA:(LOCAL:5):4 = CFLAG:CHARA_ID:4
					LOCAL:11 += 1
					BREAK
				ENDIF
			NEXT
			;ウォッチャーがいる場合ライブ中継
			IF LOCAL:11
				CALL PRINT_MESSAGE(CHARA_ID, 127, 4, CALLNAME:CHARA_ID, "", LOCAL:2)
			ENDIF
			CALL PRINT_MESSAGE(CHARA_ID, 129, 0, CALLNAME:CHARA_ID, "", LOCAL:2)
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != CHARA_ID
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 148, 0, CALLNAME:CHARA_ID, "", CHARA_ID, LOCAL:2)
			NEXT
			CALL LOST_VIRGIN(CHARA_ID, 2, 6)
			CALL EXTASY(CHARA_ID, 3, 400, 3000)
			CALL PRINT_MESSAGE(CHARA_ID, 129, 1, CALLNAME:CHARA_ID, "", LOCAL:2)
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != CHARA_ID
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 148, 1, CALLNAME:CHARA_ID, "", CHARA_ID, LOCAL:2)
			NEXT
			CALL EXTASY(CHARA_ID, 1, 400, 2000)
			SIF TALENT:CHARA_ID:159 == 1
				CALL EXTASY(CHARA_ID, 1, 400, 2000)
			CALL ADD_ABL_EXP(11, CHARA_ID, 100)
			CALL PRINT_MESSAGE(CHARA_ID, 129, 2, CALLNAME:CHARA_ID, "", LOCAL:2)
			FOR LOCAL:0, 0, 3
				SIF GET_MEMBER(LOCAL:0) != CHARA_ID
					CALL PRINT_MESSAGE(GET_MEMBER(LOCAL:0), 148, 2, CALLNAME:CHARA_ID, "", CHARA_ID, LOCAL:2)
			NEXT
		ENDIF

		IF CFLAG:CHARA_ID:23 <= 0
			;生まれた場合の共通処理
			CALL ADD_FEELING(CHARA_ID, -10)
			BASE:CHARA_ID:0 = 0
				IF CFLAG:CHARA_ID:40 == 0 && (CFLAG:CHARA_ID:46 == 0 || CFLAG:CHARA_ID:501 != 100)
					BASE:CHARA_ID:3 = 0
					SIF CFLAG:CHARA_ID:44 >= 1
						CFLAG:CHARA_ID:44 = 0
				ENDIF
			;残り時間がスキップされた場合への対策
			SIF TALENT:CHARA_ID:130 == 0 && TALENT:CHARA_ID:108 == 0
				TALENT:CHARA_ID:130 = 1
			BASE:CHARA_ID:4 = 0
			IF LOCAL:2 == 0
				IF CFLAG:CHARA_ID:22 == 19
					CALL CREATE_ENEMY(17, 0, FLAG:5)
				ELSE
					CALL CREATE_ENEMY(CFLAG:CHARA_ID:22, 0, FLAG:5, CHARA_ID)
				ENDIF
			ELSE
				CALL CREATE_ENEMY(19, 0, FLAG:5, CHARA_ID)
			ENDIF
			;ED用
			IF EXP:CHARA_ID:22 == 0
				CALL ADD_HISTORY(DAY, CHARA_ID, CFLAG:CHARA_ID:22, 3)
			ENDIF
			;出産回数追加
			EXP:CHARA_ID:22 += 1
			
			CFLAG:CHARA_ID:22 = 0
			CFLAG:CHARA_ID:23 = 0
			CFLAG:CHARA_ID:36 = 0
			CFLAG:CHARA_ID:109 = 0
			;胸を育たなくするパッチ
			IF FLAG:521 == 1
				;豊乳化OFF設定なら無効
			ELSEIF FLAG:521 == 3 && TALENT:CHARA_ID:122 > 0
				;男の娘のみOFF設定かつ男の娘なら無効
			ELSE
				CALL ADD_BUST(CHARA_ID,1,2)
				;絶壁
				IF GET_BUST(CHARA_ID) <= -2
					SIF LOCAL:1
						CALL PRINT_MESSAGE(CHARA_ID, 427, 5, CALLNAME:CHARA_ID, "")
				;貧乳
				ELSEIF GET_BUST(CHARA_ID) == -1
					SIF LOCAL:1
						CALL PRINT_MESSAGE(CHARA_ID, 427, 0, CALLNAME:CHARA_ID, "")
				;普通
				ELSEIF GET_BUST(CHARA_ID) == 0
					SIF LOCAL:1
						CALL PRINT_MESSAGE(CHARA_ID, 427, 1, CALLNAME:CHARA_ID, "")
				;巨乳
				ELSEIF GET_BUST(CHARA_ID) == 1
					SIF LOCAL:1
						CALL PRINT_MESSAGE(CHARA_ID, 427, 2, CALLNAME:CHARA_ID, "")
				;爆乳
				ELSEIF GET_BUST(CHARA_ID) == 2
					IF LOCAL:1
						CALL PRINT_MESSAGE(CHARA_ID, 427, 3, CALLNAME:CHARA_ID, "")
						;爆乳でも育つ
					ENDIF
				;超乳
				ELSEIF GET_BUST(CHARA_ID) >= 3
					IF LOCAL:1
						CALL PRINT_MESSAGE(CHARA_ID, 427, 6, CALLNAME:CHARA_ID, "")
					ENDIF
				ENDIF
				IF GET_BUST(CHARA_ID) >= 2
					CALL MILK_COME(CHARA_ID, 1, 2)
					CALL MILK_ADJUST(CHARA_ID, 0)
				ENDIF
			ENDIF
		ENDIF
		CFLAG:CHARA_ID:22 = 0
		CFLAG:CHARA_ID:23 = 0
		CFLAG:CHARA_ID:36 = 0
		CFLAG:CHARA_ID:109 = 0
	ENDIF
ENDIF


