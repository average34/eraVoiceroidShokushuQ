@FIX_ENEMY_ACTION_1036(ENEMY_ID)
#DIM ENEMY_ID

TFLAG:52 = ENEMY_ID
TFLAG:54 = DA:ENEMY_ID:51
TFLAG:55 = 3
TFLAG:60 = 1

TFLAG:57 = DA:ENEMY_ID:5

TFLAG:58 = 10000 / TFLAG:57 + 200
TFLAG:61 = 150

TFLAG:64 = 20
TFLAG:65 = 40

TFLAG:59 = 0
TFLAG:90 = 600
TFLAG:91 = 0
TFLAG:92 = 0

TFLAG:63 = 5

TFLAG:99 = 1036

CALL ACTION_FILTER(-1, 4, 1036, CALLNAME:(TFLAG:54), SAVESTR:ENEMY_ID, TFLAG:54)

@EXTRA_ACTION_1036(ENEMY_ID, CHARA_ID)
#DIM ENEMY_ID
#DIM CHARA_ID

IF FLAG:538 == 0 || FLAG:999 || CFLAG:CHARA_ID:104
	;コンフィグで悪堕ちOFF/対象が娘→悪落ちなし
	TFLAG:98 = -2
ELSEIF FLAG:507 == 0 || FLAG:538 == 1 || CHARA_ID == 1 || FLAG:15 >= 10
	;コンフィグで同族堕ちOFF/対象が主人公/敵10体以上→悪落ちポイント追加のみ
	CFLAG:CHARA_ID:160 = (CFLAG:CHARA_ID:160) + 10
	TFLAG:98 = -1
ELSE
	;同族堕ちあり
	;悪落ちポイント追加。喪失状態だと上がりやすい
	IF CFLAG:CHARA_ID:29
		CFLAG:CHARA_ID:160 = CFLAG:CHARA_ID:160 * 2 + 10
	ELSE
		CFLAG:CHARA_ID:160 = CFLAG:CHARA_ID:160 * 3 / 2 + 5
	ENDIF
	;同族堕ち判定
	IF CFLAG:CHARA_ID:5 / 2 < CFLAG:CHARA_ID:160
		TFLAG:98 = 2 ;堕ちた
	ELSE
		IF CFLAG:CHARA_ID:5 / 3 < CFLAG:CHARA_ID:160
			TFLAG:98 = 1 ;あぶない
		ELSE
			TFLAG:98 = 0 ;まだ余裕
		ENDIF
	ENDIF
ENDIF

CALL PRINT_MESSAGE(CHARA_ID, 17, TFLAG:99, CALLNAME:CHARA_ID, SAVESTR:ENEMY_ID, CHARA_ID)

IF TFLAG:98 == 2
	;同族堕ち実行
	;味方を消し飛ばす
	CALL MEMBER_EXIT_ID(CHARA_ID)
	CALL ADD_HISTORY(DAY, CHARA_ID,, 16)
	TALENT:CHARA_ID:73 = 104
	CFLAG:CHARA_ID:29 = 1
	CFLAG:CHARA_ID:48 = 0
	CFLAG:CHARA_ID:37 = 0
	BASE:CHARA_ID:3 = 0
	CFLAG:CHARA_ID:2 = 1
	DA:ENEMY_ID:10 = 0
	DA:ENEMY_ID:20 = 0
	IF FLAG:512 == 2
		TALENT:CHARA_ID:122 = 0
	ENDIF
	FLAG:0 -= 1

	;敵を追加
	CALL CREATE_ENEMY(104, FLAG:5, 0, CHARA_ID)
	TFLAG:15 ++
	TFLAG:(TFLAG:15) = FLAG:1 - 1
ENDIF
